<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <title>使用 Serverless 实现日志报警 | Hang Jiang</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="AJAX: XHR, jQuery and Fetch API">
<meta name="generator" content="Hugo 0.82.0" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />






  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>首页</a>
	
	<a href="/posts">归档</a>
	<a href="/tags">标签</a>
	<a href="/about">关于</a>

	

	
	<a class="button" href="https://nodejh.com/index.xml">订阅</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">使用 Serverless 实现日志报警</h1>

    <div class="tip">
        <span>
          Aug 8, 2017 22:24
        </span>
        <span class="split">
          ·
        </span>
        <span>
          
            5330 words
          
        </span>
        <span class="split">
          ·
        </span>
        <span>
          11 minute read
        </span>
    </div>

    <div class="content">
      <p>最近尝试将应用的页面 JS 错误报警功能通过 Serverless 来实现。本文主要介绍一下具体实现过程，以及遇到的一些问题。</p>
<p>报警功能的需求也很简单，就是定时（如每隔 1 分钟）去读取 ARMS 的错误日志，如果有错误日志，则通过钉钉消息发送错误详情进行报警。</p>
<p>在这之前，我通过定时任务实现了该功能。从成本上来说，这种方案就需要单独申请一台服务器资源；而且定时任务只在对应的时间才执行，这件意味着，服务器有很长的时间都是空闲的，这就造成了资源的浪费。而使用 Serverless，就不需要再申请服务器，函数只需要在需要的时候执行，这就大大节省了成本。</p>
<p>总的来说，我觉得函数计算的优势就是：</p>
<ul>
<li>对于开发者，只需要关系业务逻辑的实现，不需要关心代码所运行的环境、硬件资源、以及运维</li>
<li>节省成本</li>
</ul>
<p>通过 Serverless 实现前端日志报警，依赖的云服务是<a 
    href="https://fc.console.aliyun.com"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    阿里云函数计算
</a>，依赖的其他工具还有：</p>
<ul>
<li>函数计算的命令行工具 <a 
    href="https://github.com/aliyun/fun"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    fun
</a>，用于本地调试、部署函数</li>
<li>函数计算的可交互式工具 <a 
    href="https://github.com/aliyun/fcli"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    fcli
</a>，用于本地测试</li>
<li>阿里云 JS SDK <a 
    href="https://github.com/aliyun-UED/aliyun-sdk-js"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    aliyun-sdk-js
</a>，用于读取 SLS 日志，ARMS 的日志是存储在 SLS 中的</li>
<li>编程语言使用 Node.js</li>
</ul>
<h2 id="安装和配置-fun">安装和配置 fun <a href="#%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae-fun" class="anchor">🔗</a></h2><p>初次使用需要先安装 <code>fun</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ npm install @alicloud/fun -g
</code></pre></div><p>安装完成之后，需要通过 <code>fun config</code> 配置一下账号信息 <code>Aliyun Account ID</code> <code>Aliyun Access Key ID</code> <code>Aliyun Secret Access Key</code> 以及默认的地域。地域这里有个需要注意的是，如果需要使用 SLS 记录函数日志，则需要 SLS 和函数服务在同一个地域。这里稍后会详细介绍。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun config
? Aliyun Account ID ******
? Aliyun Access Key ID ******
? Aliyun Secret Access Key ******
? Default region name cn-shanghai
? The timeout in seconds <span style="color:#a2f;font-weight:bold">for</span> each SDK client invoking <span style="color:#666">60</span>
? The maximum number of retries <span style="color:#a2f;font-weight:bold">for</span> each SDK client <span style="color:#666">6</span>
</code></pre></div><p><code>Aliyun Account ID</code> <code>Aliyun Access Key ID</code> <code>Aliyun Secret Access Key</code> 可以在阿里云的控制台中查找和设置。</p>
<p><a 
    href="https://account.console.aliyun.com/#/secure"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    <code>Aliyun Account ID</code>
</a></p>
<p>![Aliyun Account ID]
<p class="markdown-image">
  <img src="./images/serverless-log-alarm-1.jpg" alt="accountid"  />
</p></p>
<p><a 
    href="https://usercenter.console.aliyun.com/#/manage/ak"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    <code>Aliyun Access Key ID</code> <code>Aliyun Secret Access Key</code>
</a></p>
<p><p class="markdown-image">
  <img src="./images/serverless-log-alarm-2.jpg" alt="accesskey"  />
</p></p>
<h2 id="函数初始化">函数初始化 <a href="#%e5%87%bd%e6%95%b0%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor">🔗</a></h2><p>先通过 <code>fun</code> 创建一个 Node.js 的 demo，之后可以在这个 demo 的基础上进行开发。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun init -n alarm helloworld-nodejs8
Start rendering template...
+ /Users/jh/inbox/func/code/alarm
+ /Users/jh/inbox/func/code/alarm/index.js
+ /Users/jh/inbox/func/code/alarm/template.yml
finish rendering template.
</code></pre></div><p>执行成功后，分别创建了两个文件 <code>index.js</code> 和 <code>template.yml</code>。</p>
<p>其中 <code>template.yml</code> 是函数的规范文档，在里面定义了函数需要的资源、触发函数的事件等等。</p>
<h3 id="templateyml">template.yml <a href="#templateyml" class="anchor">🔗</a></h3><p>接下来简单看看生成的默认的 <code>template.yml</code> 配置文件。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#008000;font-weight:bold">ROSTemplateFormatVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;2015-09-01&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Transform</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless-2018-04-03&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Service&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;helloworld&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Function&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Handler</span>:<span style="color:#bbb"> </span>index.handler<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Runtime</span>:<span style="color:#bbb"> </span>nodejs8<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">CodeUri</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;index.js&#39;</span><span style="color:#bbb">
</span></code></pre></div><p>首先定义了规范文档的版本 <code>ROSTemplateFormatVersion</code> 和 <code>Transform</code>，这两个都不用修改。</p>
<p><code>Resources</code> 里面定义了一个名为 <code>alarm</code> 的函数服务（<code>Type: Aliyun::Serverless::Service</code> 表示该属性为函数服务），并且该服务里面定义了名为 <code>alarm</code> 的函数（<code>Type: 'Aliyun::Serverless::Function'</code>表示该属性为函数）。</p>
<p>函数服务里面可以包含多个函数，就相当于是一个函数组。后面我们会提到的函数日志，是配置到函数服务上的。函数服务里面的所有函数，都用同一个日志。</p>
<p>可以根据实际情况修改函数服务名和函数名。下面就将函数服务名称改为 <code>yunzhi</code>，函数名依旧保留为 <code>alarm</code>。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#008000;font-weight:bold">ROSTemplateFormatVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;2015-09-01&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Transform</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless-2018-04-03&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">yunzhi</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数服务的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Service&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 表示 yunzhi 是一个函数服务</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;helloworld&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数服务的描述</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Function&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 表示 alarm 是一个函数</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Handler</span>:<span style="color:#bbb"> </span>index.handler<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数的调用入口</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Runtime</span>:<span style="color:#bbb"> </span>nodejs8<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数的运行环境</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">CodeUri</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;index.js&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 代码的目录</span><span style="color:#bbb">
</span></code></pre></div><p><code>alarm</code> 函数里面的 <code>Properties</code> 定义了函数的调用入口、运行环境等，如上面的注释所示。</p>
<p>关于 <code>template.yml</code> 的配置详见 <a 
    href="https://github.com/aliyun/fun/blob/master/docs/specs/2018-04-03-zh-cn.md"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    Serverless Application Model
</a>。</p>
<h3 id="indexjs">index.js <a href="#indexjs" class="anchor">🔗</a></h3><p><code>index.js</code> 文件就是函数的调用入口了。<code>index.handler</code> 就表示，函数的调用的是 <code>index.[extension]</code> 文件中的 <code>handler</code> 函数。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">module.exports.handler <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">function</span>(event, context, callback) { 
  console.log(<span style="color:#b44">&#39;hello world&#39;</span>);
  callback(<span style="color:#a2f;font-weight:bold">null</span>, <span style="color:#b44">&#39;hello world&#39;</span>); 
};
</code></pre></div><p>初始化之后的代码就上面这几行，很简单。主要是理解上面的几个参数。</p>
<ul>
<li><code>event</code> 调用函数时传入的参数</li>
<li><code>context</code> 函数运行时的一些信息</li>
<li><code>callback</code> 函数执行之后的回调
<ul>
<li>
<ol>
<li>必须要要调用 <code>callback</code> 函数，才会被认为函数执行结束。如果没有调用，则函数会一直运行到超时</li>
</ol>
</li>
<li>
<ol start="2">
<li><code>callback</code> 调用之后，函数就结束了</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>callback</code> 的第一个参数是 <code>error</code> 对象，这和 JS 回调编程的思想一致</li>
</ol>
</li>
</ul>
</li>
</ul>
<p>关于 <code>event</code> 和 <code>context</code>，详见 <a 
    href="https://help.aliyun.com/document_detail/74757.html"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    Nodejs 函数入口
</a>。</p>
<p>实现报警功能的主要逻辑，就写在 <code>index.js</code> 里面。具体的实现，就不细说，下面用伪代码来描述：</p>
<p><code>alarm/alarm.js</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#080;font-style:italic">// alarm/alarm.js 
</span><span style="color:#080;font-style:italic">// 实现报警功能
</span><span style="color:#080;font-style:italic"></span>module.exports <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">function</span>() {
	<span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">new</span> <span style="color:#a2f">Promise</span>((resolve, reject) =&gt; {
		<span style="color:#080;font-style:italic">// 查询 SLS 日志
</span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// - 如果没有错误日志，则 resolve
</span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// - 如果有错误日志，则发送钉钉消息
</span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// 		- 如果钉钉消息发送失败，则 reject
</span><span style="color:#080;font-style:italic"></span>		<span style="color:#080;font-style:italic">// 		- 如果钉钉消息发送成功，则 resolve
</span><span style="color:#080;font-style:italic"></span>		resolve();
	})
}
</code></pre></div><p><code>alarm/index.js</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#080;font-style:italic">// alarm/index.js 
</span><span style="color:#080;font-style:italic">// 调用报警函数
</span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">const</span> alarm <span style="color:#666">=</span> require(<span style="color:#b44">&#39;./alarm&#39;</span>);

module.exports.handler <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">function</span>(event, context, callback) { 
  alarm()
  	.then(() =&gt; {
			callback(<span style="color:#a2f;font-weight:bold">null</span>, <span style="color:#b44">&#39;success&#39;</span>);   
  	})
  	.<span style="color:#a2f;font-weight:bold">catch</span>(error =&gt; {
			callback(error); 
		})
};
</code></pre></div><h4 id="codeuri">CodeUri <a href="#codeuri" class="anchor">🔗</a></h4><p>如果函数里面引入了自定义的其他模块，比如在 <code>index.js</code> 里面引入了 <code>alarm.js</code> <code>const alarm = require('./alarm');</code>，则需要修改默认的 <code>codeUri</code> 为当前代码目录 <code>./</code>。否则默认的 <code>codeUri</code> 只定义了 <code>index.js</code>，部署的时候只会部署 <code>index.js</code>。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#008000;font-weight:bold">ROSTemplateFormatVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;2015-09-01&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Transform</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless-2018-04-03&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">yunzhi</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数服务的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Service&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 表示 yunzhi 是一个函数服务</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;helloworld&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数服务的描述</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Function&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 表示 alarm 是一个函数</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Handler</span>:<span style="color:#bbb"> </span>index.handler<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数的调用入口</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Runtime</span>:<span style="color:#bbb"> </span>nodejs8<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 函数的运行环境</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">CodeUri</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;./&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 代码的目录</span><span style="color:#bbb">
</span></code></pre></div><p>如果没有修改 <code>CodeUri</code>，则会有类似下面的报错</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun <span style="color:#a2f">local</span> invoke alarm
FC Invoke End RequestId: 16e3099e-6a40-43cb-99a0-f0c75f3422c6
<span style="color:#666">{</span>
  <span style="color:#b44">&#34;errorMessage&#34;</span>: <span style="color:#b44">&#34;Cannot find module &#39;./alarm&#39;&#34;</span>,
  <span style="color:#b44">&#34;errorType&#34;</span>: <span style="color:#b44">&#34;Error&#34;</span>,
  <span style="color:#b44">&#34;stackTrace&#34;</span>: <span style="color:#666">[</span>
    <span style="color:#b44">&#34;Error: Cannot find module &#39;./alarm&#39;&#34;</span>,
    <span style="color:#b44">&#34;at Module._resolveFilename (module.js:536:15)&#34;</span>,
    <span style="color:#b44">&#34;at Module._load (module.js:466:25)&#34;</span>,
    <span style="color:#b44">&#34;at Module.require (module.js:579:17)&#34;</span>,
    <span style="color:#b44">&#34;at require (internal/module.js:11:18)&#34;</span>,
    <span style="color:#b44">&#34;at (/code/index.js:9:15)&#34;</span>,
    <span style="color:#b44">&#34;at Module._compile (module.js:635:30)&#34;</span>,
    <span style="color:#b44">&#34;at Module._extensions..js (module.js:646:10)&#34;</span>,
    <span style="color:#b44">&#34;at Module.load (module.js:554:32)&#34;</span>,
    <span style="color:#b44">&#34;at tryModuleLoad (module.js:497:12)&#34;</span>,
    <span style="color:#b44">&#34;at Module._load (module.js:489:3)&#34;</span>
  <span style="color:#666">]</span>
<span style="color:#666">}</span>
</code></pre></div><p><code>fun local invoke alarm</code> 是本地调试的命令，接下来会讲到。</p>
<h2 id="本地调试">本地调试 <a href="#%e6%9c%ac%e5%9c%b0%e8%b0%83%e8%af%95" class="anchor">🔗</a></h2><p>在开发过程中，肯定需要本地调试。<code>fun</code> 提供了 <code>fun local</code> 支持本地调试。</p>
<p><code>fun local</code> 的命令格式为 <code>fun local invoke [options] &lt;[service/]function&gt;</code>，其中 <code>options</code> 和 <code>service</code> 都可以忽略。比如调试上面的报警功能的命令就是 <code>fun local invoke alarm</code>。</p>
<p>需要注意的是，本地调试需要先安装 docker。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ brew cask install docker
</code></pre></div><p>安装成功后启动 docker。</p>
<p>如果 docker 没有启动，运行 <code>fun local</code> 可能会有如下报错</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun <span style="color:#a2f">local</span> invoke alarm
Reading event data from stdin, which can be ended with Enter <span style="color:#a2f;font-weight:bold">then</span> Ctrl+D
<span style="color:#666">(</span>you can also pass it from file with -e<span style="color:#666">)</span>
connect ENOENT /var/run/docker.sock
</code></pre></div><p>正常的输出如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun <span style="color:#a2f">local</span> invoke alarm
Reading event data from stdin, which can be ended with Enter <span style="color:#a2f;font-weight:bold">then</span> Ctrl+D
<span style="color:#666">(</span>you can also pass it from file with -e<span style="color:#666">)</span>
skip pulling image aliyunfc/runtime-nodejs8:1.5.0...
FC Invoke Start RequestId: 9360768c-5c52-4bf5-978b-774edfce9e40
load code <span style="color:#a2f;font-weight:bold">for</span> handler:index.handler
FC Invoke End RequestId: 9360768c-5c52-4bf5-978b-774edfce9e40
success

RequestId: 9360768c-5c52-4bf5-978b-774edfce9e40          Billed Duration: <span style="color:#666">79</span> ms          Memory Size: <span style="color:#666">1998</span> MB    Max Memory Used: <span style="color:#666">54</span> MB
</code></pre></div><p>第一次调试的话，会安装 runtime 的镜像，可能需要点时间。默认的 Docker 镜像下载会很慢，可以使用国内的加速站点加速下载。</p>
<p>出现 <code>Reading event data from stdin, which can be ended with Enter then Ctrl+D</code> 的提示时，如果不需要输入，可以按 <code>ctrl+D</code> 跳过。</p>
<h2 id="函数部署">函数部署 <a href="#%e5%87%bd%e6%95%b0%e9%83%a8%e7%bd%b2" class="anchor">🔗</a></h2><p>开发完成之后，就需要将函数部署到阿里云的函数计算上面了。部署可以通过 <code>fun deploy</code> 命令。</p>
<p>前面已经在安装 <code>fun</code> 之后，通过 <code>fun config</code> 命令配置了阿里云的账号和地域信息，<code>fun deploy</code> 会将函数自动部署到对应的账号和地域下。</p>
<p>在 <code>template.yml</code> 中，也配置了函数的服务名和函数名。如果在函数计算中没有对应的服务或函数，<code>fun deploy</code> 会自动创建；如果已经存在，则会更新。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun deploy
using region: cn-shanghai
using accountId: ***********4698
using accessKeyId: ***********UfpF
using timeout: <span style="color:#666">60</span>

Waiting <span style="color:#a2f;font-weight:bold">for</span> service yunzhi to be deployed...
        Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#a2f;font-weight:bold">function</span> alarm to be deployed...
                Waiting <span style="color:#a2f;font-weight:bold">for</span> packaging <span style="color:#a2f;font-weight:bold">function</span> alarm code...
                package <span style="color:#a2f;font-weight:bold">function</span> alarm code <span style="color:#a2f;font-weight:bold">done</span>
        <span style="color:#a2f;font-weight:bold">function</span> alarm deploy success
service yunzhi deploy success
</code></pre></div><p>部署成功之后，就可以在函数计算的控制台中看到对应的函数服务和函数了。目前还没有配置触发器，可以手动在控制台中点击“执行”按钮来执行函数。</p>
<p><p class="markdown-image">
  <img src="./images/serverless-log-alarm-3.jpg" alt="fcshow2"  />
</p></p>
<h2 id="触发器">触发器 <a href="#%e8%a7%a6%e5%8f%91%e5%99%a8" class="anchor">🔗</a></h2><p>对于应用到生产环境的函数，肯定不会像上面一样手动去执行它，而是通过配置触发器去执行。触发器就相当于是一个特定的事件，当函数计算接收到该事件的时候，就去调用对应的函数。</p>
<p>阿里云的函数计算支持 HTTP 触发器（接收到 HTTP 请求之后调用函数）、定时触发器（定时调用函数）、OSS 触发器等等。详见 <a 
    href="https://help.aliyun.com/document_detail/74707.html"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    触发器列表
</a>。</p>
<p>对于报警功能，需要用到的是定时触发器，因为需要间隔一定的时间就调用函数。</p>
<p>触发器是配置到函数中的，可以通过函数的 <code>Event</code> 属性去配置</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#008000;font-weight:bold">ROSTemplateFormatVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;2015-09-01&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Transform</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless-2018-04-03&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">yunzhi</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Service&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;helloworld&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Function&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Handler</span>:<span style="color:#bbb"> </span>index.handler<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Runtime</span>:<span style="color:#bbb"> </span>nodejs8 <span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">CodeUri</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;./&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Events</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 配置 alarm 函数的触发器</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">TimeTrigger</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 触发器的名称</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span>Timer<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 表示该触发器是定时触发器</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CronExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;0 0/1 * * * *&#34;</span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># 每 1 分钟执行一次</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">Enable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">true</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 是否启用该定时触发器</span><span style="color:#bbb">
</span></code></pre></div><p>上面的配置，就为 <code>alarm</code> 配置了一个名为 <code>TimeTrigger</code> 的定时触发器，触发器每隔 1 分钟执行一次，也就是每隔 1 分钟调用一次函数。</p>
<p>配置完成之后，再执行 <code>fun deploy</code> 就可以发布函数及触发器到函数计算上。</p>
<p><p class="markdown-image">
  <img src="./images/serverless-log-alarm-4.jpg" alt="trigger"  />
</p></p>
<p>这里需要注意的是，阿里云函数计算服务目前支持的触发器，最小的间隔时间为 1 分钟。如果小于 1 分钟，则无法设置成功。定时触发器的详细介绍可参考文档 <a 
    href="https://help.aliyun.com/document_detail/68172.html"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    定时触发函数
</a>。</p>
<h2 id="函数日志">函数日志 <a href="#%e5%87%bd%e6%95%b0%e6%97%a5%e5%bf%97" class="anchor">🔗</a></h2><p>对于 serverless 应用，虽然不用关心运维了，其实我们也并不知道我们的函数运行在哪台服务器上。这个时候，函数的日志就尤为重要了。没有日志，我们很难知道程序运行状态，遇到问题更是无从下手。</p>
<p>所以接下来需要对函数配置日志。阿里云的函数计算可以使用<a 
    href="https://sls.console.aliyun.com/#/"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    阿里云日志服务 SLS
</a>来存储日志。如果要存储日志，则需要先开通 <a 
    href="https://sls.console.aliyun.com/#/"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    日志服务
</a>。</p>
<h3 id="不存在日志库">不存在日志库 <a href="#%e4%b8%8d%e5%ad%98%e5%9c%a8%e6%97%a5%e5%bf%97%e5%ba%93" class="anchor">🔗</a></h3><p>如果是第一次使用日志服务，则肯定不存在日志库。可以在 <code>template.yml</code> 像定义函数服务一样，通过 Resource 来定义日志资源。</p>
<p>前面也提到，函数日志是配置到对应的服务上的，具体配置也很简单，就是通过函数服务的 <code>LogConfig</code> 属性来配置。</p>
<p>完整的 <code>template.yml</code> 如下</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#008000;font-weight:bold">ROSTemplateFormatVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;2015-09-01&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Transform</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless-2018-04-03&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">log-yunzhi</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 日志项目名称为 log-yunzhi</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Log&#39;</span><span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 表示该资源是阿里云的日志服务</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;yunzhi function service log project&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">log-yunzhi-store</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 日志的 logstore</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Log::Logstore&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">TTL</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">ShardCount</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">log-another-logstore</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 日志的另一个 logstore</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Log::Logstore&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">TTL</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">ShardCount</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">yunzhi</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Service&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;helloworld&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">LogConfig</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 配置函数的日志</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Project: &#39;log-yunzhi&#39; # 存储函数日志 SLS 项目</span>:<span style="color:#bbb"> </span>log-yunzhi<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Logstore: &#39;log-yunzhi-store&#39; # 存储函数日志的 SLS logstore</span>:<span style="color:#bbb"> </span>log-yunzhi-store<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Function&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Handler</span>:<span style="color:#bbb"> </span>index.handler <span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Runtime</span>:<span style="color:#bbb"> </span>nodejs8 <span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">CodeUri</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;./&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Events</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">TimeTrigger</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span>Timer <span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CronExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;0 0/1 * * * *&#34;</span><span style="color:#bbb">  
</span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">Enable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">true</span><span style="color:#bbb"> 
</span><span style="color:#bbb">
</span></code></pre></div><p>在上面的配置中，就定义了名为 <code>log-yunzhi</code> 的日志项目（Project），并且在该 Project 中创建了两个日志仓库（LogStore）：<code>log-yunzhi-store</code> 和 <code>log-yunzhi-store</code>。一个 Project 可以包含多个 LogStore。</p>
<p><strong>注意：日志项目的名称必须全局唯一</strong>。 即配置中，<code>og-yunzhi</code> 这个项目名称是全局唯一的。</p>
<p>执行 <code>fun deploy</code> 之后，就会自动在函数服务对应的地域创建日志 Project 及日志 logstore，同时也会自动为 logstore 加上全文索引，然后自动为函数服务配置日志仓库。</p>
<p>之后函数的运行日志都会存储在对应的 logstore 里。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun deploy
using region: cn-shanghai
using accountId: ***********4698
using accessKeyId: ***********UfpF
using timeout: <span style="color:#666">60</span>

Waiting <span style="color:#a2f;font-weight:bold">for</span> log service project log-yunzhi to be deployed...
        Waiting <span style="color:#a2f;font-weight:bold">for</span> log service logstore log-yunzhi-store to be deployed...
                retry <span style="color:#666">1</span> <span style="color:#a2f">times</span>
                Waiting <span style="color:#a2f;font-weight:bold">for</span> log service logstore log-yunzhi-store default index to be deployed...
                log service logstore log-yunzhi-store default index deploy success
        log serivce logstore log-yunzhi-store deploy success
        Waiting <span style="color:#a2f;font-weight:bold">for</span> log service logstore log-another-logstore to be deployed...
                Waiting <span style="color:#a2f;font-weight:bold">for</span> log service logstore log-another-logstore default index to be deployed...
                log service logstore log-another-logstore default index deploy success
        log serivce logstore log-another-logstore deploy success
log serivce project log-yunzhi deploy success

Waiting <span style="color:#a2f;font-weight:bold">for</span> service yunzhi to be deployed...
        Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#a2f;font-weight:bold">function</span> alarm to be deployed...
                Waiting <span style="color:#a2f;font-weight:bold">for</span> packaging <span style="color:#a2f;font-weight:bold">function</span> alarm code...
                package <span style="color:#a2f;font-weight:bold">function</span> alarm code <span style="color:#a2f;font-weight:bold">done</span>
                Waiting <span style="color:#a2f;font-weight:bold">for</span> Timer trigger TimeTrigger to be deployed...
                <span style="color:#a2f;font-weight:bold">function</span> TimeTrigger deploy success
        <span style="color:#a2f;font-weight:bold">function</span> alarm deploy success
service yunzhi deploy success
</code></pre></div><p><p class="markdown-image">
  <img src="./images/serverless-log-alarm-5.jpg" alt="slslog"  />
</p></p>
<p>如果日志库已经存在，且定义了日志资源，则 <code>fun deploy</code> 会按照 <code>template.yml</code> 中的配置更新日志库。</p>
<h3 id="存在日志库">存在日志库 <a href="#%e5%ad%98%e5%9c%a8%e6%97%a5%e5%bf%97%e5%ba%93" class="anchor">🔗</a></h3><p>如果日志库已经存在，即已经在日志服务中创建了日志项目 Project 和日志库 Logstore ，就可以直接为函数服务添加 LogConfig，不用再定义日志资源。</p>
<p><strong>注意，日志库需要和函数服务在同一个地域 Region。否则不能部署成功。</strong></p>
<p>下面是一个配置函数日志到已经存在的 Project 和 Logstore 中的例子。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#008000;font-weight:bold">ROSTemplateFormatVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;2015-09-01&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Transform</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless-2018-04-03&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">Resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">yunzhi</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Service&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Description</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;helloworld&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">LogConfig</span>:<span style="color:#bbb"> </span><span style="color:#080;font-style:italic"># 配置函数的日志</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Project: &#39;log-yunzhi-exist&#39; # 存储函数日志到已经存在的 Project</span>:<span style="color:#bbb"> </span>log-yunzhi-exist<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Logstore: &#39;logstore-exist&#39; # 存储函数日志到已经存在的 logstore</span>:<span style="color:#bbb"> </span>logstore-exist<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">alarm</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;Aliyun::Serverless::Function&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Handler</span>:<span style="color:#bbb"> </span>index.handler <span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">Runtime</span>:<span style="color:#bbb"> </span>nodejs8 <span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">CodeUri</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;./&#39;</span><span style="color:#bbb"> 
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">Events</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">TimeTrigger</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">Type</span>:<span style="color:#bbb"> </span>Timer <span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">Properties</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">CronExpression</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;0 0/1 * * * *&#34;</span><span style="color:#bbb">  
</span><span style="color:#bbb">            </span><span style="color:#008000;font-weight:bold">Enable</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">true</span><span style="color:#bbb"> 
</span><span style="color:#bbb">
</span></code></pre></div><p>如果日志库和函数服务不在同一个地域，函数服务就会找不到日志库，<code>fun deploy</code> 也会报错。如下所示，<code>yunzhi-log-qingdao</code> 是我创建的一个青岛地域的日志 Project。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ fun deploy
using region: cn-shanghai
using accountId: ***********4698
using accessKeyId: ***********UfpF
using timeout: <span style="color:#666">60</span>

Waiting <span style="color:#a2f;font-weight:bold">for</span> service yunzhi to be deployed...
        retry <span style="color:#666">1</span> <span style="color:#a2f">times</span>
        retry <span style="color:#666">2</span> <span style="color:#a2f">times</span>
        retry <span style="color:#666">3</span> <span style="color:#a2f">times</span>
        retry <span style="color:#666">4</span> <span style="color:#a2f">times</span>
        retry <span style="color:#666">5</span> <span style="color:#a2f">times</span>
        retry <span style="color:#666">6</span> <span style="color:#a2f">times</span>
        retry <span style="color:#666">7</span> <span style="color:#a2f">times</span>
PUT /services/yunzhi failed with 400. requestid: 6af2afb8-cbd9-0d3e-bf16-fe623834b4ee, message: project <span style="color:#b44">&#39;yunzhi-log-qingdao&#39;</span> does not exist.
</code></pre></div><h2 id="其他问题">其他问题 <a href="#%e5%85%b6%e4%bb%96%e9%97%ae%e9%a2%98" class="anchor">🔗</a></h2><h3 id="代码版本的管理">代码版本的管理 <a href="#%e4%bb%a3%e7%a0%81%e7%89%88%e6%9c%ac%e7%9a%84%e7%ae%a1%e7%90%86" class="anchor">🔗</a></h3><p>在实现报警功能的过程中，我依旧使用了 GitLab 来存储代码。每次开发完成之后，将代码 push 到 GitLab，然后再将代码部署到函数计算上。不过这两个过程是独立的，还是不那么方便。</p>
<h3 id="环境问题">环境问题 <a href="#%e7%8e%af%e5%a2%83%e9%97%ae%e9%a2%98" class="anchor">🔗</a></h3><p>一般我们开发的时候，需要日常、预发、线上多个环境部署、测试。阿里云函数计算是一个云产品，没有环境的区分。但对于报警整个功能，我也没有去区分环境，只是本地开发的时候，将报警消息发到一个测试的钉钉群，所以也没有特别去关注。</p>
<h3 id="经济成本">经济成本 <a href="#%e7%bb%8f%e6%b5%8e%e6%88%90%e6%9c%ac" class="anchor">🔗</a></h3><p>使用函数计算的经济成本，相比于购买云服务器部署应用，成本低了非常多。</p>
<p>本文中涉及到函数计算和日志服务两个云产品，都有一定的免费额度。其中函数计算每月前 100 万次函数调用免费，日志服务每月也有 500M 的免费存储空间和读写流量。所以只用来测试或者实现一些调用量很小的功能，基本是免费的。</p>
<ul>
<li><a 
    href="https://help.aliyun.com/document_detail/54301"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    函数计算计费方式
</a></li>
<li><a 
    href="https://help.aliyun.com/document_detail/48220.html"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    日志服务产品定价
</a></li>
</ul>
<h2 id="总结">总结 <a href="#%e6%80%bb%e7%bb%93" class="anchor">🔗</a></h2><p>配置了函数的日志之后，将函数部署到函数计算上，就算是正式发布上线了。</p>
<p>现在回过头来看，整个流程还算比较简单。但从零开始一步一步到部署上线的过程，还是遇到了很多问题。比如文中的许多注意事项，都是在不断尝试中得出的结论。</p>
<p>最近 serverless 这个话题也很火热，也期待这个技术即将带来的变革。</p>

    </div>

    
        <div class="tags">
            
                <a href="https://nodejh.com/tags/serverless">Serverless</a>
            
        </div>
    
    
    <div id="comment">
  
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nodejh" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/nodejh" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://stackoverflow.com/users/4518882/nodejh" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>stackoverflow</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-488.000000, -1163.000000)">
            <g id="stackoverflow" transform="translate(488.000000, 1163.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M42.0860128,53.5922927 L22.9745951,53.6011499 L22.9729497,49.5538824 L42.0835447,49.5440929 L42.0860128,53.5922927 L42.0860128,53.5922927 Z M55,30.6708298 L51.7306912,12 L47.7087256,12.6920259 L50.9775643,31.3628557 L55,30.6708298 L55,30.6708298 Z M42.5455518,44.3547147 L23.5156994,42.616026 L23.1410164,46.6470941 L42.1712214,48.3841513 L42.5455518,44.3547147 L42.5455518,44.3547147 Z M43.8009984,39.0731519 L25.3459811,34.1539179 L24.285633,38.0621508 L42.7419431,42.9819676 L43.8009984,39.0731519 L43.8009984,39.0731519 Z M46.2103463,34.4436411 L29.7494464,24.8164635 L27.6748215,28.3015328 L44.1365441,37.9292931 L46.2103463,34.4436411 L46.2103463,34.4436411 Z M50.2466504,31.6088756 L46.8745036,33.8883189 L36.106599,18.2318456 L39.4792159,15.9517031 L50.2466504,31.6088756 Z M45.3315807,40.2784283 L48.5799693,40.2784283 L48.5799693,60 L17,60 L17,40.2784283 L20.2648427,40.2784283 L20.2648427,56.8243495 L45.3315807,56.8243495 L45.3315807,40.2784283 Z" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/nodejh" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <p class="copyright">
    
       © Copyright 
       2021 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Hang Jiang
    
    </p>
    <p class="powerby">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

  </body>
</html>
