<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <title>Druid è·å–è¿æ¥å¼‚å¸¸å¯¼è‡´åº”ç”¨æŒ‚èµ·åŸå› åˆ†æ | Hang Jiang</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="1. èƒŒæ™¯ ğŸ”—1.1 ç°è±¡ ğŸ”—2021.12.16 å‡Œæ™¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨æ•°æ®åº“å› æ•…å‘ç”Ÿäº†ä¸»å¤‡åˆ‡æ¢ï¼Œä¹‹åæŸä¸ª Pod å°±æŒç»­æŠ¥é”™ GetConnectionTimeou">
<meta name="generator" content="Hugo 0.82.0" />


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84989670-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>é¦–é¡µ</a>
	
	<a href="/posts">å½’æ¡£</a>
	<a href="/tags">æ ‡ç­¾</a>
	<a href="/about">å…³äº</a>

	

	
	  <a class="button" href="https://nodejh.com/index.xml">è®¢é˜…</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Druid è·å–è¿æ¥å¼‚å¸¸å¯¼è‡´åº”ç”¨æŒ‚èµ·åŸå› åˆ†æ</h1>

    <div class="tip">
        <time datetime="2021-12-20 19:53:13 &#43;0800 CST">2021å¹´12æœˆ20æ—¥</time>
        <span class="split">
          Â·
        </span>
        <span>
          8377å­—
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          17åˆ†é’Ÿ
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#1-èƒŒæ™¯">1. èƒŒæ™¯</a>
      <ul>
        <li><a href="#11-ç°è±¡">1.1 ç°è±¡</a></li>
        <li><a href="#12-æŠ¥é”™ä¿¡æ¯">1.2 æŠ¥é”™ä¿¡æ¯</a></li>
        <li><a href="#213-druid-é…ç½®">2.1.3 Druid é…ç½®</a></li>
      </ul>
    </li>
    <li><a href="#2-å…³é”®å˜é‡">2. å…³é”®å˜é‡</a>
      <ul>
        <li><a href="#21-é…ç½®é¡¹">2.1 é…ç½®é¡¹</a></li>
        <li><a href="#22-druiddatasource">2.2 DruidDataSource</a></li>
        <li><a href="#23-druidconnectionholder">2.3 DruidConnectionHolder</a></li>
      </ul>
    </li>
    <li><a href="#2-æºç åˆ†æ">2. æºç åˆ†æ</a>
      <ul>
        <li><a href="#221-å¼‚å¸¸æ˜¯å¦‚ä½•æŠ›å‡ºçš„">2.2.1 å¼‚å¸¸æ˜¯å¦‚ä½•æŠ›å‡ºçš„ï¼Ÿ</a></li>
        <li><a href="#22-è¿æ¥æ˜¯å¦‚ä½•åˆ›å»ºçš„">2.2 è¿æ¥æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ</a></li>
        <li><a href="#23-è¿æ¥æ˜¯å¦‚ä½•é‡Šæ”¾çš„">2.3 è¿æ¥æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Ÿ</a></li>
      </ul>
    </li>
    <li><a href="#3-é—®é¢˜å¤ç°">3. é—®é¢˜å¤ç°</a>
      <ul>
        <li><a href="#31-å¤ç°ä»£ç ">3.1 å¤ç°ä»£ç </a></li>
        <li><a href="#32-æ—¶é—´çº¿">3.2 æ—¶é—´çº¿</a></li>
        <li><a href="#heading"></a></li>
        <li><a href="#33-å°ç»“">3.3 å°ç»“</a></li>
      </ul>
    </li>
    <li><a href="#4-é—®é¢˜ä¿®å¤">4. é—®é¢˜ä¿®å¤</a></li>
    <li><a href="#5-æ€»ç»“">5. æ€»ç»“</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h2 id="1-èƒŒæ™¯">1. èƒŒæ™¯ <a href="#1-%e8%83%8c%e6%99%af" class="anchor">ğŸ”—</a></h2><h3 id="11-ç°è±¡">1.1 ç°è±¡ <a href="#11-%e7%8e%b0%e8%b1%a1" class="anchor">ğŸ”—</a></h3><p>2021.12.16 å‡Œæ™¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨æ•°æ®åº“å› æ•…å‘ç”Ÿäº†ä¸»å¤‡åˆ‡æ¢ï¼Œä¹‹åæŸä¸ª Pod å°±æŒç»­æŠ¥é”™ <code>GetConnectionTimeoutException</code>ï¼Œå¹¶ä¸”è¯¥ Pod çš„è¿›ç¨‹ä¸€ç›´æŒ‚èµ·ï¼Œæ— æ³•æ­£å¸¸æä¾›æœåŠ¡ã€‚</p>
<p>ä¸è¿‡æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œå½“æ—¶è¿æ¥åŒä¸€æ•°æ®åº“çš„å…¶ä»– Pod è™½ç„¶ä¹Ÿæœ‰å‡ æ¡æŠ¥é”™ï¼ˆä¸»è¦æ˜¯æ•°æ®åº“è¿æ¥è¶…æ—¶çš„æŠ¥é”™ï¼‰ï¼Œä½†å¾ˆå¿«å…¶ä»– Pod éƒ½æ¢å¤äº†æ­£å¸¸ï¼Œå°±åªæœ‰è¿™ä¸€ä¸ª Pod ä¸€ç›´æ²¡æœ‰æ¢å¤ã€‚</p>
<h3 id="12-æŠ¥é”™ä¿¡æ¯">1.2 æŠ¥é”™ä¿¡æ¯ <a href="#12-%e6%8a%a5%e9%94%99%e4%bf%a1%e6%81%af" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>å¼‚å¸¸ Pod çš„éƒ¨åˆ†æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">[</span>2021-12-16 02:10:06.617<span style="color:#666">]</span> <span style="color:#666">[</span>ERROR<span style="color:#666">]</span> <span style="color:#666">[</span>thread-30849<span style="color:#666">]</span> com.alibaba.druid.pool.DruidPooledStatement errorCheck:367 - CommunicationsException, druid version 1.2.5, jdbcUrl : jdbc:mysql://xxx:3306/xxx?useUnicode<span style="color:#666">=</span>true&amp;<span style="color:#b8860b">characterEncoding</span><span style="color:#666">=</span>UTF-8&amp;<span style="color:#b8860b">allowMultiQueries</span><span style="color:#666">=</span>true, testWhileIdle true, idle millis 1785, minIdle 5, poolingCount 0, timeBetweenEvictionRunsMillis 300000, lastValidIdleMillis 1785, driver com.mysql.cj.jdbc.Driver, exceptionSorter com.alibaba.druid.pool.vendor.MySqlExceptionSorter
 
 ......
 
2021-12-16 02:10:06.617<span style="color:#666">]</span> <span style="color:#666">[</span>ERROR<span style="color:#666">]</span> thread-30849<span style="color:#666">]</span> Caused by: com.alibaba.druid.pool.GetConnectionTimeoutException: <span style="color:#a2f">wait</span> millis 100000, active 399, maxActive 100, creating <span style="color:#666">0</span>
	at com.alibaba.druid.pool.DruidDataSource.getConnectionInternal<span style="color:#666">(</span>DruidDataSource.java:1745<span style="color:#666">)</span>
	at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect<span style="color:#666">(</span>DruidDataSource.java:1415<span style="color:#666">)</span>
	at com.alibaba.druid.pool.DruidDataSource.getConnection<span style="color:#666">(</span>DruidDataSource.java:1395<span style="color:#666">)</span>
	at com.alibaba.druid.pool.DruidDataSource.getConnection<span style="color:#666">(</span>DruidDataSource.java:1385<span style="color:#666">)</span>
	at com.alibaba.druid.pool.DruidDataSource.getConnection<span style="color:#666">(</span>DruidDataSource.java:100<span style="color:#666">)</span>
	at org.springframework.jdbc.datasource.DataSourceUtils.fetchConnection<span style="color:#666">(</span>DataSourceUtils.java:158<span style="color:#666">)</span>
	at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection<span style="color:#666">(</span>DataSourceUtils.java:116<span style="color:#666">)</span>
	at org.springframework.orm.ibatis.SqlMapClientTemplate.execute<span style="color:#666">(</span>SqlMapClientTemplate.java:182<span style="color:#666">)</span>
	... <span style="color:#666">26</span> common frames omitted
</code></pre></div><p>â€‹</p>
<p>ä»æŠ¥é”™ä¿¡æ¯æ¥çœ‹ï¼Œ GetConnectionTimeoutException å³è·å–è¿æ¥è¶…æ—¶ã€‚ä½†æ•°æ®åº“å’Œç½‘ç»œéƒ½æ˜¯æ­£å¸¸çš„ï¼Œä¸ºä»€ä¹ˆè·å–æ•°æ®åº“è¿æ¥è¶…æ—¶å‘¢ï¼Ÿ
â€‹</p>
<p>æ­¤å¤–é”™è¯¯æ ˆä¸­çš„ <code>active</code> å±…ç„¶æ¯” <code>maxActive</code> å¤§ï¼Œæœ€å¤§è¿æ¥æ•° <code>maxActive</code> æ˜¯ 100ï¼Œä¸ºä»€ä¹ˆæ´»è·ƒè¿æ¥æ•°èƒ½è¾¾åˆ° 399ï¼Ÿ
â€‹</p>
<p>åœ¨ Druid çš„ issues ä¸­ï¼Œ <code>GetConnectionTimeoutException</code> ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„é—®é¢˜ï¼Œé‚£è¿™ä¸ªå¼‚å¸¸åˆ°åº•æ˜¯æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Œåˆè¯¥å¦‚ä½•é¿å…å‘¢ï¼Ÿ
â€‹</p>
<p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬å¸¦ç€è¿™äº›ç–‘é—®ï¼Œé€šè¿‡é˜…è¯» Druid æºç è¿›è¡Œæ·±å…¥çš„åˆ†æã€‚</p>
<h3 id="213-druid-é…ç½®">2.1.3 Druid é…ç½® <a href="#213-druid-%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h3><p>åœ¨è¿›è¡Œé—®é¢˜åˆ†æå‰ï¼Œå…ˆçœ‹ä¸€ä¸‹å½“å‰çš„ Druid é…ç½®ã€‚Druid çš„ç‰ˆæœ¬ä¸º 1.2.5ï¼Œå› æ­¤åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘éƒ½å°†æ ¹æ® 1.2.5 ç‰ˆæœ¬çš„æºç è¿›è¡Œåˆ†æã€‚Druid çš„å…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#008000;font-weight:bold">&lt;bean</span> <span style="color:#b44">id=</span><span style="color:#b44">&#34;dataSource&#34;</span> <span style="color:#b44">class=</span><span style="color:#b44">&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span> <span style="color:#b44">init-method=</span><span style="color:#b44">&#34;init&#34;</span> <span style="color:#b44">destroy-method=</span><span style="color:#b44">&#34;close&#34;</span><span style="color:#008000;font-weight:bold">&gt;</span> 
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;url&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;${jdbc_url}&#34;</span> <span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;username&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;${jdbc_user}&#34;</span> <span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;password&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;${jdbc_password}&#34;</span> <span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;maxActive&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;100&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;initialSize&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;1&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;maxWait&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;100000&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;minIdle&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;1&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;timeBetweenEvictionRunsMillis&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;300000&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;validationQuery&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;SELECT 1&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;testWhileIdle&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;true&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;removeAbandoned&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;false&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;property</span> <span style="color:#b44">name=</span><span style="color:#b44">&#34;removeAbandonedTimeout&#34;</span> <span style="color:#b44">value=</span><span style="color:#b44">&#34;600&#34;</span><span style="color:#008000;font-weight:bold">/&gt;</span>
<span style="color:#008000;font-weight:bold">&lt;/bean&gt;</span>
</code></pre></div><h2 id="2-å…³é”®å˜é‡">2. å…³é”®å˜é‡ <a href="#2-%e5%85%b3%e9%94%ae%e5%8f%98%e9%87%8f" class="anchor">ğŸ”—</a></h2><p>åœ¨é”™è¯¯æ ˆä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† <code>pollingCount</code> ã€<code>active</code> ã€<code>maxActive</code> ç­‰å˜é‡ï¼Œé‚£è¿™äº›å˜é‡åˆ°åº•æ˜¯ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿ
â€‹</p>
<p>è¿™ä¸€ç« èŠ‚å°±å…ˆæ¥äº†è§£ä¸€ä¸‹ã€‚åŒæ—¶äº†è§£äº†è¿™äº›å˜é‡çš„å«ä¹‰ï¼Œä¹Ÿæ›´åˆ©äºåç»­é˜…è¯»æºç åˆ†æé—®é¢˜ã€‚
â€‹</p>
<h3 id="21-é…ç½®é¡¹">2.1 é…ç½®é¡¹ <a href="#21-%e9%85%8d%e7%bd%ae%e9%a1%b9" class="anchor">ğŸ”—</a></h3><p>è¿™é‡Œåˆ—å‡ºä¸€äº›æœ¬æ–‡ä¼šæ¶‰çš„åŠå…³é”®é…ç½®ï¼Œæ›´å¤šé…ç½®å¯å‚è€ƒ <a href="https://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8" target="_blank" rel="noopener">DruidDataSourceé…ç½®å±æ€§åˆ—è¡¨</a> ã€‚</p>
<h4 id="211-minidle">2.1.1 minIdle <a href="#211-minidle" class="anchor">ğŸ”—</a></h4><p>è¿æ¥æ± ä¸­è‡³å°‘éœ€è¦ä¿æŒçš„è¿æ¥æ•°ã€‚
â€‹</p>
<h4 id="212-maxactive">2.1.2 maxActive <a href="#212-maxactive" class="anchor">ğŸ”—</a></h4><p>è¿æ¥æ± ä¸­æœ€å¤§è¿æ¥æ•°ã€‚
â€‹</p>
<h4 id="213-maxwait">2.1.3 maxWait <a href="#213-maxwait" class="anchor">ğŸ”—</a></h4><p>â€‹</p>
<p>å•æ¬¡è·å–è¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´ã€‚</p>
<h3 id="22-druiddatasource">2.2 DruidDataSource <a href="#22-druiddatasource" class="anchor">ğŸ”—</a></h3><p>DruidDataSource æ˜¯æ•°æ®æºï¼Œæ¯ä¸ªæ•°æ®æºéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ DruidDataSource å®ä¾‹ã€‚
â€‹</p>
<h4 id="221-activecount">2.2.1 activeCount <a href="#221-activecount" class="anchor">ğŸ”—</a></h4><p>å½“å‰æ´»è·ƒè¿æ¥æ•°ã€‚æ¯å½“æˆåŠŸè·å–åˆ°ä¸€ä¸ªè¿æ¥åï¼ŒactiveCount éƒ½ä¼šåŠ ä¸€ï¼ŒåŒæ—¶ä¹Ÿä¼šå°† <code>holder</code> çš„ <code>active</code> å±æ€§è®¾ç½®ä¸º trueã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> DruidPooledConnection <span style="color:#00a000">getConnectionInternal</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> maxWait<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>holder <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>holder<span style="color:#666">.</span><span style="color:#b44">discard</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        activeCount<span style="color:#666">++;</span>
        holder<span style="color:#666">.</span><span style="color:#b44">active</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<h4 id="222-connections">2.2.2 connections <a href="#222-connections" class="anchor">ğŸ”—</a></h4><p> 
å½“å‰æ‰€æ•°æ®æºæ‹¥æœ‰çš„è¿æ¥æ± ã€‚å…¶ç±»å‹æ˜¯ <code>DruidConnectionHolder[]</code> ã€‚</p>
<h4 id="223-poolingcount">2.2.3 poolingCount <a href="#223-poolingcount" class="anchor">ğŸ”—</a></h4><p> 
è¿æ¥æ± ä¸­çš„çš„è¿æ¥æ•°ã€‚
â€‹</p>
<p>æ¯å½“æ”¾å…¥è¿æ¥åˆ°è¿æ¥æ± ä¸­ï¼Œå°±ä¼šå°† poolingCount åŠ ä¸€ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">put</span><span style="color:#666">(</span>DruidConnectionHolder holder<span style="color:#666">,</span> <span style="color:#0b0;font-weight:bold">long</span> createTaskId<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    connections<span style="color:#666">[</span>poolingCount<span style="color:#666">]</span> <span style="color:#666">=</span> holder<span style="color:#666">;</span>
    incrementPoolingCount<span style="color:#666">();</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span><span style="color:#666">}</span>

<span style="color:#a2f;font-weight:bold">private</span> <span style="color:#a2f;font-weight:bold">final</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">incrementPoolingCount</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    poolingCount<span style="color:#666">++;</span>
<span style="color:#666">}</span>
</code></pre></div><p>æ¯å½“å°†è¿æ¥ä»è¿æ¥æ± ä¸­å–å‡ºï¼Œå°±ä¼šå°† poolingCount å‡ä¸€ï¼Œä¾‹å¦‚ï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> DruidConnectionHolder <span style="color:#00a000">pollLast</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> nanos<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> InterruptedException<span style="color:#666">,</span> SQLException <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    decrementPoolingCount<span style="color:#666">();</span>
    DruidConnectionHolder last <span style="color:#666">=</span> connections<span style="color:#666">[</span>poolingCount<span style="color:#666">];</span>
    connections<span style="color:#666">[</span>poolingCount<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">return</span> last<span style="color:#666">;</span>
<span style="color:#666">}</span>

<span style="color:#a2f;font-weight:bold">private</span> <span style="color:#a2f;font-weight:bold">final</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">decrementPoolingCount</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    poolingCount<span style="color:#666">--;</span>
<span style="color:#666">}</span>


</code></pre></div><h3 id="23-druidconnectionholder">2.3 DruidConnectionHolder <a href="#23-druidconnectionholder" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>æ•°æ®åº“è¿æ¥ä»¥åŠç›¸å…³å±æ€§ã€‚
â€‹</p>
<h4 id="231-conn">2.3.1 conn <a href="#231-conn" class="anchor">ğŸ”—</a></h4><p>æ•°æ®åº“è¿æ¥ï¼Œç±»å‹ä¸º Connectionã€‚
â€‹</p>
<h4 id="232-active">2.3.2 active <a href="#232-active" class="anchor">ğŸ”—</a></h4><p>ç”¨æ¥æ ‡è®°è¿æ¥æ˜¯å¦æ´»è·ƒã€‚</p>
<h4 id="233-lastactivetimemillis">2.3.3 lastActiveTimeMillis <a href="#233-lastactivetimemillis" class="anchor">ğŸ”—</a></h4><p> 
è¿æ¥ä¸Šæ¬¡æ´»è·ƒæ—¶é—´ã€‚
â€‹</p>
<h4 id="234-lastkeeptimemillis">2.3.4 lastKeepTimeMillis <a href="#234-lastkeeptimemillis" class="anchor">ğŸ”—</a></h4><p>è¿æ¥ä¸Šæ¬¡ä¿æŒæ´»è·ƒçš„æ—¶é—´ã€‚æ¯æ¬¡é€šè¿‡ keepAlive ä¿æŒè¿æ¥æ´»è·ƒï¼Œå°±ä¼šæ›´æ–°æ­¤æ—¶é—´ã€‚
â€‹</p>
<h2 id="2-æºç åˆ†æ">2. æºç åˆ†æ <a href="#2-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" class="anchor">ğŸ”—</a></h2><p>æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬ä»é”™è¯¯æ ˆå¼€å§‹æ·±å…¥æºç ï¼Œä¸€å±‚ä¸€å±‚å¯»æ‰¾é—®é¢˜çš„æ ¹æºã€‚</p>
<h3 id="221-å¼‚å¸¸æ˜¯å¦‚ä½•æŠ›å‡ºçš„">2.2.1 å¼‚å¸¸æ˜¯å¦‚ä½•æŠ›å‡ºçš„ï¼Ÿ <a href="#221-%e5%bc%82%e5%b8%b8%e6%98%af%e5%a6%82%e4%bd%95%e6%8a%9b%e5%87%ba%e7%9a%84" class="anchor">ğŸ”—</a></h3><p>é¦–å…ˆ <code>GetConnectionTimeoutException</code> æ˜¯ç”± <code>getConnectionInternal</code> æ–¹æ³•æŠ›å‡ºçš„ï¼Œè¯¥æ–¹æ³•çš„ä¸»è¦ä½œç”¨å°±æ˜¯è·å–æ•°æ®åº“è¿æ¥ï¼Œå½“å‰æ²¡æœ‰è·å–åˆ°è¿æ¥ä¹Ÿå°±æ˜¯ <code>holder</code> ä¸º <code>null</code> çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ŒåŒæ—¶æ‰“å°å‡ºå½“å‰ Â <code>active</code> å’Œ <code>maxActive</code> çš„å€¼ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>holder <span style="color:#666">==</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
  <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>  StringBuilder buf <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StringBuilder<span style="color:#666">(</span>128<span style="color:#666">);</span>
  buf<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span><span style="color:#b44">&#34;wait millis &#34;</span><span style="color:#666">)</span><span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span>waitNanos <span style="color:#666">/</span> <span style="color:#666">(</span>1000 <span style="color:#666">*</span> 1000<span style="color:#666">))</span><span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span><span style="color:#b44">&#34;, active &#34;</span><span style="color:#666">).</span><span style="color:#b44">append</span><span style="color:#666">(</span>activeCount<span style="color:#666">)</span><span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span><span style="color:#b44">&#34;, maxActive &#34;</span><span style="color:#666">).</span><span style="color:#b44">append</span><span style="color:#666">(</span>maxActive<span style="color:#666">)</span><span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span><span style="color:#b44">&#34;, creating &#34;</span><span style="color:#666">).</span><span style="color:#b44">append</span><span style="color:#666">(</span>creatingCount<span style="color:#666">)</span><span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#666">;</span>

  <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>  String errorMessage <span style="color:#666">=</span> buf<span style="color:#666">.</span><span style="color:#b44">toString</span><span style="color:#666">();</span>

  <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">createError</span> <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> GetConnectionTimeoutException<span style="color:#666">(</span>errorMessage<span style="color:#666">,</span> createError<span style="color:#666">);</span>
  <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> GetConnectionTimeoutException<span style="color:#666">(</span>errorMessage<span style="color:#666">);</span>
  <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p><code>holder</code> æ˜¯ <code>DruidConnectionHolder</code> çš„å®ä¾‹ã€‚é‚£ä¸ºä»€ä¹ˆ <code>holder</code> ä¸º <code>null</code> å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ <code>holder</code> æ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚</p>
<h3 id="22-è¿æ¥æ˜¯å¦‚ä½•åˆ›å»ºçš„">2.2 è¿æ¥æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ <a href="#22-%e8%bf%9e%e6%8e%a5%e6%98%af%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e7%9a%84" class="anchor">ğŸ”—</a></h3><p>æ¥ä¸‹æ¥å°±çœ‹ Â <code>holder</code> æ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚
â€‹</p>
<p>åœ¨ <code>getConnectionInternal</code> ä¸­ï¼ŒÂ <code>holder</code> çš„åˆ›å»ºæ˜¯åœ¨ for å¾ªç¯ä¸­è¿›è¡Œçš„ï¼Œä¸€æ—¦åˆ›å»ºæˆåŠŸåˆ™é€€å‡ºå¾ªç¯ã€‚
â€‹</p>
<p>åœ¨åˆ›å»º <code>holder</code> æ—¶ï¼Œæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ã€‚
â€‹</p>
<h4 id="221-åŒæ­¥åˆ›å»ºè¿æ¥">2.2.1 åŒæ­¥åˆ›å»ºè¿æ¥ <a href="#221-%e5%90%8c%e6%ad%a5%e5%88%9b%e5%bb%ba%e8%bf%9e%e6%8e%a5" class="anchor">ğŸ”—</a></h4><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>createScheduler <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span>
    <span style="color:#666">&amp;&amp;</span> poolingCount <span style="color:#666">==</span> 0
    <span style="color:#666">&amp;&amp;</span> activeCount <span style="color:#666">&lt;</span> maxActive
		<span style="color:#666">&amp;&amp;</span> creatingCountUpdater<span style="color:#666">.</span><span style="color:#b44">get</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">)</span> <span style="color:#666">==</span> 0
    <span style="color:#666">&amp;&amp;</span> createScheduler <span style="color:#a2f;font-weight:bold">instanceof</span> ScheduledThreadPoolExecutor<span style="color:#666">)</span> <span style="color:#666">{</span>
  ScheduledThreadPoolExecutor executor <span style="color:#666">=</span> <span style="color:#666">(</span>ScheduledThreadPoolExecutor<span style="color:#666">)</span> createScheduler<span style="color:#666">;</span>
  <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>executor<span style="color:#666">.</span><span style="color:#b44">getQueue</span><span style="color:#666">().</span><span style="color:#b44">size</span><span style="color:#666">()</span> <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
    createDirect <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
  <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p>å¦‚æœéœ€è¦åŒæ­¥åˆ›å»ºè¿æ¥ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>ä¸é…ç½®åˆ›å»ºè¿æ¥çš„çº¿ç¨‹æ± ï¼Œå³ <code>createScheduler != null</code></li>
<li>ç›®å‰è¿æ¥æ± ä¸­æ²¡æœ‰å¯ç”¨è¿æ¥ï¼Œå³ <code>poolingCount == 0</code></li>
<li>ç›®å‰æ´»è·ƒçš„è¿æ¥æ•°å°äºæœ€å¤§è¿æ¥æ•°ï¼Œå³ <code>activeCount &lt; maxActive</code></li>
<li>ç›®å‰æ²¡æœ‰æ­£åœ¨åŒæ­¥åˆ›å»ºçš„è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ç»Ÿä¸€æ—¶åˆ»åªèƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹åœ¨åŒæ­¥åˆ›å»ºè¿æ¥ï¼Œå³ <code>creatingCountUpdater.get(this) == 0</code></li>
</ul>
<p>æ»¡è¶³ä¸Šè¿°æ¡ä»¶åï¼Œ<code>createDirect</code> ä¼šè¢«è®¾ç½®ä¸º <code>true</code>ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­å°±ä¼šåŒæ­¥åˆ›å»ºè¿æ¥ã€‚ä¹Ÿæ­£å› ä¸ºæœ‰ä¸Šè¿°æ¡ä»¶åœ¨ï¼Œæ‰€ä»¥åªæœ‰å¾ˆå°‘çš„çº¿ç¨‹ä¼šè¿›å…¥åˆ°åŒæ­¥åˆ›å»ºè¿æ¥çš„æµç¨‹ä¸­ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> DruidPooledConnection <span style="color:#00a000">getConnectionInternal</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> maxWait<span style="color:#666">)</span> <span style="color:#666">{</span>
	<span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>createDirect<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>creatingCountUpdater<span style="color:#666">.</span><span style="color:#b44">compareAndSet</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">,</span> 0<span style="color:#666">,</span> 1<span style="color:#666">))</span> <span style="color:#666">{</span>
            PhysicalConnectionInfo pyConnInfo <span style="color:#666">=</span> DruidDataSource<span style="color:#666">.</span><span style="color:#b44">this</span><span style="color:#666">.</span><span style="color:#b44">createPhysicalConnection</span><span style="color:#666">();</span>
            holder <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> DruidConnectionHolder<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">,</span> pyConnInfo<span style="color:#666">);</span>
            holder<span style="color:#666">.</span><span style="color:#b44">lastActiveTimeMillis</span> <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#b44">currentTimeMillis</span><span style="color:#666">();</span>
            <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#0b0;font-weight:bold">boolean</span> discard <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
            lock<span style="color:#666">.</span><span style="color:#b44">lock</span><span style="color:#666">();</span>
            <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>activeCount <span style="color:#666">&lt;</span> maxActive<span style="color:#666">)</span> <span style="color:#666">{</span>
                    activeCount<span style="color:#666">++;</span>
                    holder<span style="color:#666">.</span><span style="color:#b44">active</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>activeCount <span style="color:#666">&gt;</span> activePeak<span style="color:#666">)</span> <span style="color:#666">{</span>
                        activePeak <span style="color:#666">=</span> activeCount<span style="color:#666">;</span>
                        activePeakTime <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#b44">currentTimeMillis</span><span style="color:#666">();</span>
                    <span style="color:#666">}</span>
                    <span style="color:#a2f;font-weight:bold">break</span><span style="color:#666">;</span>
                <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#666">{</span>
                    discard <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">finally</span> <span style="color:#666">{</span>
                lock<span style="color:#666">.</span><span style="color:#b44">unlock</span><span style="color:#666">();</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><h4 id="222-å¼‚æ­¥åˆ›å»ºè¿æ¥">2.2.2 å¼‚æ­¥åˆ›å»ºè¿æ¥ <a href="#222-%e5%bc%82%e6%ad%a5%e5%88%9b%e5%bb%ba%e8%bf%9e%e6%8e%a5" class="anchor">ğŸ”—</a></h4><p>å¦‚æœæ²¡æœ‰åŒæ­¥åˆ›å»ºè¿æ¥ï¼Œåˆ™æ¥ä¸‹æ¥ä¼šé€šè¿‡ <code>pollLast(nanos)</code> æˆ– <code>takeLast()</code> å¼‚æ­¥åˆ›å»ºè¿æ¥ã€‚</p>
<p><code>nanos</code> æ˜¯æ ¹æ® <code>maxWait</code> è®¡ç®—å‡ºæ¥çš„ï¼Œå¦‚æœè®¾ç½®äº† <code>maxWait</code> å°±ä¼šè°ƒç”¨ <code>pollLast(nanos)</code>ï¼Œå¦åˆ™è°ƒç”¨ <code>takeLast()</code> ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> DruidPooledConnection <span style="color:#00a000">getConnectionInternal</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> maxWait<span style="color:#666">)</span> <span style="color:#666">{</span>

    <span style="color:#a2f;font-weight:bold">final</span> <span style="color:#0b0;font-weight:bold">long</span> nanos <span style="color:#666">=</span> TimeUnit<span style="color:#666">.</span><span style="color:#b44">MILLISECONDS</span><span style="color:#666">.</span><span style="color:#b44">toNanos</span><span style="color:#666">(</span>maxWait<span style="color:#666">);</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>maxWait <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
        holder <span style="color:#666">=</span> pollLast<span style="color:#666">(</span>nanos<span style="color:#666">);</span>
    <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#666">{</span>
        holder <span style="color:#666">=</span> takeLast<span style="color:#666">();</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><h4 id="223-polllast-å’Œ-takelast">2.2.3 <code>pollLast</code> å’Œ <code>takeLast</code> <a href="#223-polllast-%e5%92%8c-takelast" class="anchor">ğŸ”—</a></h4><p>åœ¨ <code>pollLast</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœå½“å‰è¿æ¥æ± ä¸­çš„è¿æ¥æ•° poolingCount ä¸º 0ï¼Œåˆ™è°ƒç”¨ <code>emptySignal</code> ä½¿ç”¨ä¿¡å·é‡ <code>empty</code>ï¼Œå¹¶åˆ›å»ºå¼‚æ­¥çº¿ç¨‹å»åˆ›å»ºè¿æ¥ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> DruidConnectionHolder <span style="color:#00a000">pollLast</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> nanos<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> InterruptedException<span style="color:#666">,</span> SQLException <span style="color:#666">{</span>
    <span style="color:#0b0;font-weight:bold">long</span> estimate <span style="color:#666">=</span> nanos<span style="color:#666">;</span>

    <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(;;)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>poolingCount <span style="color:#666">==</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
            emptySignal<span style="color:#666">();</span> <span style="color:#080;font-style:italic">// send signal to CreateThread create connection
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>ç„¶åï¼Œ<code>pollLast</code> è‡ªå·±å†ä½¿ç”¨ <code>notEmpty</code> ä¿¡å·é‡è¿›å…¥ç­‰å¾…ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">estimate <span style="color:#666">=</span> notEmpty<span style="color:#666">.</span><span style="color:#b44">awaitNanos</span><span style="color:#666">(</span>estimate<span style="color:#666">);</span> <span style="color:#080;font-style:italic">// signal by
</span><span style="color:#080;font-style:italic"></span>                                        <span style="color:#080;font-style:italic">// recycle or
</span><span style="color:#080;font-style:italic"></span>                                        <span style="color:#080;font-style:italic">// creator
</span></code></pre></div><p>æœ¬æ¬¡ç­‰å¾…çš„æœ€é•¿æ—¶é—´ <code>estimate</code> å°±æ˜¯æ ¹æ® <code>maxWait</code> è®¡ç®—å‡ºæ¥çš„ã€‚</p>
<p>åœ¨æœ‰è¿æ¥è¢«å›æ”¶ï¼Œä¼šæ–°åˆ›å»ºå‡ºæ¥åï¼Œå°±ä¼šè¢«å”¤é†’ã€‚å¦‚æœå”¤é†’åæœ¬çº¿ç¨‹æ²¡æœ‰æˆåŠŸåˆ›å»ºè¿æ¥ï¼Œå¹¶ä¸”ç›®å‰æ€»çš„ç­‰å¾…æ—¶é—´è¿˜æ²¡åˆ°<code>maxWait</code>ï¼Œå°±ä¼šå†æ¬¡è¿›å…¥ awaitã€‚</p>
<p>å¦‚æœç­‰å¾…æ—¶é—´åˆ°äº† <code>maxWait</code> ï¼Œä½†ä¾æ—§æ²¡æœ‰æˆåŠŸåˆ›å»ºè¿æ¥ï¼Œå³ poolingCount ä¸º 0ï¼Œåˆ™ä¼šè¿”å› nullã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>poolingCount <span style="color:#666">==</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>estimate <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><p>é€šè¿‡ä¿¡å·åˆ›å»ºçš„è¿æ¥ä¼šè¢«æ”¾å…¥åˆ°è¿æ¥æ±  connections ä¸­ï¼Œç„¶å <code>pollLast(nanos)</code> æ”¶åˆ°åˆ›å»ºæˆåŠŸçš„ä¿¡å·åï¼Œå°±å¯ä»¥ä»è¿æ¥æ± ä¸­å–å‡ºè¿æ¥å¹¶è¿”å›äº†ï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> DruidConnectionHolder <span style="color:#00a000">pollLast</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> nanos<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> InterruptedException<span style="color:#666">,</span> SQLException <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    decrementPoolingCount<span style="color:#666">();</span>
    DruidConnectionHolder last <span style="color:#666">=</span> connections<span style="color:#666">[</span>poolingCount<span style="color:#666">];</span>
    connections<span style="color:#666">[</span>poolingCount<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">return</span> last<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p>æ— å‚çš„ <code>takeLast()</code> å°±ç®€å•å¾ˆå¤šäº†ï¼Œå®ƒçš„æµç¨‹å’Œ <code>pollLast(nanos)</code> å‡ ä¹ä¸€è‡´ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å®ƒæ²¡æœ‰ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œåªæœ‰ç­‰å¾…å›æ”¶çº¿ç¨‹ï¼Œä¼šåˆ›å»ºçº¿ç¨‹å”¤é†’åï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DruidConnectionHolder <span style="color:#00a000">takeLast</span><span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">throws</span> InterruptedException<span style="color:#666">,</span> SQLException <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">while</span> <span style="color:#666">(</span>poolingCount <span style="color:#666">==</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
            emptySignal<span style="color:#666">();</span> <span style="color:#080;font-style:italic">// send signal to CreateThread create connection
</span><span style="color:#080;font-style:italic"></span>
            <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
                notEmpty<span style="color:#666">.</span><span style="color:#b44">await</span><span style="color:#666">();</span> <span style="color:#080;font-style:italic">// signal by recycle or creator
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#666">}</span> 
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    decrementPoolingCount<span style="color:#666">();</span>
    DruidConnectionHolder last <span style="color:#666">=</span> connections<span style="color:#666">[</span>poolingCount<span style="color:#666">];</span>
    connections<span style="color:#666">[</span>poolingCount<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">return</span> last<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><h4 id="224-emptysignal">2.2.4 emptySignal <a href="#224-emptysignal" class="anchor">ğŸ”—</a></h4><p>ä½¿ç”¨ä¿¡å·å¼‚æ­¥åˆ›å»ºè¿æ¥çš„ <code>emptySignal()</code> æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">emptySignal</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>createScheduler <span style="color:#666">==</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        empty<span style="color:#666">.</span><span style="color:#b44">signal</span><span style="color:#666">();</span>
        <span style="color:#a2f;font-weight:bold">return</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>createTaskCount <span style="color:#666">&gt;=</span> maxCreateTaskCount<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">return</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>activeCount <span style="color:#666">+</span> poolingCount <span style="color:#666">+</span> createTaskCount <span style="color:#666">&gt;=</span> maxActive<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">return</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
    submitCreateTask<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">);</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p>å¦‚æœè®¾ç½®çš„åˆ›å»ºçº¿ç¨‹æ±  createScheduler ä¸º nullï¼Œåˆ™ä¼šå‘é€ä¸€ä¸ªä¿¡å·å»åˆ›å»ºè¿æ¥ã€‚å¦åˆ™åˆ›å»ºä¸€ä¸ª  <code>CreateConnectionTask</code> æ¥åˆ›å»ºè¿æ¥ã€‚</p>
<p>è¿™é‡Œå‘å‡ºçš„åˆ›å»ºä¿¡å·ä¼šè¢« <code>CreateConnectionThread</code> æ¥æ”¶ï¼Œ<code>CreateConnectionThread</code> ä¼šåœ¨æ•°æ®æºåˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">init</span><span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    createAndStartCreatorThread<span style="color:#666">();</span>
    createAndStartDestroyThread<span style="color:#666">();</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p>æ”¶åˆ°ä¿¡å·åï¼Œä¼šåˆ¤æ–­å½“å‰æ´»è·ƒè¿æ¥æ•°ä»¥åŠè¿æ¥æ± ä¸­çš„è¿æ¥æ•°æ˜¯å¦å¤§äº maxActiveï¼Œå¦‚æœå¤§äºåˆ™ä¸åˆ›å»ºï¼Œé¿å…åˆ›å»ºå‡ºè¶…è¿‡ maxActive æ•°é‡çš„è¿æ¥ï¼›å¦‚æœå°äºï¼Œåˆ™åˆ›å»ºäº†ç‰©ç†è¿æ¥ï¼Œç„¶ååœ¨è°ƒç”¨ DruidDataSource çš„ put æ–¹æ³•å°†è¿æ¥æ”¾å…¥è¿æ¥æ± ä¸­ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>

    <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(;;)</span> <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">boolean</span> emptyWait <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>createError <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span>
                <span style="color:#666">&amp;&amp;</span> poolingCount <span style="color:#666">==</span> 0
                <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>discardChanged<span style="color:#666">)</span> <span style="color:#666">{</span>
                emptyWait <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>emptyWait
                <span style="color:#666">&amp;&amp;</span> asyncInit <span style="color:#666">&amp;&amp;</span> createCount <span style="color:#666">&lt;</span> initialSize<span style="color:#666">)</span> <span style="color:#666">{</span>
                emptyWait <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>emptyWait<span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#080;font-style:italic">// å¿…é¡»å­˜åœ¨çº¿ç¨‹ç­‰å¾…ï¼Œæ‰åˆ›å»ºè¿æ¥
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>poolingCount <span style="color:#666">&gt;=</span> notEmptyWaitThreadCount <span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>                    <span style="color:#666">&amp;&amp;</span> <span style="color:#666">(!(</span>keepAlive <span style="color:#666">&amp;&amp;</span> activeCount <span style="color:#666">+</span> poolingCount <span style="color:#666">&lt;</span> minIdle<span style="color:#666">))</span>
                    <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>isFailContinuous<span style="color:#666">()</span>
                   <span style="color:#666">)</span> <span style="color:#666">{</span>
                    empty<span style="color:#666">.</span><span style="color:#b44">await</span><span style="color:#666">();</span>
                <span style="color:#666">}</span>

                <span style="color:#080;font-style:italic">// é˜²æ­¢åˆ›å»ºè¶…è¿‡maxActiveæ•°é‡çš„è¿æ¥
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>activeCount <span style="color:#666">+</span> poolingCount <span style="color:#666">&gt;=</span> maxActive<span style="color:#666">)</span> <span style="color:#666">{</span>
                    empty<span style="color:#666">.</span><span style="color:#b44">await</span><span style="color:#666">();</span>
                    <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>

        <span style="color:#666">}</span> 
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>        PhysicalConnectionInfo connection <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
            connection <span style="color:#666">=</span> createPhysicalConnection<span style="color:#666">();</span>
        <span style="color:#666">}</span> 
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#0b0;font-weight:bold">boolean</span> result <span style="color:#666">=</span> put<span style="color:#666">(</span>connection<span style="color:#666">);</span>

    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p><code>CreateConnectionTask</code> ä¹Ÿæ˜¯ç±»ä¼¼çš„é€»è¾‘ã€‚
 </p>
<h4 id="225-druiddatasourceput">2.2.5 DruidDataSource#put <a href="#225-druiddatasourceput" class="anchor">ğŸ”—</a></h4><p>åœ¨ put æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­å½“å‰è¿æ¥æ•°æ˜¯å¦å¤§äºæœ€å¤§è¿æ¥æ•°ï¼Œå¦‚æœå°äºï¼Œåˆ™ä¼šå°†è¿æ¥æ”¾å…¥åˆ° <code>connections</code> ä¸­ï¼Œç„¶åå°† poolingCount çš„å€¼åŠ ä¸€ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">put</span><span style="color:#666">(</span>DruidConnectionHolder holder<span style="color:#666">,</span> <span style="color:#0b0;font-weight:bold">long</span> createTaskId<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>poolingCount <span style="color:#666">&gt;=</span> maxActive<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>createScheduler <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            clearCreateTask<span style="color:#666">(</span>createTaskId<span style="color:#666">);</span>
        <span style="color:#666">}</span>
        <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    connections<span style="color:#666">[</span>poolingCount<span style="color:#666">]</span> <span style="color:#666">=</span> holder<span style="color:#666">;</span>
    incrementPoolingCount<span style="color:#666">();</span>
    <span style="color:#080;font-style:italic">//... 
</span><span style="color:#080;font-style:italic"></span><span style="color:#666">}</span>
</code></pre></div><h4 id="226-å°ç»“">2.2.6 å°ç»“ <a href="#226-%e5%b0%8f%e7%bb%93" class="anchor">ğŸ”—</a></h4><p>ä»¥ä¸Šä¾¿æ˜¯ä¾¿æ˜¯å¤§è‡´çš„è¿æ¥åˆ›å»ºæµç¨‹ã€‚
â€‹</p>
<p>æ€»çš„æ¥è¯´å°±æ˜¯ï¼Œåº”ç”¨éœ€è¦æ‰§è¡Œ SQL çš„æ—¶å€™ï¼Œå°±é€šè¿‡ <code>getConnectionInternal</code> è·å–è¿æ¥ï¼Œå…¶ä¸­åˆ›å»ºè¿æ¥åˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ï¼Œå¼‚æ­¥åˆ™é€šè¿‡ä¿¡å·é‡åˆ›å»ºè¿æ¥ã€‚æˆåŠŸè·å–è¿æ¥åè¿˜ä¼šå°† <code>activeCount</code> åŠ ä¸€ã€‚</p>
<p>ç»“åˆ 1.2.1 ä¸­çš„å¼‚å¸¸ä¿¡æ¯ï¼ŒæŠ¥é”™æ—¶ <code>poolingCount</code> ä¸º 0ï¼Œ æ‰€ä»¥ä¼šè°ƒç”¨ <code>emptySignal()</code> åˆ›å»ºè¿æ¥ã€‚ä½†<code>activeCount + poolingCount + createTaskCount</code> æ˜¾ç„¶æ˜¯å¤§äº <code>maxActive</code> çš„ï¼Œå› æ­¤ <code>pollLast</code> æœ€ç»ˆä¼šç­‰å¾… <code>maxWait</code> ç„¶åè¶…æ—¶ã€‚æ‰€ä»¥æœ€ç»ˆ <code>getConnectionInternal</code> æŠ›å‡ºäº† <code>GetConnectionTimeoutException</code> å¼‚å¸¸ã€‚</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥é—®é¢˜çš„å…³é”®å°±æ˜¯ï¼Œä¸ºä»€ä¹ˆ activeCount ä¼šå¤§äº maxActiveï¼Ÿ</p>
<h3 id="23-è¿æ¥æ˜¯å¦‚ä½•é‡Šæ”¾çš„">2.3 è¿æ¥æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Ÿ <a href="#23-%e8%bf%9e%e6%8e%a5%e6%98%af%e5%a6%82%e4%bd%95%e9%87%8a%e6%94%be%e7%9a%84" class="anchor">ğŸ”—</a></h3><p>è¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆçŸ¥é“ activeCount ä»€ä¹ˆæ—¶å€™å‡å°‘ã€‚
â€‹</p>
<p>å‰é¢å·²ç»çŸ¥é“äº† activeCount ä¼šåœ¨è·å–åˆ°è¿æ¥åå¢åŠ ï¼Œé‚£ç›¸åº”çš„ï¼ŒactiveCount ä¹Ÿä¼šåœ¨é‡Šæ”¾è¿æ¥æ—¶å‡å°‘ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å°±è¯¦ç»†äº†è§£è¿æ¥æ—¶å¦‚ä½•é‡Šæ”¾çš„ã€‚
â€‹</p>
<h4 id="231-åº”ç”¨ä¸»åŠ¨å…³é—­è¿æ¥">2.3.1 åº”ç”¨ä¸»åŠ¨å…³é—­è¿æ¥ <a href="#231-%e5%ba%94%e7%94%a8%e4%b8%bb%e5%8a%a8%e5%85%b3%e9%97%ad%e8%bf%9e%e6%8e%a5" class="anchor">ğŸ”—</a></h4><p>æåˆ°è¿æ¥é‡Šæ”¾ï¼Œé¦–å…ˆæƒ³åˆ°çš„åº”è¯¥æ˜¯æˆ‘ä»¬åœ¨åº”ç”¨ä¸­ä¸»åŠ¨è°ƒç”¨ <code>connection.close()</code>æ–¹æ³•æ¥é‡Šæ”¾è¿æ¥ã€‚</p>
<p>é‚£ <code>connection.close()</code> ä¼šç«‹å³é‡Šæ”¾ç‰©ç†è¿æ¥å—ï¼Ÿæ˜¾ç„¶æ˜¯ä¸ä¼šçš„ã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">close</span><span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    recycle<span style="color:#666">();</span>
<span style="color:#666">}</span>

<span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">recycle</span><span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(!</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">abandoned</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        DruidAbstractDataSource dataSource <span style="color:#666">=</span> holder<span style="color:#666">.</span><span style="color:#b44">getDataSource</span><span style="color:#666">();</span>
        dataSource<span style="color:#666">.</span><span style="color:#b44">recycle</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">);</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p><code>connection.close()</code> ä¼šæœ€ç»ˆä¼šè°ƒç”¨ <code>dataSource.recycle(DruidPooledConnection pooledConnection)</code>é‡Šæ”¾è¿æ¥ã€‚ é‚£ <code>dataSource.recycle</code> åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ
â€‹</p>
<h4 id="232-recycle">2.3.2 recycle <a href="#232-recycle" class="anchor">ğŸ”—</a></h4><p>â€‹</p>
<p>åœ¨ recyle ä¸­ä¼šæœ‰ä¸€äº›åˆ—çš„è¿æ¥çŠ¶æ€åˆ¤æ–­ï¼Œå¦‚ç‰©ç†è¿æ¥æ˜¯å¦å·²å…³é—­ç­‰ï¼Œç„¶åå†³å®šæ˜¯å¦ç«‹å³é‡Šæ”¾è¿æ¥ã€‚ä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šè¿è¡Œåˆ°ä¸‹é¢çš„é€»è¾‘ï¼Œå³å¦‚æœè¿æ¥çŠ¶æ€æ˜¯æ´»è·ƒçš„ï¼Œåˆ™å°† activeCount å‡ä¸€ï¼Œå¹¶å°†çŠ¶æ€å†è®¾ç½®ä¸º falseã€‚æœ€åå†è°ƒç”¨ <code>putLast</code>ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
<span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * å›æ”¶è¿æ¥
</span><span style="color:#080;font-style:italic">     */</span>
<span style="color:#a2f;font-weight:bold">protected</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">recycle</span><span style="color:#666">(</span>DruidPooledConnection pooledConnection<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>holder<span style="color:#666">.</span><span style="color:#b44">active</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        activeCount<span style="color:#666">--;</span>
        holder<span style="color:#666">.</span><span style="color:#b44">active</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
    result <span style="color:#666">=</span> putLast<span style="color:#666">(</span>holder<span style="color:#666">,</span> currentTimeMillis<span style="color:#666">);</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span><span style="color:#666">}</span>
</code></pre></div><p>åœ¨ putLast ä¸­åˆ™ä¼šæ›´æ–°è¿æ¥çš„ä¸Šæ¬¡æ´»è·ƒæ—¶é—´ï¼Œç„¶åå°†è¿æ¥å†åº¦æ”¾å›åˆ°è¿æ¥æ± ä¸­ï¼Œå¹¶å°† <code>poolingcount</code> åŠ ä¸€ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">putLast</span><span style="color:#666">(</span>DruidConnectionHolder e<span style="color:#666">,</span> <span style="color:#0b0;font-weight:bold">long</span> lastActiveTimeMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>poolingCount <span style="color:#666">&gt;=</span> maxActive <span style="color:#666">||</span> e<span style="color:#666">.</span><span style="color:#b44">discard</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>

    e<span style="color:#666">.</span><span style="color:#b44">lastActiveTimeMillis</span> <span style="color:#666">=</span> lastActiveTimeMillis<span style="color:#666">;</span>
    connections<span style="color:#666">[</span>poolingCount<span style="color:#666">]</span> <span style="color:#666">=</span> e<span style="color:#666">;</span>
    incrementPoolingCount<span style="color:#666">();</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡ <code>.close</code> æ–¹æ³•ä¸»åŠ¨é‡Šæ”¾è¿æ¥ï¼Œä¸ä¼šçœŸçš„é‡Šæ”¾ï¼Œè€Œæ˜¯å°†è¿æ¥è¿˜å›åˆ°è¿æ¥æ± ä¸­ã€‚
â€‹</p>
<h4 id="233-è¿æ¥é‡Šæ”¾">2.3.3 è¿æ¥é‡Šæ”¾ <a href="#233-%e8%bf%9e%e6%8e%a5%e9%87%8a%e6%94%be" class="anchor">ğŸ”—</a></h4><p>æ—¢ç„¶å‰é¢çš„ <code>recycle</code> ä¸ä¼šå…³é—­è¿æ¥ï¼Œä½†è¿æ¥æ± ä¹Ÿä¸å¯èƒ½æ— é™å¤§ï¼Œé‚£è¿æ¥åˆ°åº•æ˜¯å¦‚ä½•å›æ”¶çš„å‘¢ï¼Ÿè¿™å°±è¦æåˆ° Druid çš„è¿æ¥é‡Šæ”¾ä»»åŠ¡äº†ã€‚
â€‹</p>
<p>é€š <code>CreateConnectionThread</code> ä¸€æ ·ï¼Œ Druid åœ¨åˆå§‹åŒ–æ•°æ®æºæ—¶ä¼šåˆ›å»ºé‡Šæ”¾è¿æ¥çš„çº¿ç¨‹ <code>DestroyThread</code> ï¼Œç„¶ååˆ›å»ºé‡Šæ”¾ä»»åŠ¡ DestroyTaskã€‚
â€‹</p>
<p>â€‹</p>
<p>å½“åº”ç”¨è®¾ç½®çš„é‡Šæ”¾çº¿ç¨‹æ±  destroyScheduler ä¸ä¸ºç©ºæ—¶ï¼Œå°±ä¼šåœ¨ destroyScheduler ä¸­è¿è¡Œ DestroyTaskï¼›å¦åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è¿æ¥çš„çº¿ç¨‹æ± ï¼Œç„¶ååœ¨è¯¥çº¿ç¨‹æ± ä¸­è¿è¡Œé‡Šæ”¾è¿æ¥çš„ä»»åŠ¡ã€‚ä¸ createScheduler ç±»ä¼¼ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šè®¾ç½® destroySchedulerã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">protected</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">createAndStartDestroyThread</span><span style="color:#666">()</span> <span style="color:#666">{</span>
    destroyTask <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> DestroyTask<span style="color:#666">();</span>

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>destroyScheduler <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>        destroySchedulerFuture <span style="color:#666">=</span> destroyScheduler<span style="color:#666">.</span><span style="color:#b44">scheduleAtFixedRate</span><span style="color:#666">(</span>destroyTask<span style="color:#666">,</span> period<span style="color:#666">,</span> period<span style="color:#666">,</span>
                                                                      TimeUnit<span style="color:#666">.</span><span style="color:#b44">MILLISECONDS</span><span style="color:#666">);</span>
        <span style="color:#a2f;font-weight:bold">return</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    destroyConnectionThread <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> DestroyConnectionThread<span style="color:#666">(</span>threadName<span style="color:#666">);</span>
    destroyConnectionThread<span style="color:#666">.</span><span style="color:#b44">start</span><span style="color:#666">();</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p>DestroyConnectionThread æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­æ¯éš” <code>timeBetweenEvictionRunsMillis</code> æ‰§è¡Œä¸€æ¬¡é‡Šæ”¾è¿æ¥çš„ä»»åŠ¡ã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">DestroyConnectionThread</span> <span style="color:#a2f;font-weight:bold">extends</span> Thread <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(;;)</span> <span style="color:#666">{</span>
            <span style="color:#080;font-style:italic">// ä»å‰é¢å¼€å§‹åˆ é™¤
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
                <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>timeBetweenEvictionRunsMillis <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
                    Thread<span style="color:#666">.</span><span style="color:#b44">sleep</span><span style="color:#666">(</span>timeBetweenEvictionRunsMillis<span style="color:#666">);</span>
                <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#666">{</span>
                    Thread<span style="color:#666">.</span><span style="color:#b44">sleep</span><span style="color:#666">(</span>1000<span style="color:#666">);</span> <span style="color:#080;font-style:italic">//
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#666">}</span>

                destroyTask<span style="color:#666">.</span><span style="color:#b44">run</span><span style="color:#666">();</span>
            <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>InterruptedException e<span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">break</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>é‡Šæ”¾è¿æ¥çš„å…³é”®é€»è¾‘å°±åœ¨ DestroyTask ä¸­ã€‚</p>
<h4 id="234-destroytask">2.3.4 DestroyTask <a href="#234-destroytask" class="anchor">ğŸ”—</a></h4><p>åœ¨ DestroyTask ä¸­ï¼Œä¸»è¦æ˜¯é€šè¿‡ <code>shrink</code> æ–¹æ³•æ¥é‡Šæ”¾è¿æ¥ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">DestroyTask</span> <span style="color:#a2f;font-weight:bold">implements</span> Runnable <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">DestroyTask</span><span style="color:#666">()</span> <span style="color:#666">{</span>

        <span style="color:#666">}</span>

        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            shrink<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">,</span> keepAlive<span style="color:#666">);</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>isRemoveAbandoned<span style="color:#666">())</span> <span style="color:#666">{</span>
                removeAbandoned<span style="color:#666">();</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>

    <span style="color:#666">}</span>
</code></pre></div><p>æ‰€ä»¥æ¥ä¸‹æ¥çš„å…³é”®å°±æ˜¯ <code>shrink(boolean checkTime, boolean keepAlive)</code>  æ–¹æ³•ã€‚</p>
<h4 id="235-destroytaskshrink">2.3.5 DestroyTask#shrink <a href="#235-destroytaskshrink" class="anchor">ğŸ”—</a></h4><p><code>shrink</code> æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><code>checkTime</code> æ˜¯å¦æ ¡éªŒè¿æ¥çš„æ—¶é—´ï¼Œå¦‚è¿æ¥ç©ºé—²æ—¶é—´ç­‰ï¼›</li>
<li><code>keepAlive</code> æ˜¯å¦å¼€å¯äº† keepAlive</li>
</ul>
<p>â€‹</p>
<p> 
åœ¨ <code>shrink</code> ä¸­ï¼Œé¦–å…ˆä¼šé€šè¿‡ for å¾ªç¯ï¼Œä¾æ¬¡éå†è¿æ¥æ± ä¸­çš„æ‰€æœ‰è¿æ¥å¹¶è¿›è¡Œå¤„ç†ã€‚
â€‹</p>
<p>åœ¨å¾ªç¯ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰ fatalErrorï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¼šå°†è¿æ¥æ”¾å…¥ keepAliveConnections åˆ—è¡¨ä¸­ï¼ŒkeepAliveConnections å­˜å‚¨äº†éœ€è¦ä¿æŒæ´»è·ƒçš„è¿æ¥ã€‚ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç° fatalError å‘¢ï¼Ÿä¸»è¦æ˜¯æ‰§è¡Œ SQL æ—¶å¯èƒ½å‡ºç°ï¼Œæ¯”å¦‚æ•°æ®åº“æ–­ç½‘ã€æ•°æ®åº“é‡å¯ç­‰ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">int</span> i <span style="color:#666">=</span> 0<span style="color:#666">;</span> i <span style="color:#666">&lt;</span> poolingCount<span style="color:#666">;</span> <span style="color:#666">++</span>i<span style="color:#666">)</span> <span style="color:#666">{</span>
    DruidConnectionHolder connection <span style="color:#666">=</span> connections<span style="color:#666">[</span>i<span style="color:#666">];</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">((</span>onFatalError <span style="color:#666">||</span> fatalErrorIncrement <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#666">(</span>lastFatalErrorTimeMillis <span style="color:#666">&gt;</span> connection<span style="color:#666">.</span><span style="color:#b44">connectTimeMillis</span><span style="color:#666">))</span>  <span style="color:#666">{</span>
        keepAliveConnections<span style="color:#666">[</span>keepAliveCount<span style="color:#666">++]</span> <span style="color:#666">=</span> connection<span style="color:#666">;</span>
        <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>å¦‚æœæ²¡æœ‰ fatalError å¹¶ä¸”å¼€å¯äº† <code>checkTime</code> ä¸º trueï¼Œåˆ™ä¼šç»§ç»­æ ¹æ®è¿æ¥æ—¶é—´åˆ¤æ–­è¿æ¥åº”è¯¥è¢«æ”¾å…¥ keepAliveConnections è¿˜æ˜¯ evictConnections é˜Ÿåˆ—ã€‚
â€‹</p>
<p>å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š
â€‹</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­ç‰©ç†è¿æ¥æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶åˆ™æ”¾å…¥ evictConnectionsï¼Œé»˜è®¤ phyTimeoutMillis ä¸º <code>-1</code> ï¼›</li>
<li>ç„¶ååˆ¤æ–­è¿æ¥ç©ºé—²æ—¶é—´æ˜¯å¦åŒæ—¶å°äº minEvictableIdleTimeMillis å’Œ keepAliveBetweenTimeMillisï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™é€€å‡ºæœ¬æ¬¡é‡Šæ”¾ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¿æ¥æ± ä¸­çš„å…¶ä»–è¿æ¥éƒ½ä¸ä¼šè¢«é‡Šæ”¾äº†ï¼›</li>
<li>å¦‚æœè¿æ¥ç©ºé—²æ—¶é—´å¤§äº minEvictableIdleTimeMillisï¼Œåˆ™åˆ¤æ–­è¯¥è¿æ¥é‡Šæ”¾åº”è¯¥è¢«é‡Šæ”¾ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯ <code>i &lt; checkCount</code> ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå½“å‰è¿æ¥æ± æ•°é‡å°äº minIdleï¼Œåˆ™è¿æ¥æ± å‰é¢çš„è¿æ¥ä¸ä¼šè¢«é‡Šæ”¾ï¼Œè€Œæ˜¯ä»è¿æ¥æ± åé¢çš„è¿æ¥å¼€å§‹é‡Šæ”¾ï¼›</li>
<li>å¦‚æœä¸æ»¡è¶³æ¡ä»¶ 3ï¼Œå¹¶ä¸”å¼€å¯äº† keepAliveï¼Œè¿æ¥ç©ºé—²æ—¶é—´ä¹Ÿå¤§äº keepAliveBetweenTimeMillisï¼Œåˆ™å°†è¿æ¥æ”¾å…¥ keepAliveConnections é˜Ÿåˆ—ã€‚ç»“åˆæ¡ä»¶ 3ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿æ¥æ± å‰é¢çš„è¿æ¥ä¼šè¢«ä¿æŒæ´»è·ƒã€‚</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">final</span> <span style="color:#0b0;font-weight:bold">int</span> checkCount <span style="color:#666">=</span> poolingCount <span style="color:#666">-</span> minIdle<span style="color:#666">;</span>
<span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">int</span> i <span style="color:#666">=</span> 0<span style="color:#666">;</span> i <span style="color:#666">&lt;</span> poolingCount<span style="color:#666">;</span> <span style="color:#666">++</span>i<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>phyTimeoutMillis <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
	    <span style="color:#0b0;font-weight:bold">long</span> phyConnectTimeMillis <span style="color:#666">=</span> currentTimeMillis <span style="color:#666">-</span> connection<span style="color:#666">.</span><span style="color:#b44">connectTimeMillis</span><span style="color:#666">;</span>
    	<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>phyConnectTimeMillis <span style="color:#666">&gt;</span> phyTimeoutMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
        	evictConnections<span style="color:#666">[</span>evictCount<span style="color:#666">++]</span> <span style="color:#666">=</span> connection<span style="color:#666">;</span>
	        <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    <span style="color:#0b0;font-weight:bold">long</span> idleMillis <span style="color:#666">=</span> currentTimeMillis <span style="color:#666">-</span> connection<span style="color:#666">.</span><span style="color:#b44">lastActiveTimeMillis</span><span style="color:#666">;</span>

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>idleMillis <span style="color:#666">&lt;</span> minEvictableIdleTimeMillis
        <span style="color:#666">&amp;&amp;</span> idleMillis <span style="color:#666">&lt;</span> keepAliveBetweenTimeMillis
    <span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">break</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>idleMillis <span style="color:#666">&gt;=</span> minEvictableIdleTimeMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>checkTime <span style="color:#666">&amp;&amp;</span> i <span style="color:#666">&lt;</span> checkCount<span style="color:#666">)</span> <span style="color:#666">{</span>
            evictConnections<span style="color:#666">[</span>evictCount<span style="color:#666">++]</span> <span style="color:#666">=</span> connection<span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
        <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>idleMillis <span style="color:#666">&gt;</span> maxEvictableIdleTimeMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
            evictConnections<span style="color:#666">[</span>evictCount<span style="color:#666">++]</span> <span style="color:#666">=</span> connection<span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>keepAlive <span style="color:#666">&amp;&amp;</span> idleMillis <span style="color:#666">&gt;=</span> keepAliveBetweenTimeMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
        keepAliveConnections<span style="color:#666">[</span>keepAliveCount<span style="color:#666">++]</span> <span style="color:#666">=</span> connection<span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œconnections ä¸­çš„è¿æ¥éƒ½æ˜¯æŒ‰ lastActiveTimeMillis å…ˆåé¡ºåºæ’åˆ—çš„ï¼Œå› æ­¤é‡Šæ”¾è¿æ¥æ—¶ï¼Œä»å‰å¾€åé‡Šæ”¾ï¼Œä¸€æ—¦å‘ç°è¿æ¥ç©ºé—²æ—¶é—´å°äº minEvictableIdleTimeMillis å’Œ keepAliveBetweenTimeMillis å°±ç»“æŸæœ¬æ¬¡é‡Šæ”¾æµç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘å¾ªç¯æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ã€‚å¹¶ä¸”è¿æ¥ä¿æ´»æ—¶ï¼Œä¹Ÿæ˜¯ä»å‰å¾€åè¿›è¡Œä¿æ´»ï¼Œå› ä¸ºå‰é¢çš„è¿æ¥æ›´å¯èƒ½è¶…æ—¶ã€‚è¿™ä¹Ÿæ­£æ˜¯ Druid è®¾è®¡çš„å·§å¦™ä¹‹å¤„ã€‚
â€‹</p>
<p>å½“ç„¶ï¼Œè¿™é‡Œæ˜¯â€œæ­£å¸¸æƒ…å†µâ€ï¼Œé‚£å¿…ç„¶ä¹Ÿä¼šæœ‰å¼‚å¸¸æƒ…å†µï¼Œå¼‚å¸¸æƒ…å†µæ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿè¿™é‡Œæš‚æ—¶å…ˆä¸å±•å¼€ï¼Œåé¢ä¼šè¯¦ç»†è®²è§£ã€‚
â€‹</p>
<p>åœ¨ç¡®å®šäº†éœ€è¦é‡Šæ”¾å’Œä¿æŒæ´»è·ƒçš„è¿æ¥æ•°é‡ä¹‹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ä»è¿æ¥æ± ä¸­å°†è¿æ¥åˆ é™¤ï¼Œåˆ é™¤çš„æ–¹å¼å°±æ˜¯å°† connections ä¸­å‰ removeCount ä¸ªè¿æ¥åˆ æ‰ï¼Œç„¶åå°†å‰©ä½™è¿æ¥å†ä¾æ¬¡ä»å‰å¾€åæ”¾å…¥åˆ° connectionsï¼Œæœ€åå†ç”¨ null å¡«å…… connectionsï¼Œä»¥ä¾¿åç»­å­˜å‚¨ä¿æ´»çš„è¿æ¥ã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#0b0;font-weight:bold">int</span> removeCount <span style="color:#666">=</span> evictCount <span style="color:#666">+</span> keepAliveCount<span style="color:#666">;</span>
<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>removeCount <span style="color:#666">&gt;</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
    System<span style="color:#666">.</span><span style="color:#b44">arraycopy</span><span style="color:#666">(</span>connections<span style="color:#666">,</span> removeCount<span style="color:#666">,</span> connections<span style="color:#666">,</span> 0<span style="color:#666">,</span> poolingCount <span style="color:#666">-</span> removeCount<span style="color:#666">);</span>
    Arrays<span style="color:#666">.</span><span style="color:#b44">fill</span><span style="color:#666">(</span>connections<span style="color:#666">,</span> poolingCount <span style="color:#666">-</span> removeCount<span style="color:#666">,</span> poolingCount<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">);</span>
    poolingCount <span style="color:#666">-=</span> removeCount<span style="color:#666">;</span>
<span style="color:#666">}</span>

</code></pre></div><p>æ¥ä¸‹æ¥å¯¹äº evictConnections ä¸­çš„è¿æ¥ï¼Œå°±å¯ä»¥ç›´æ¥å…³é—­äº†ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DruidConnectionHolder item <span style="color:#666">=</span> evictConnections<span style="color:#666">[</span>i<span style="color:#666">];</span>
Connection connection <span style="color:#666">=</span> item<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
JdbcUtils<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">(</span>connection<span style="color:#666">);</span>
destroyCountUpdater<span style="color:#666">.</span><span style="color:#b44">incrementAndGet</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">);</span>
</code></pre></div><p>å¯¹äº keepAliveConnections ä¸­çš„è¿æ¥ï¼Œåˆ™å…ˆåˆ¤æ–­è¿æ¥æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœè¿æ¥å¯ç”¨ï¼Œåˆ™è°ƒç”¨ <code>put</code> æ–¹æ³•å°†è¿æ¥å†æ”¾å›è¿æ¥æ± ã€‚å’Œå‰é¢åº”ç”¨ä¸»åŠ¨é‡Šæ”¾è¿æ¥æ—¶è°ƒç”¨çš„ <code>putLast</code> ä¸åŒçš„æ˜¯ï¼Œ<code>put</code> ä¸ä¼šæ›´æ–°è¿æ¥çš„ lastActiveTimeMillis ã€‚
â€‹</p>
<p>å¦‚æœè¿æ¥ä¸å¯ç”¨ï¼Œåˆ™ å†è°ƒç”¨ <code>emptySignal()</code> é€šè¿‡ä¿¡å·åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DruidConnectionHolder holer <span style="color:#666">=</span> keepAliveConnections<span style="color:#666">[</span>i<span style="color:#666">];</span>
Connection connection <span style="color:#666">=</span> holer<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
holer<span style="color:#666">.</span><span style="color:#b44">incrementKeepAliveCheckCount</span><span style="color:#666">();</span>

<span style="color:#0b0;font-weight:bold">boolean</span> validate <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
<span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">validateConnection</span><span style="color:#666">(</span>connection<span style="color:#666">);</span>
    validate <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
<span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>Throwable error<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// skip
</span><span style="color:#080;font-style:italic"></span><span style="color:#666">}</span>

<span style="color:#0b0;font-weight:bold">boolean</span> discard <span style="color:#666">=</span> <span style="color:#666">!</span>validate<span style="color:#666">;</span>
<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>validate<span style="color:#666">)</span> <span style="color:#666">{</span>
    holer<span style="color:#666">.</span><span style="color:#b44">lastKeepTimeMillis</span> <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#b44">currentTimeMillis</span><span style="color:#666">();</span>
    <span style="color:#0b0;font-weight:bold">boolean</span> putOk <span style="color:#666">=</span> put<span style="color:#666">(</span>holer<span style="color:#666">,</span> 0L<span style="color:#666">);</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(!</span>putOk<span style="color:#666">)</span> <span style="color:#666">{</span>
        discard <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>

<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>discard<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
        connection<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>
    
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>activeCount <span style="color:#666">+</span> poolingCount <span style="color:#666">&lt;=</span> minIdle<span style="color:#666">)</span> <span style="color:#666">{</span>
            emptySignal<span style="color:#666">();</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span><span style="color:#666">}</span>
</code></pre></div><p>è¿›è¡Œè¿æ¥ä¿æ´»æ—¶ï¼Œä¼˜å…ˆå°†æ—¶é—´æ›´æ—©çš„è¿æ¥è¿›è¡Œä¿æ´»ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½æœŸæœ›ä¸€ä¸ªè¿æ¥ä¸è¦å¤ªé•¿æ—¶é—´ç©ºé—²ï¼Œæ¯”å¦‚è¿æ¥ç©ºé—² 1 åˆ†é’Ÿåï¼Œå³ä½¿è¿æ¥å¯ç”¨ä¹Ÿè¦é‡Šæ”¾ï¼Œè¿™æ—¶åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ
â€‹</p>
<p>Druid ä¹Ÿè€ƒè™‘åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¯é€šè¿‡è®¾ç½® <code>testWhileIdle</code> ä¸º true è¿›è¡Œç©ºé—²è¿æ¥é‡Šæ”¾ã€‚</p>
<h4 id="236-ç©ºé—²è¿æ¥é‡Šæ”¾">2.3.6 ç©ºé—²è¿æ¥é‡Šæ”¾ <a href="#236-%e7%a9%ba%e9%97%b2%e8%bf%9e%e6%8e%a5%e9%87%8a%e6%94%be" class="anchor">ğŸ”—</a></h4><p>åœ¨åº”ç”¨ä¸­æˆ‘ä»¬ä¼šé€šè¿‡ <code>getConnection</code> è·å–è¿æ¥ï¼Œ<code>getConnection</code> ä¼šè°ƒç”¨ <code>getConnectionDirect</code>ï¼Œ<code>getConnectionDirect</code> ç»§ç»­è°ƒç”¨ <code>getConnectionInternal</code>ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> DruidPooledConnection <span style="color:#00a000">getConnectionDirect</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> maxWaitMillis<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    	<span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(;;)</span> <span style="color:#666">{</span>
            <span style="color:#080;font-style:italic">// handle notFullTimeoutRetry
</span><span style="color:#080;font-style:italic"></span>            DruidPooledConnection poolableConnection<span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
                poolableConnection <span style="color:#666">=</span> getConnectionInternal<span style="color:#666">(</span>maxWaitMillis<span style="color:#666">);</span>
            <span style="color:#666">}</span>
            
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>testOnBorrow<span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#666">{</span>
                <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>testWhileIdle<span style="color:#666">)</span> <span style="color:#666">{</span>
                    <span style="color:#a2f;font-weight:bold">final</span> DruidConnectionHolder holder <span style="color:#666">=</span> poolableConnection<span style="color:#666">.</span><span style="color:#b44">holder</span><span style="color:#666">;</span>
                    <span style="color:#0b0;font-weight:bold">long</span> currentTimeMillis             <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#b44">currentTimeMillis</span><span style="color:#666">();</span>
                    <span style="color:#0b0;font-weight:bold">long</span> lastActiveTimeMillis          <span style="color:#666">=</span> holder<span style="color:#666">.</span><span style="color:#b44">lastActiveTimeMillis</span><span style="color:#666">;</span>
                    <span style="color:#0b0;font-weight:bold">long</span> lastExecTimeMillis            <span style="color:#666">=</span> holder<span style="color:#666">.</span><span style="color:#b44">lastExecTimeMillis</span><span style="color:#666">;</span>
                    <span style="color:#0b0;font-weight:bold">long</span> lastKeepTimeMillis            <span style="color:#666">=</span> holder<span style="color:#666">.</span><span style="color:#b44">lastKeepTimeMillis</span><span style="color:#666">;</span>

                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>checkExecuteTime
                            <span style="color:#666">&amp;&amp;</span> lastExecTimeMillis <span style="color:#666">!=</span> lastActiveTimeMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
                        lastActiveTimeMillis <span style="color:#666">=</span> lastExecTimeMillis<span style="color:#666">;</span>
                    <span style="color:#666">}</span>

                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>lastKeepTimeMillis <span style="color:#666">&gt;</span> lastActiveTimeMillis<span style="color:#666">)</span> <span style="color:#666">{</span>
                        lastActiveTimeMillis <span style="color:#666">=</span> lastKeepTimeMillis<span style="color:#666">;</span>
                    <span style="color:#666">}</span>

                    <span style="color:#0b0;font-weight:bold">long</span> idleMillis                    <span style="color:#666">=</span> currentTimeMillis <span style="color:#666">-</span> lastActiveTimeMillis<span style="color:#666">;</span>

                    <span style="color:#0b0;font-weight:bold">long</span> timeBetweenEvictionRunsMillis <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">timeBetweenEvictionRunsMillis</span><span style="color:#666">;</span>

                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>timeBetweenEvictionRunsMillis <span style="color:#666">&lt;=</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
                        timeBetweenEvictionRunsMillis <span style="color:#666">=</span> DEFAULT_TIME_BETWEEN_EVICTION_RUNS_MILLIS<span style="color:#666">;</span>
                    <span style="color:#666">}</span>

                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>idleMillis <span style="color:#666">&gt;=</span> timeBetweenEvictionRunsMillis
                            <span style="color:#666">||</span> idleMillis <span style="color:#666">&lt;</span> 0 <span style="color:#080;font-style:italic">// unexcepted branch
</span><span style="color:#080;font-style:italic"></span>                            <span style="color:#666">)</span> <span style="color:#666">{</span>
                        <span style="color:#0b0;font-weight:bold">boolean</span> validate <span style="color:#666">=</span> testConnectionInternal<span style="color:#666">(</span>poolableConnection<span style="color:#666">.</span><span style="color:#b44">holder</span><span style="color:#666">,</span> poolableConnection<span style="color:#666">.</span><span style="color:#b44">conn</span><span style="color:#666">);</span>
                        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(!</span>validate<span style="color:#666">)</span> <span style="color:#666">{</span>
                            discardConnection<span style="color:#666">(</span>poolableConnection<span style="color:#666">.</span><span style="color:#b44">holder</span><span style="color:#666">);</span>
                             <span style="color:#a2f;font-weight:bold">continue</span><span style="color:#666">;</span>
                        <span style="color:#666">}</span>
                    <span style="color:#666">}</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>   

            <span style="color:#a2f;font-weight:bold">return</span> poolableConnection<span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>åœ¨ <code>getConnectionDirect</code> ä¸­ï¼Œè·å–åˆ°è¿æ¥åï¼Œå¦‚æœå¼€å¯äº† <code>testWhileIdle</code> ï¼Œåˆ™ä¼šç»§ç»­åˆ¤æ–­è¿æ¥æ˜¯å¦ç©ºé—²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šè°ƒç”¨ <code>discardConnection </code> é‡Šæ”¾è¿æ¥ï¼Œç„¶åå†è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯åˆ›å»ºæ–°çš„è¿æ¥ã€‚è¿æ¥æ˜¯å¦ç©ºé—²ï¼Œä¸»è¦æ ¹æ® <code>lastActiveTimeMillis</code> å’Œ <code>timeBetweenEvictionRunsMillis</code> è¿›è¡Œåˆ¤æ–­ã€‚
â€‹</p>
<p>åœ¨ discardConnection ä¸­ï¼Œå¦‚æœè¿æ¥ active çŠ¶æ€ä¸º trueï¼Œåˆ™ä¼šå°† activeCount å‡ä¸€ï¼Œå¹¶å°† active è®¾ç½®ä¸º falseã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">discardConnection</span><span style="color:#666">(</span>DruidConnectionHolder holder<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#080;font-style:italic">// ...
</span><span style="color:#080;font-style:italic"></span>    Connection conn <span style="color:#666">=</span> holder<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>conn <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        JdbcUtils<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">(</span>conn<span style="color:#666">);</span>
    <span style="color:#666">}</span>

    lock<span style="color:#666">.</span><span style="color:#b44">lock</span><span style="color:#666">();</span>
    <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>holder<span style="color:#666">.</span><span style="color:#b44">discard</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>holder<span style="color:#666">.</span><span style="color:#b44">active</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            activeCount<span style="color:#666">--;</span>
            holder<span style="color:#666">.</span><span style="color:#b44">active</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        discardCount<span style="color:#666">++;</span>

        holder<span style="color:#666">.</span><span style="color:#b44">discard</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>activeCount <span style="color:#666">&lt;=</span> minIdle<span style="color:#666">)</span> <span style="color:#666">{</span>
            emptySignal<span style="color:#666">();</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">finally</span> <span style="color:#666">{</span>
        lock<span style="color:#666">.</span><span style="color:#b44">unlock</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><h4 id="237-å°ç»“">2.3.7 å°ç»“ <a href="#237-%e5%b0%8f%e7%bb%93" class="anchor">ğŸ”—</a></h4><p>ä»¥ä¸Šä¾¿æ˜¯ä¾¿æ˜¯è¿æ¥é‡Šæ”¾çš„æµç¨‹ã€‚
â€‹</p>
<p>å½“åº”ç”¨ä¸»åŠ¨è°ƒç”¨ <code>.close</code> æ—¶ï¼Œå¹¶ä¸ä¼šçœŸçš„æ˜¯å¦è¿æ¥ï¼Œè€Œæ˜¯æ›´æ–°è¿æ¥çš„ lastActiveTimeMillisï¼Œç„¶åå°†è¿æ¥è¿”å›åˆ°è¿æ¥æ± ï¼Œç„¶åå°† <code>activeCount</code> å‡ä¸€ã€‚</p>
<p>ç„¶å DestroyTask å†å®šæœŸæ¸…ç†è¿æ¥ï¼Œåˆ¤æ–­è¿æ¥åº”è¯¥è¢«é‡Šæ”¾è¿˜æ˜¯è¢«ä¿æ´»ã€‚å¦‚æœè¿æ¥åº”è¯¥è¢«ä¿æ´»ï¼Œåˆ™å†å°†è¿æ¥æ”¾å›åˆ°è¿æ¥æ± ã€‚
â€‹</p>
<p>æ­¤å¤–åº”ç”¨è·å–è¿æ¥æ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå¦‚æœè¿æ¥æ˜¯ç©ºé—²çš„ï¼Œä¹Ÿä¼šé‡Šæ”¾è¿æ¥ï¼Œå¹¶å°† <code>activeCount</code> å‡ä¸€ã€‚
â€‹</p>
<p>é‚£ä¸ºä»€ä¹ˆ <code>activeCount</code> ä¼šå¤§äº <code>maxActive</code> å‘¢ï¼Ÿå¯èƒ½å”¯ä¸€çš„è§£é‡Šå°±æ˜¯ <code>activeCount</code> ä¸å‡†ç¡®ã€‚
â€‹</p>
<p>è¿™é‡Œå…ˆè¯´ç»“è®ºï¼Œçš„ç¡®å¦‚æ­¤ã€‚è¿™æ˜¯ Druid 1.2.8 ä¹‹å‰ç‰ˆæœ¬çš„ä¸€ä¸ª BUGã€‚
â€‹</p>
<p>é€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¤§æ¦‚æ¨æµ‹ï¼šå½“è¿æ¥æ± ä¸­å­˜åœ¨ä¸¤ä¸ªç›¸åŒè¿æ¥æ—¶ï¼Œ<code>activeCount</code> å°±ä¼šå°‘å‡ä¸€ã€‚å› ä¸ºå½“åº”ç”¨ç¬¬ä¸€æ¬¡é‡Šæ”¾è¿æ¥æ—¶ï¼Œä¼šå°†è¿æ¥çš„ <code>active</code> è®¾ç½®ä¸º false å¹¶æ‰§è¡Œ <code>activeCount--</code>ï¼Œç¬¬äºŒæ¬¡é‡Šæ”¾æ—¶ï¼Œç”±äº <code>active</code> å·²ç»ä¸º false äº†ï¼Œå› æ­¤å°±ä¸ä¼šå†æ‰§è¡Œ <code>activeCount--</code> äº†ã€‚<br>
â€‹</p>
<p>é‚£ä¹ˆå¦‚ä½•è¯æ˜æ¨æµ‹çš„æ­£ç¡®æ€§å‘¢ï¼Ÿ
â€‹</p>
<h2 id="3-é—®é¢˜å¤ç°">3. é—®é¢˜å¤ç° <a href="#3-%e9%97%ae%e9%a2%98%e5%a4%8d%e7%8e%b0" class="anchor">ğŸ”—</a></h2><p>ä¸ºäº†è¯æ˜å‰é¢çš„æ¨æµ‹ï¼Œæˆ‘å†™äº†ä¸€æ®µä»£ç æ¥éªŒè¯ã€‚
â€‹</p>
<h3 id="31-å¤ç°ä»£ç ">3.1 å¤ç°ä»£ç  <a href="#31-%e5%a4%8d%e7%8e%b0%e4%bb%a3%e7%a0%81" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>ä»£ç å¦‚ä¸‹ï¼ŒDruid ç‰ˆæœ¬ä¸º 1.2.5 ï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Test</span> <span style="color:#666">{</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">static</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
        String jdbcUrl <span style="color:#666">=</span> <span style="color:#b44">&#34;jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&#34;</span><span style="color:#666">;</span>
        String user <span style="color:#666">=</span> <span style="color:#b44">&#34;root&#34;</span><span style="color:#666">;</span>
        String password <span style="color:#666">=</span> <span style="color:#b44">&#34;11111111&#34;</span><span style="color:#666">;</span>

        DruidDataSource druidDataSource <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> DruidDataSource<span style="color:#666">();</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setUsername</span><span style="color:#666">(</span>user<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setPassword</span><span style="color:#666">(</span>password<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setUrl</span><span style="color:#666">(</span>jdbcUrl<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setValidationQuery</span><span style="color:#666">(</span><span style="color:#b44">&#34;select 1&#34;</span><span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setMinEvictableIdleTimeMillis</span><span style="color:#666">(</span>10 <span style="color:#666">*</span> 1000<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setMaxEvictableIdleTimeMillis</span><span style="color:#666">(</span>DEFAULT_MAX_EVICTABLE_IDLE_TIME_MILLIS<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setKeepAliveBetweenTimeMillis</span><span style="color:#666">(</span>12 <span style="color:#666">*</span> 1000<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setMinIdle</span><span style="color:#666">(</span>2<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setMaxWait</span><span style="color:#666">(</span>1000<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setMaxActive</span><span style="color:#666">(</span>4<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setTimeBetweenEvictionRunsMillis</span><span style="color:#666">(</span>7 <span style="color:#666">*</span> 1000<span style="color:#666">);</span>
        druidDataSource<span style="color:#666">.</span><span style="color:#b44">setKeepAlive</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">);</span>
        DruidPooledConnection connection1 <span style="color:#666">=</span> druidDataSource<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
        DruidPooledConnection connection2 <span style="color:#666">=</span> druidDataSource<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
        connection2<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
        Thread<span style="color:#666">.</span><span style="color:#b44">sleep</span><span style="color:#666">(</span>9 <span style="color:#666">*</span> 1000<span style="color:#666">);</span>
        connection1<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
        Thread<span style="color:#666">.</span><span style="color:#b44">sleep</span><span style="color:#666">(</span>14 <span style="color:#666">*</span> 1000<span style="color:#666">);</span>
        DruidPooledConnection connection3 <span style="color:#666">=</span> druidDataSource<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
        DruidPooledConnection connection4 <span style="color:#666">=</span> druidDataSource<span style="color:#666">.</span><span style="color:#b44">getConnection</span><span style="color:#666">();</span>
        System<span style="color:#666">.</span><span style="color:#b44">out</span><span style="color:#666">.</span><span style="color:#b44">println</span><span style="color:#666">(</span>connection3<span style="color:#666">.</span><span style="color:#b44">getConnectionHolder</span><span style="color:#666">()</span> <span style="color:#666">==</span> connection4<span style="color:#666">.</span><span style="color:#b44">getConnectionHolder</span><span style="color:#666">());</span>
        connection3<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
        connection4<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>

</code></pre></div><p>â€‹</p>
<p>æœ€ç»ˆä¼šè¾“å‡º <code>true</code>ï¼Œä¹Ÿå°±æ˜¯  <code>connection3</code> å’Œ <code>connection4</code> è·å–åˆ°çš„è¿æ¥æ˜¯ä¸€æ ·çš„ã€‚
â€‹</p>
<p>ä¸ºä»€ä¹ˆä¸º true å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±ç»“åˆå‰é¢çš„æºç ç†è§£ï¼Œæ¢³ç†ä¸€ä¸‹æ•´ä¸ªæ—¶é—´çº¿ã€‚
â€‹</p>
<h3 id="32-æ—¶é—´çº¿">3.2 æ—¶é—´çº¿ <a href="#32-%e6%97%b6%e9%97%b4%e7%ba%bf" class="anchor">ğŸ”—</a></h3><h3 id="heading"> <a href="#heading" class="anchor">ğŸ”—</a></h3><h4 id="321-æ—¶é—´ç‚¹-00åˆå§‹åŒ–å¹¶å…³é—­-connection2">3.2.1 æ—¶é—´ç‚¹ 00ï¼šåˆå§‹åŒ–å¹¶å…³é—­ connection2 <a href="#321-%e6%97%b6%e9%97%b4%e7%82%b9-00%e5%88%9d%e5%a7%8b%e5%8c%96%e5%b9%b6%e5%85%b3%e9%97%ad-connection2" class="anchor">ğŸ”—</a></h4><p>â€‹</p>
<p>è·å– connection1 å’Œ connection2ï¼Œå…¶ holder å¦‚ä¸‹ï¼š</p>
<ul>
<li>connection1  <code>{id: 110, useCount: 1, lastActiveTime: 00, active: true}</code></li>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, active: true}</code></li>
</ul>
<p>ç„¶åå…³é—­ connection2ï¼Œæ­¤æ—¶ connections ä¸º <code>[connection2]</code>ï¼š</p>
<ul>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, active: false}</code></li>
</ul>
<p>æœ€ç»ˆ activeAcount ä¸º 1ã€‚
â€‹</p>
<h4 id="322-æ—¶é—´ç‚¹-07ç¬¬ä¸€æ¬¡å›æ”¶">3.2.2 æ—¶é—´ç‚¹ 07ï¼šç¬¬ä¸€æ¬¡å›æ”¶ <a href="#322-%e6%97%b6%e9%97%b4%e7%82%b9-07%e7%ac%ac%e4%b8%80%e6%ac%a1%e5%9b%9e%e6%94%b6" class="anchor">ğŸ”—</a></h4><p>â€‹</p>
<p>DestroyTask ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œæ­¤æ—¶ connection2 çš„ç©ºé—²æ—¶é—´å‡å°äº <code>minEvictableIdleTimeMillis</code> å’Œ<code>keepAliveBetweenTimeMillis</code>ï¼Œè·³è¿‡å›æ”¶ã€‚
â€‹</p>
<h4 id="323-æ—¶é—´ç‚¹-09å…³é—­-connection1">3.2.3 æ—¶é—´ç‚¹ 09ï¼šå…³é—­ connection1 <a href="#323-%e6%97%b6%e9%97%b4%e7%82%b9-09%e5%85%b3%e9%97%ad-connection1" class="anchor">ğŸ”—</a></h4><p>â€‹</p>
<p>å…³é—­ connection1ï¼Œconnection1 è¿”å›è¿æ¥æ± ï¼Œæ­¤æ—¶ connections ä¸º <code>[connection2,connection1]</code>ï¼Œconnections ä¸­çš„è¿æ¥ç©ºé—²æ—¶é—´æ˜¯é€’å‡çš„ï¼š</p>
<ul>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, active: false}</code></li>
<li>connection1 <code>{id: 110, useCount: 1, lastActiveTime: 09, active: false}</code></li>
</ul>
<p>â€‹</p>
<p>æœ€ç»ˆ activeAcount ä¸º 0ã€‚
â€‹</p>
<h4 id="324-æ—¶é—´ç‚¹-14ç¬¬äºŒæ¬¡å›æ”¶">3.2.4 æ—¶é—´ç‚¹ 14ï¼šç¬¬äºŒæ¬¡å›æ”¶ <a href="#324-%e6%97%b6%e9%97%b4%e7%82%b9-14%e7%ac%ac%e4%ba%8c%e6%ac%a1%e5%9b%9e%e6%94%b6" class="anchor">ğŸ”—</a></h4><p>DestroyTask æ‰§è¡Œï¼Œæ­¤æ—¶ <code>connection2</code> ç©ºé—²æ—¶é—´å¤§äº <code>minEvictableIdleTimeMillis</code>ï¼Œä½† checkCount ä¸º 0ï¼ˆpoolingCount - minIdle ï¼‰ï¼Œä¸æ»¡è¶³ <code>i &lt; checkCount</code> ï¼Œ<code>connection2</code> ä¼šè¢«æ”¾å…¥ keepAliveConnections åˆ—è¡¨ã€‚
â€‹</p>
<p>è€Œ <code>connection1</code> çš„ç©ºé—²æ—¶é—´å‡å°äº <code>minEvictableIdleTimeMillis</code> å’Œ<code>keepAliveBetweenTimeMillis</code> ï¼Œä¸å¤„ç†ã€‚
â€‹</p>
<p>æœ€ç»ˆ connections ä¸º <code>[connection1,connection2]</code> ï¼š</p>
<ul>
<li>connection1 <code>{id: 110, useCount: 1, lastActiveTime: 09, active: false}</code></li>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, lastKeepTime: 14, active: false}</code></li>
</ul>
<p>â€‹</p>
<p>æ­¤æ—¶ activeAcount ä¾æ—§ä¸º 0ã€‚ä½† connections ä¸­çš„ lastActiveTime å°±ä¸æ˜¯æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„äº†ã€‚
â€‹</p>
<h4 id="325-æ—¶é—´ç‚¹-21ç¬¬ä¸‰æ¬¡å›æ”¶">3.2.5 æ—¶é—´ç‚¹ 21ï¼šç¬¬ä¸‰æ¬¡å›æ”¶ <a href="#325-%e6%97%b6%e9%97%b4%e7%82%b9-21%e7%ac%ac%e4%b8%89%e6%ac%a1%e5%9b%9e%e6%94%b6" class="anchor">ğŸ”—</a></h4><p>DestroyTask å†æ¬¡æ‰§è¡Œï¼Œæ­¤æ—¶ connection1 ç©ºé—²æ—¶é—´ä¸º 11sï¼Œç”±äºä¸æ»¡è¶³æ¡ä»¶ï¼Œå³ä¸æ”¾å…¥ evictConnectionsï¼Œ ä¹Ÿä¸æ”¾å…¥ keepAliveConnectionsï¼Œconnection2 ç©ºé—²æ—¶é—´ä¸º 21sï¼Œå¤§äº keepAliveBetweenTimeMillisï¼Œå› æ­¤æ”¾å…¥ keepAliveConnectionsã€‚
â€‹</p>
<p>ç”±äº removeCount ä¸º 1ï¼ˆ removeCount = evictCount + keepAliveCountï¼‰ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ä¼šåˆ æ‰ connections çš„ç¬¬ 0 ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ connection1ï¼Œç„¶åå°† keepAliveConnections æ·»åŠ åˆ° connections ä¸­ã€‚
â€‹</p>
<p>æœ€ç»ˆ connections ä¸º  <code>[connection2,connection2]</code> ï¼š
â€‹</p>
<ul>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, lastKeepTime: 14, active: false}</code></li>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, lastKeepTime: 14, active: false}</code></li>
</ul>
<p>â€‹</p>
<p> </p>
<h4 id="326-æ—¶é—´ç‚¹-23è·å–-connection3">3.2.6 æ—¶é—´ç‚¹ 23ï¼šè·å– connection3 <a href="#326-%e6%97%b6%e9%97%b4%e7%82%b9-23%e8%8e%b7%e5%8f%96-connection3" class="anchor">ğŸ”—</a></h4><p>è¿™æ—¶ç»§ç»­è·å– conenction3ï¼Œä¼˜å…ˆä» connections æœ«å°¾è·å–ã€‚
â€‹</p>
<p>è·å–åˆ° <code>id</code> ä¸º 100 çš„è¿æ¥åï¼Œç»§ç»­åˆ¤æ–­è¿æ¥çš„ç©ºé—²æ—¶é—´ã€‚ç”±äº lastActiveTime å°äº lastKeepTimeï¼Œæ‰€ä»¥ä¼šç”¨ lastKeepTime æ¥è®¡ç®—ç©ºé—²æ—¶é—´ï¼Œç©ºé—²æ—¶é—´ä¸º 9ï¼Œå°äº timeBetweenEvictionRunsMillisï¼Œå› æ­¤è®¤ä¸ºè¿æ¥å¯ç”¨ï¼Œå¹¶è¿”å›ã€‚
â€‹</p>
<p>æ‰€ä»¥ conenction3 ä¸º <code>{id: 100, useCount: 2, lastActiveTime: 00, lastKeepTime: 14, active: true}</code>
â€‹</p>
<p>åŒæ—¶ä¹Ÿä¼š activeCount åŠ ä¸€ï¼Œæœ€ç»ˆ activeCount ä¸º  1ã€‚
â€‹</p>
<p>æ­¤æ—¶ connections ä¸ºï¼š</p>
<ul>
<li>connection2 <code>{id: 100, useCount: 1, lastActiveTime: 00, lastKeepTime: 14, active: false}</code></li>
</ul>
<p>â€‹</p>
<h4 id="327-æ—¶é—´ç‚¹-23è·å–-connection4">3.2.7 æ—¶é—´ç‚¹ 23ï¼šè·å– connection4 <a href="#327-%e6%97%b6%e9%97%b4%e7%82%b9-23%e8%8e%b7%e5%8f%96-connection4" class="anchor">ğŸ”—</a></h4><p> 
åŒç†ï¼Œè·å–åˆ° conenction4 ä¸º <code>{id: 100, useCount: 3, lastActiveTime: 00, lastKeepTime: 14, active: true}</code> ï¼Œå¹¶ä¸”ä¹Ÿä¼šå°† activeCount åŠ ä¸€ï¼Œæœ€ç»ˆ activeCount ä¸º  2ã€‚</p>
<p>æ‰€ä»¥ connection3 å’Œ connection4 æœ¬è´¨ä¸Šæ˜¯åŒä¸€ä¸ª holderã€‚
â€‹</p>
<p>å¦å¤–ï¼Œæ­¤æ—¶ connections ä¸ºç©ºã€‚</p>
<p> </p>
<h4 id="328-æ—¶é—´ç‚¹-23å…³é—­-connection3">3.2.8 æ—¶é—´ç‚¹ 23ï¼šå…³é—­ connection3 <a href="#328-%e6%97%b6%e9%97%b4%e7%82%b9-23%e5%85%b3%e9%97%ad-connection3" class="anchor">ğŸ”—</a></h4><p>ç´§æ¥ç€è°ƒç”¨ close æ–¹æ³•å…³é—­ connection3ï¼Œå°†è¿æ¥è¿”å›è¿æ¥æ± ï¼ŒåŒæ—¶å°† activeCount å‡ä¸€ã€‚æ‰§è¡Œå®Œæ¯•åconnections ä¸º <code>[connections3]</code> ï¼š</p>
<ul>
<li>connection3 <code>{id: 100, useCount: 3, lastActiveTime: 23, lastKeepTime: 14, active: false}</code></li>
</ul>
<p>æœ€ç»ˆ activeCount ä¸º 1ï¼Œå¹¶ä¸” holder çš„ active å±æ€§ä¸º falseã€‚
â€‹</p>
<h4 id="329-æ—¶é—´ç‚¹-23å…³é—­-connection4">3.2.9 æ—¶é—´ç‚¹ 23ï¼šå…³é—­ connection4 <a href="#329-%e6%97%b6%e9%97%b4%e7%82%b9-23%e5%85%b3%e9%97%ad-connection4" class="anchor">ğŸ”—</a></h4><p>â€‹</p>
<p>åœ¨å…³é—­ connection3 ä¹‹åï¼Œç«‹å³åˆå…³é—­ connection4ï¼Œ ä½†ç”±äºå…¶ holder çš„ active å·²ç»æ˜¯ false äº†ï¼Œæ‰€ä»¥ activeCount ä¸ä¼šå†å‡ä¸€äº†ã€‚
â€‹</p>
<p>æœ€ç»ˆè™½ç„¶è¿æ¥ä¼šè¢«é‡Šæ”¾ï¼Œä½† activeCount å°‘å‡äº†ä¸€æ¬¡ã€‚
â€‹</p>
<h3 id="33-å°ç»“">3.3 å°ç»“ <a href="#33-%e5%b0%8f%e7%bb%93" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>ç”±æ­¤å¯è§ï¼Œåœ¨æŸäº›ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œç”±äº keepAlive æœºåˆ¶ä¼šå°†è¿æ¥å†æ”¾å›è¿æ¥æ± ï¼Œå¯èƒ½ä¼šå¯¼è‡´ connections ä¸­ä¼šå­˜åœ¨å¤šä¸ªå®Œå…¨ç›¸åŒçš„è¿æ¥ holderï¼Œå¹¶ä¸”è¯¥ holder åˆå¯èƒ½åˆšå¥½è¢«å¤šä¸ªåº”ç”¨çº¿ç¨‹è·å–åˆ°äº†ï¼Œç„¶åå…³é—­è¿æ¥æ—¶ï¼Œç”±äºæœ€æ—©å…³é—­çš„çº¿ç¨‹å·²ç»å°† holder çš„ active æ ‡è®°ä¸º false äº†ï¼Œæ‰€ä»¥å…¶ä»–çº¿ç¨‹å…³é—­è¿æ¥æ—¶ï¼Œå°±ä¸ä¼šå†æŠŠ activeCount å‡ä¸€ã€‚æœ€ç»ˆå¯¼è‡´äº† activeCount ä¸å‡†ç¡®ã€‚
â€‹</p>
<p>é‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘è¿™ä¸ª BUG å‘¢ï¼Ÿè¿™ä¸ª BUG æ˜¯ä¸ªå°æ¦‚ç‡äº‹ä»¶ï¼Œä»¥ä¸‹å‡ ç§æƒ…å†µä¼šæå‡ BUG å‡ºç°çš„æ¦‚ç‡ï¼š</p>
<ul>
<li>æ•°æ®åº“å¼‚å¸¸ï¼Œå¦‚ç½‘ç»œä¸­æ–­ã€ä¸»å¤‡åˆ‡æ¢ã€å¼‚å¸¸é‡å¯ç­‰ï¼Œè¿™æ—¶å¯èƒ½å°±ä¼šå¯¼è‡´ fatalErrorï¼Œè¿›è€Œå¯¼è‡´è¿æ¥å›æ”¶çš„ shrink æ–¹æ³•ä¸­æ‰€æœ‰é“¾æ¥éƒ½ä¼šè¢«æ”¾å…¥ keepAliveConnectionsï¼Œè¿›è€Œé€ æˆè¿æ¥æ± ä¸­æœ‰å¤šä¸ªç›¸åŒçš„ holderï¼›</li>
<li>timeBetweenEvictionRunsMillis å¤§äº keepAliveBetweenTimeMillisï¼Œå¯èƒ½å¯¼è‡´è·å–è¿æ¥æ—¶ï¼Œè¿æ¥ç©ºé—²æ—¶é—´åˆ¤æ–­é”™è¯¯ï¼Œæœ€ç»ˆå¯¼è‡´è¿æ¥ä¸èƒ½æ­£å¸¸å›æ”¶ï¼›</li>
<li>minEvictableIdleTimeMillis å°äº keepAliveBetweenTimeMillisï¼Œå¯èƒ½å¯¼è‡´è·å–è¿æ¥æ—¶ï¼Œè¿æ¥ç©ºé—²æ—¶é—´åˆ¤æ–­é”™è¯¯ï¼Œæœ€ç»ˆå¯¼è‡´è¿æ¥ä¸èƒ½æ­£å¸¸å›æ”¶ã€‚</li>
</ul>
<p> 
â€‹</p>
<h2 id="4-é—®é¢˜ä¿®å¤">4. é—®é¢˜ä¿®å¤ <a href="#4-%e9%97%ae%e9%a2%98%e4%bf%ae%e5%a4%8d" class="anchor">ğŸ”—</a></h2><p>é‚£è¿™ä¸ªé—®é¢˜å¦‚ä½•ä¿®å¤å‘¢ï¼Ÿåªè¦ä¿è¯ connections ä¸­ä¸èƒ½å­˜åœ¨ä¸¤ä¸ªå®Œå…¨ç›¸åŒçš„ holder å°±å¯ä»¥äº†ã€‚ç”±äºé—®é¢˜æ˜¯æœ‰ keepAlive æœºåˆ¶åœ¨æ”¾å›è¿æ¥æ—¶è§¦å‘çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ­¤åŠ ä¸ªåˆ¤æ–­ï¼Œå¦‚æœè¿æ¥å·²ç»å­˜åœ¨è¿æ¥æ± ä¸­ï¼Œå°±ä¸æ”¾å…¥ã€‚
â€‹</p>
<p>å®˜æ–¹åœ¨ 1.2.8 è¿™ä¸ªç‰ˆæœ¬ä¹Ÿä¿®å¤äº†è¯¥é—®é¢˜ï¼Œè¯¦ç»†ä¿®å¤ä»£ç å‚è€ƒ <a href="https://github.com/alibaba/druid/compare/1.2.5...1.2.8" target="_blank" rel="noopener">druid/compare/1.2.5&hellip;1.2.8</a> ã€‚
â€‹</p>
<p><p class="markdown-image">
  <img src="./images/druid-1.png" alt="image.png"  />
</p></p>
<p>å› æ­¤æˆ‘ä»¬åº”ç”¨ä¸­çš„ç»ˆæä¿®å¤æ–¹å¼å°±æ˜¯ï¼Œå°† Druid å‡çº§åˆ° 1.2.8ã€‚
â€‹</p>
<h2 id="5-æ€»ç»“">5. æ€»ç»“ <a href="#5-%e6%80%bb%e7%bb%93" class="anchor">ğŸ”—</a></h2><p>é€šè¿‡å¯¹æºç çš„ä¸€å±‚å±‚æ·±å…¥åˆ†æï¼Œç»ˆäºå¼„æ¸…æ¥šäº†ä¸ºä»€ä¹ˆä¼šåº”ç”¨æŠ¥é”™åä¼šä¸€ç›´æŒ‚èµ·ï¼Œä¸ºä»€ä¹ˆ activeCount ä¸å‡†ç¡®ï¼Œä»¥åŠå¦‚ä½•è§£å†³ã€‚
â€‹</p>
<p>è¡¨é¢ä¸Šçœ‹æ˜¯è·å–è¿æ¥è¶…æ—¶ï¼Œå®é™…ä¸Šæ—¶ activeCount è®¡ç®—ä¸å‡†ç¡®å¯¼è‡´æ— æ³•åˆ›å»ºå‡ºæ–°çš„è¿æ¥ã€‚
â€‹</p>
<p>å¯¼è‡´ activeCount è®¡ç®—ä¸å‡†ç¡®çš„åŸå› æ˜¯è¿æ¥æ± ä¸­å­˜åœ¨å¤šä¸ªç›¸åŒçš„è¿æ¥ï¼Œå› æ­¤è¿æ¥é‡Šæ”¾æ—¶ï¼Œå¤šæ¬¡é‡Šæ”¾ç›¸åŒè¿æ¥åªä¼šæ‰§è¡Œä¸€æ¬¡ activeCount&ndash;ã€‚
â€‹</p>
<p>ä¹‹æ‰€ä»¥è¿æ¥æ± å¯èƒ½å­˜åœ¨å¤šä¸ªç›¸åŒè¿æ¥ï¼Œä¸»è¦æ˜¯æ•°æ®åº“å¼‚å¸¸æˆ– Druid å‚æ•°é…ç½®æœ‰è¯¯æ—¶ï¼Œåˆšå¥½å¯¼è‡´ keepAlive å°†è¿æ¥é‡å¤æ”¾å…¥è¿æ¥æ± ã€‚å¹¶ä¸”å†æ¬¡è·å–è¯¥è¿æ¥æ—¶ï¼Œåˆšå¥½è¿æ¥ç©ºé—²æ—¶é—´åˆ¤æ–­é”™è¯¯ï¼Œå¯¼è‡´è¿æ¥ä¸è¢«é‡Šæ”¾è€Œæ˜¯è¿”å›ç»™äº†åº”ç”¨ä½¿ç”¨ã€‚
â€‹</p>
<p>æœ¬è´¨ä¸Šæ˜¯ Druid 1.2.8 ä¹‹å‰çš„ä¸€ä¸ª BUGï¼Œæ•°æ®åº“å¼‚å¸¸ä»¥åŠé…ç½®å¯¼è‡´çš„ç©ºé—²æ—¶é—´åˆ¤æ–­é”™è¯¯ç­‰ç§ç§å·§åˆï¼Œè§¦å‘äº†è¿™ä¸ª BUGã€‚ä½†å‡ºç°é—®é¢˜åé€šè¿‡é‡å¯åˆèƒ½è§£å†³é—®é¢˜ï¼Œæ‰€ä»¥å¾ˆéš¾å®šä½ã€‚</p>
<p>æœ€åï¼Œå°† Druid å‡çº§åˆ° 1.2.8 å§ï¼Œè¿™æ ·æ‰èƒ½å½»åº•è§£å†³é—®é¢˜ã€‚å¦å¤–ä¹Ÿéœ€è¦æ³¨æ„ä»¥ä¸‹ Druid é…ç½®ï¼š</p>
<ul>
<li>JDBC URL å¢åŠ  connectTimeout  å’Œ socketTimeout é…ç½®</li>
<li>è®¾ç½® maxWait</li>
<li>timeBetweenEvictionRunsMillis å°äº keepAliveBetweenTimeMillis</li>
<li>keepAliveBetweenTimeMillis å°äº minEvictableIdleTimeMillis</li>
</ul>
<p>â€‹</p>
<p>è‡³æ­¤ï¼Œæœ¬æ–‡ç»“æŸã€‚æ„Ÿè°¢é˜…è¯»ï¼</p>
<h2 id="å‚è€ƒ">å‚è€ƒ <a href="#%e5%8f%82%e8%80%83" class="anchor">ğŸ”—</a></h2><ul>
<li><a href="https://github.com/alibaba/druid" target="_blank" rel="noopener">https://github.com/alibaba/druid</a></li>
<li><a href="https://github.com/alibaba/druid/compare/1.2.5...1.2.8" target="_blank" rel="noopener">https://github.com/alibaba/druid/compare/1.2.5&hellip;1.2.8</a></li>
<li><a href="https://github.com/alibaba/druid/releases/tag/1.2.8" target="_blank" rel="noopener">https://github.com/alibaba/druid/releases/tag/1.2.8</a></li>
<li><a href="https://github.com/alibaba/druid/issues/4316" target="_blank" rel="noopener">https://github.com/alibaba/druid/issues/4316</a></li>
<li><a href="https://github.com/alibaba/druid/issues/4438" target="_blank" rel="noopener">https://github.com/alibaba/druid/issues/4438</a></li>
</ul>

    </div>

    
        <div class="tags">
            
                <a href="https://nodejh.com/tags/java">Java</a>
            
        </div>
    
    
    
  <div id="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nodejh" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>


</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/nodejh" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://stackoverflow.com/users/4518882/nodejh" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>stackoverflow</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-488.000000, -1163.000000)">
            <g id="stackoverflow" transform="translate(488.000000, 1163.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M42.0860128,53.5922927 L22.9745951,53.6011499 L22.9729497,49.5538824 L42.0835447,49.5440929 L42.0860128,53.5922927 L42.0860128,53.5922927 Z M55,30.6708298 L51.7306912,12 L47.7087256,12.6920259 L50.9775643,31.3628557 L55,30.6708298 L55,30.6708298 Z M42.5455518,44.3547147 L23.5156994,42.616026 L23.1410164,46.6470941 L42.1712214,48.3841513 L42.5455518,44.3547147 L42.5455518,44.3547147 Z M43.8009984,39.0731519 L25.3459811,34.1539179 L24.285633,38.0621508 L42.7419431,42.9819676 L43.8009984,39.0731519 L43.8009984,39.0731519 Z M46.2103463,34.4436411 L29.7494464,24.8164635 L27.6748215,28.3015328 L44.1365441,37.9292931 L46.2103463,34.4436411 L46.2103463,34.4436411 Z M50.2466504,31.6088756 L46.8745036,33.8883189 L36.106599,18.2318456 L39.4792159,15.9517031 L50.2466504,31.6088756 Z M45.3315807,40.2784283 L48.5799693,40.2784283 L48.5799693,60 L17,60 L17,40.2784283 L20.2648427,40.2784283 L20.2648427,56.8243495 L45.3315807,56.8243495 L45.3315807,40.2784283 Z" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/nodejh" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       Â© Copyright 
       2021 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Hang Jiang
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>



  </body>
</html>
