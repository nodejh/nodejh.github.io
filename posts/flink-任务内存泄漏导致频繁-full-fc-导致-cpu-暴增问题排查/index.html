<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <title>Flink ä»»åŠ¡å†…å­˜æ³„æ¼å¯¼è‡´é¢‘ç¹ Full FC å¯¼è‡´ CPU æš´å¢é—®é¢˜æ’æŸ¥ | Hang Jiang</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="æœ€è¿‘å‘ç°éƒ¨ç½²åœ¨ k8s ä¸Šçš„ Flink æ¯è¿è¡Œåå‡ ä¸ªå°æ—¶å°±ä¼šå¡ä½ï¼Œå¯¼è‡´æ¶ˆè´¹å»¶è¿Ÿã€ä¸Šæ¸¸æ•°æ®ç§¯å‹ã€‚æ¶ˆè´¹å»¶è¿Ÿè¾ƒé•¿æ—¶é—´åï¼ˆæ—¶é—´ä¸å›ºå®šï¼Œå¯èƒ½åå‡ åˆ†é’Ÿï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€å°æ—¶ï¼‰ï¼Œ">
<meta name="generator" content="Hugo 0.82.0" />


  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84989670-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>é¦–é¡µ</a>
	
	<a href="/posts">å½’æ¡£</a>
	<a href="/tags">æ ‡ç­¾</a>
	<a href="/about">å…³äº</a>

	

	
	  <a class="button" href="https://nodejh.com/index.xml">è®¢é˜…</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Flink ä»»åŠ¡å†…å­˜æ³„æ¼å¯¼è‡´é¢‘ç¹ Full FC å¯¼è‡´ CPU æš´å¢é—®é¢˜æ’æŸ¥</h1>

    <div class="tip">
        <span>
          Jul 30, 2021 17:00
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          
            4715 words
          
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          10 minute read
        </span>
    </div>

    
    


    <div class="content">
      <p>æœ€è¿‘å‘ç°éƒ¨ç½²åœ¨ k8s ä¸Šçš„ Flink æ¯è¿è¡Œåå‡ ä¸ªå°æ—¶å°±ä¼šå¡ä½ï¼Œå¯¼è‡´æ¶ˆè´¹å»¶è¿Ÿã€ä¸Šæ¸¸æ•°æ®ç§¯å‹ã€‚æ¶ˆè´¹å»¶è¿Ÿè¾ƒé•¿æ—¶é—´åï¼ˆæ—¶é—´ä¸å›ºå®šï¼Œå¯èƒ½åå‡ åˆ†é’Ÿï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€å°æ—¶ï¼‰ï¼Œåˆé€æ¸æ¢å¤æ­£å¸¸ã€‚</p>
<p>åœ¨æ­¤åˆ†äº«ä¸€ä¸‹æ’æŸ¥è¿‡ç¨‹ã€‚
â€‹</p>
<h2 id="ç°è±¡">ç°è±¡ <a href="#%e7%8e%b0%e8%b1%a1" class="anchor">ğŸ”—</a></h2><p>â€‹</p>
<p>å‡ºé—®é¢˜çš„ç›´æ¥ç°è±¡å°±æ˜¯æ¶ˆè´¹å»¶è¿Ÿï¼Œæ•°æ®ç§¯å‹ã€‚</p>
<p>åŒæ—¶è§‚å¯Ÿåˆ°ï¼Œå‘ç”Ÿæ¶ˆè´¹å»¶è¿Ÿæ—¶ï¼ŒPod çš„ CPU åˆ©ç”¨ç‡å‡ ä¹æ˜¯ 100%ï¼Œå†…å­˜ä½¿ç”¨ç‡ç›¸å¯¹ç¨³å®šã€ç½‘ç»œ IO ä¹Ÿæ— æ˜æ˜¾å˜åŒ–ã€‚</p>
<p>å¹¶ä¸”å‡ ä¹æ¯æ¬¡éƒ½æ˜¯å•ä¸ª Pod CPU åˆ©ç”¨ç‡ 100%ï¼Œå…¶ä»– Pod æ¯”è¾ƒæ­£å¸¸ã€‚</p>
<p><p class="markdown-image">
  <img src="./images/flink-memory-leak-full-gc-cpu-monitor.png" alt="CPUä½¿ç”¨ç‡100%"  />
</p>
â€‹</p>
<p>äºæ˜¯é¦–å…ˆå°±é¢ä¸´ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ä¸ºä»€ä¹ˆå•ä¸ª Pod CPU 100% ä¼šå¯¼è‡´æ•´ä¸ª Flink ä»»åŠ¡æ¶ˆè´¹å»¶è¿Ÿï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆé€šå¸¸å»¶è¿Ÿä¸€æ®µæ—¶é—´ä¼šæ¢å¤ï¼Ÿ</li>
<li>æ˜¯å¦ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Ÿ</li>
</ul>
<p>â€‹</p>
<p>æ¥ä¸‹æ¥å°±å¯¹ä¸Šè¿°ä¸‰ä¸ªé—®é¢˜è¿›è¡Œåˆæ­¥åˆ†æã€‚
â€‹</p>
<h2 id="åˆæ­¥åˆ†æ">åˆæ­¥åˆ†æ <a href="#%e5%88%9d%e6%ad%a5%e5%88%86%e6%9e%90" class="anchor">ğŸ”—</a></h2><p>â€‹</p>
<h3 id="ä¸ºä»€ä¹ˆå•ä¸ª-pod-cpu-100-ä¼šå¯¼è‡´æ•´ä¸ª-flink-ä»»åŠ¡æ¶ˆè´¹å»¶è¿Ÿ">ä¸ºä»€ä¹ˆå•ä¸ª Pod CPU 100% ä¼šå¯¼è‡´æ•´ä¸ª Flink ä»»åŠ¡æ¶ˆè´¹å»¶è¿Ÿï¼Ÿ <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8d%95%e4%b8%aa-pod-cpu-100-%e4%bc%9a%e5%af%bc%e8%87%b4%e6%95%b4%e4%b8%aa-flink-%e4%bb%bb%e5%8a%a1%e6%b6%88%e8%b4%b9%e5%bb%b6%e8%bf%9f" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>é€šå¸¸ Flink ä»»åŠ¡å‡ºç°æ¶ˆè´¹å»¶è¿Ÿï¼Œç›´æ¥åŸå› å°±æ˜¯åå‹ï¼Œåå‹å¯¼è‡´ Source ä¸å†æ¶ˆè´¹æ•°æ®ã€‚ æ‰€ä»¥æŸ¥çœ‹äº† Flink ä»»åŠ¡ï¼Œå‘ç°ç¡®å®æœ‰åå‹ã€‚å¹¶ä¸”é€ æˆåå‹çš„ SubTask å¯¹åº”çš„ Pod å°±æ˜¯ CPU ä½¿ç”¨ç‡å¾ˆé«˜çš„ Podã€‚</p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œé€ æˆä¸Šæ¸¸åå‹çš„ä¸»è¦æ˜¯ windowGroupStream çš„ SubTask 1ã€‚
<p class="markdown-image">
  <img src="./images/flink-memory-leak-full-gc-cpu-backpressure.png" alt="åå‹"  />
</p></p>
<p>â€‹</p>
<p>è™½ç„¶æ˜¯éƒ¨ç½²åœ¨ k8s ä¸Šï¼Œæœ‰å¤šä¸ª Pod åœ¨åŒæ—¶å¤„ç†æ•°æ®ï¼Œä½†åœ¨ Flink æ¶æ„ä¸­ï¼ŒPod åªæ˜¯å…¶çš„è®¡ç®—èµ„æºï¼ŒFlink ä¼šç»Ÿä¸€è°ƒåº¦è®¡ç®—èµ„æºã€‚å½“æŸä¸ª Pod CPU åˆ©ç”¨ç‡ 100% æ—¶ï¼Œè¯¥ Pod ä¸Šè¿è¡Œçš„ Task å°±ä¼šå˜æ…¢ï¼Œç”šè‡³æ²¡æœ‰ CPU å¯ç”¨ã€‚
â€‹</p>
<p>å½“ä»»åŠ¡å­˜ä½¿ç”¨äº† keyBy ç®—å­æ—¶ï¼Œç›¸åŒ key çš„æ•°æ®ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ª Task å¤„ç†ã€‚æ‰€ä»¥å½“ key æ²¡æœ‰å‡åŒ€åˆ†å¸ƒæ—¶ï¼Œå°±å¯èƒ½å¯¼è‡´å¤§é‡æ•°æ®é›†ä¸­åœ¨æŸä¸ª Taskï¼Œè€Œå…¶ä»– Task æ¯”è¾ƒç©ºé—²ã€‚æœ€ç»ˆç”±äºè¯¥ Task çš„ CPU èµ„æºä¸è¶³ä¸”æ•°æ®æ— æ³•è¢«å…¶ä»– Task å¤„ç†ï¼Œå¯¼è‡´ä¸Šæ¸¸åå‹ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªä»»åŠ¡æ¶ˆè´¹å»¶è¿Ÿã€‚
â€‹</p>
<p>æ°å¥½æˆ‘ä»¬çš„ Flink ä»»åŠ¡å°±ä½¿ç”¨äº† keyBy ç®—å­ã€‚æ‰€ä»¥è¿™æ˜¯é€ æˆå•ä¸ª Pod CPU ä½¿ç”¨ç‡å¾ˆé«˜çš„åŸå› ä¹‹ä¸€ã€‚</p>
<p>æ­¤å¤–ä¹Ÿå¯èƒ½æ˜¯åˆ†é…åˆ°è¯¥ Pod ä¸Šçš„æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œè§¦å‘äº†æŸä¸ª BUGï¼Œå¯¼è‡´è¯¥ Pod CPU ä½¿ç”¨ç‡éå¸¸é«˜ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆæ¶ˆè´¹å»¶è¿Ÿä¸€æ®µæ—¶é—´åä¼šæ¢å¤">ä¸ºä»€ä¹ˆæ¶ˆè´¹å»¶è¿Ÿä¸€æ®µæ—¶é—´åä¼šæ¢å¤ï¼Ÿ <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%b6%88%e8%b4%b9%e5%bb%b6%e8%bf%9f%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%e4%bc%9a%e6%81%a2%e5%a4%8d" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>åå‹é€šå¸¸è¿˜ä¼šå¸¦æ¥å¦ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ checkpoint å˜æ…¢ã€‚
â€‹</p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œcheckpoint çš„æ—¶é—´ä¸è¶…è¿‡ 1sï¼Œä½†å‡ºç°åå‹æ—¶ï¼Œcheckpoint è€—æ—¶è¾¾åˆ°æ•°åˆ†é’Ÿï¼Œç”šè‡³è¶…æ—¶ã€‚
â€‹</p>
<p><p class="markdown-image">
  <img src="./images/flink-memory-leak-full-gc-cpu-checkpoint.png" alt="checkpoint"  />
</p></p>
<p>Flink åœ¨è¿›è¡Œ checkpoint æ—¶ï¼ŒCheckpoint Coordinator ä¼šå‘ source å’Œæ‰€æœ‰ç®—å­ä»¥åŠ sink å‘é€ barrierï¼Œæ¯ä¸ªç®—å­æ¥æ”¶åˆ°äº† barrier åï¼Œä¼šæš‚åœæ•°æ®å¤„ç†ï¼Œç”Ÿæˆè‡ªèº«çŠ¶æ€å¿«ç…§å¹¶ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­ï¼Œç„¶åå°†æ•°æ®åœ°å€ï¼ˆstate handleï¼‰å‘é€ç»™ Checkpoint Coordinatorã€‚å½“ Checkpoint Coordinator æ”¶é›†åˆ°æ‰€æœ‰ç®—å­çš„ state handle åï¼Œå°±è®¤ä¸ºæ­¤æ¬¡ checkpoint å®Œæˆäº†ï¼Œç„¶åå†æŒä¹…åŒ–å­˜å‚¨ä¿å­˜ä¸€ä»½ checkpoint meta æ–‡ä»¶ã€‚</p>
<p>æ‰€ä»¥åªè¦æŸä¸ªç®—å­çš„ checkpoint å˜æ…¢ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ª checkpoint å˜æ…¢ï¼Œç”šè‡³é€ æˆ checkpoint è¶…æ—¶ã€‚
â€‹</p>
<p>Flink çš„ checkpoint æœ‰å¾ˆå¤š<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/deployment/config/#checkpointing" target="_blank" rel="noopener">é…ç½®</a>ï¼Œè¿™é‡Œä¸»è¦é’ˆå¯¹å…¶ä¸­ä¸¤ä¸ªè¿›è¡Œè¯´æ˜ï¼š</p>
<ul>
<li><code>execution.checkpointing.timeout</code>  checkpoint è¶…æ—¶æ—¶é—´</li>
<li><code>execution.checkpointing.tolerable-failed-checkpoints</code> å¯å®¹å¿çš„ checkpoint å¤±è´¥æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 0</li>
</ul>
<p>é™¤äº†åœ¨ flink-conf.yaml ä¸­é…ç½®ï¼Œè¿˜å¯ä»¥åœ¨ä»£ç ä¸­æŒ‡å®šï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#080;font-style:italic">// è®¾ç½® checkpoint è¶…æ—¶æ—¶é—´ä¸º 5 åˆ†é’Ÿ
</span><span style="color:#080;font-style:italic"></span>env<span style="color:#666">.</span><span style="color:#b44">getCheckpointConfig</span><span style="color:#666">().</span><span style="color:#b44">setCheckpointTimeout</span><span style="color:#666">(</span>1000 <span style="color:#666">*</span> 60 <span style="color:#666">*</span> 5<span style="color:#666">);</span>
<span style="color:#080;font-style:italic">// è®¾ç½®å¯å®¹å¿çš„ checkpoint å¤±è´¥æ¬¡æ•°ä¸º 0
</span><span style="color:#080;font-style:italic"></span>env<span style="color:#666">.</span><span style="color:#b44">getCheckpointConfig</span><span style="color:#666">().</span><span style="color:#b44">setTolerableCheckpointFailureNumber</span><span style="color:#666">(</span>0<span style="color:#666">);</span>
</code></pre></div><p>â€‹</p>
<p>æŒ‰ç…§ä¸Šé¢çš„é…ç½®ï¼Œå¦‚æœ checkpoint 5 åˆ†é’Ÿè¿˜æœªå®Œæˆï¼Œåˆ™ checkpoint ä¼šå¤±è´¥ã€‚åŒæ—¶ç”±äºå¯å®¹å¿çš„å¤±è´¥æ¬¡æ•°ä¸º 0ï¼Œæ‰€ä»¥ä¸€æ—¦ checkpoint å¤±è´¥ï¼Œæ•´ä¸ªä»»åŠ¡å°±ä¼šå¤±è´¥ä¸”åœæ­¢ã€‚
â€‹</p>
<p>ç”±äºæˆ‘ä»¬çš„ Flink ä»»åŠ¡æ˜¯éƒ¨ç½²åœ¨ k8s ä¸Šï¼Œä¸”é…ç½®äº†é«˜å¯ç”¨ï¼Œæ‰€ä»¥ä»»åŠ¡å¤±è´¥åï¼Œåˆä¼šè‡ªåŠ¨é‡å¯ï¼Œå› æ­¤æ¶ˆè´¹å»¶è¿Ÿä¸€æ®µæ—¶é—´åä¼šè‡ªåŠ¨æ¢å¤ã€‚
â€‹</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äº Pod CPU é•¿æœŸå¤„äº 100% ç”šè‡³è¶…è¿‡ 100%ï¼Œç”±äº Pod ä¹Ÿè®¾ç½®äº† cpu limitï¼Œå¦‚ä¸‹ï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">limits</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">cpu</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">memory</span>:<span style="color:#bbb"> </span>10Gi<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">requests</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">cpu</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">memory</span>:<span style="color:#bbb"> </span>10Gi<span style="color:#bbb">
</span></code></pre></div><p>æ‰€ä»¥å½“ Pod CPU éå¸¸é«˜æ—¶ï¼ŒPod ä¹Ÿå¯èƒ½è¢« k8s é‡å¯ã€‚è§‚å¯Ÿ Pod çš„é‡å¯æ¬¡æ•°ä¸ä¸º 0ï¼Œä¹Ÿå°è¯äº†æ­¤çŒœæµ‹ã€‚å¯¹äºéƒ¨ç½² k8s çš„ Flink ä»»åŠ¡ï¼Œå½“ Pod é‡å¯åï¼Œæ•´ä¸ª flink ä»»åŠ¡ä¹Ÿä¼šé‡å¯ã€‚
â€‹</p>
<p><p class="markdown-image">
  <img src="./images/flink-memory-leak-full-gc-cpu-pod.png" alt="Pod"  />
</p>
â€‹</p>
<p>æ‰€ä»¥æ¶ˆè´¹å»¶è¿Ÿä¸€æ®µæ—¶é—´åä¼šè‡ªåŠ¨æ¢å¤ï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªåŸå› ï¼š</p>
<ul>
<li>checkpoint è¶…æ—¶å¯¼è‡´ä»»åŠ¡é‡å¯</li>
<li>Pod CPU è¶…è¿‡ limit é™åˆ¶ï¼Œå¯¼è‡´ Pod é‡å¯ï¼Œè¿›è€Œå¯¼è‡´ä»»åŠ¡é‡å¯</li>
</ul>
<p>â€‹</p>
<p>è™½ç„¶ä»»åŠ¡ä¼šè‡ªåŠ¨æ¢å¤ï¼Œä½†æ¶ˆè´¹å»¶è¿Ÿå¯èƒ½æ˜¯å°æ—¶çº§åˆ«çš„ï¼Œæ˜æ˜¾ä¸å¯å®¹å¿ã€‚è¿˜æ˜¯å¾—æ‰¾åˆ°æ ¹æœ¬åŸå› ã€‚
â€‹</p>
<p>åœ¨è¿›ä¸€æ­¥å®šä½å‰ï¼Œå¦ä¸€ä¸ªéå¸¸å…³å¿ƒçš„é—®é¢˜å°±æ˜¯ï¼Œæ˜¯å¦ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Ÿ
â€‹</p>
<h3 id="æ˜¯å¦ä¼šé€ æˆæ•°æ®ä¸¢å¤±">æ˜¯å¦ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Ÿ <a href="#%e6%98%af%e5%90%a6%e4%bc%9a%e9%80%a0%e6%88%90%e6%95%b0%e6%8d%ae%e4%b8%a2%e5%a4%b1" class="anchor">ğŸ”—</a></h3><p>åœ¨å°†ä»»åŠ¡éƒ¨ç½²åˆ° k8s ä¸Šæ—¶ï¼Œæˆ‘ä»¬å¼€å¯äº† flink çš„ checkpoint æœºåˆ¶ï¼Œå¹¶ä¸”å°† checkpoint æŒä¹…åŒ–ä¿å­˜åˆ°äº† NAS ä¸­ï¼Œæ‰€ä»¥ä»»åŠ¡å¼‚å¸¸ä¸ä¼šå¯¼è‡´ checkpoint çŠ¶æ€ä¸¢å¤±ã€‚å½“ä»»åŠ¡é‡å¯æ—¶ï¼ŒFlink ä¼šä» NAS ä¸­è¯»å–ä¸Šæ¬¡ checkpoint è¿›è¡Œæ¢å¤ã€‚
â€‹</p>
<p>æ‰€ä»¥ä»»åŠ¡é‡å¯ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œä½†ä¼šé€ æˆæ•°æ®é‡å¤ã€‚
â€‹</p>
<p>æ‰€ä»¥å½“è¿˜æ‰¾åˆ°æ ¹æœ¬åŸå› æ˜¯ï¼Œè§£å†³åŠæ³•å°±æ˜¯ï¼Œå‡ºç°æ¶ˆè´¹å»¶è¿ŸæŠ¥è­¦æ—¶ï¼Œå°±åŠæ—¶é‡å¯ä»»åŠ¡ã€‚
â€‹</p>
<p>è¿™é‡Œåœ¨è¡¥å……ä¸€äº›å…³äº Flink on k8s çš„ä¿¡æ¯ã€‚æˆ‘ä»¬çš„ Flink ä»»åŠ¡éƒ¨ç½²åˆ° k8s ä¸Šæ—¶ï¼Œä½¿ç”¨äº† Flink çš„ <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/deployment/elastic_scaling/" target="_blank" rel="noopener">Elastic Scaling</a> æ¨¡å¼ï¼Œå¹¶åŸºäº k8s çš„ hpa  å®ç°äº†å¼¹æ€§ä¼¸ç¼©ã€‚å½“ä»»åŠ¡çš„ CPU ä½¿ç”¨ç‡è¾ƒé«˜æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨æ‰©å®¹ã€‚
â€‹</p>
<p>é‚£ä¸ºä»€ä¹ˆ Pod çš„ CPU åˆ° 100% äº†ï¼Œéƒ½æ²¡æœ‰è‡ªåŠ¨æ‰©å®¹å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæ¯æ¬¡æ¶ˆè´¹å»¶è¿Ÿï¼Œåªæœ‰ä¸ªåˆ« Pod CPU ä½¿ç”¨ç‡éå¸¸é«˜ï¼Œå…¶ä»– Pod CPU ä½¿ç”¨ç‡éƒ½éå¸¸ä½ï¼Œæ‰€ä»¥æ•´ä½“çš„ CPU ä½¿ç”¨ç‡æ²¡æœ‰è¾¾åˆ°æ‰©å®¹é˜ˆå€¼ï¼Œæ‰€ä»¥æ²¡æœ‰è‡ªåŠ¨æ‰©å®¹ã€‚</p>
<h2 id="åŸå› å®šä½">åŸå› å®šä½ <a href="#%e5%8e%9f%e5%9b%a0%e5%ae%9a%e4%bd%8d" class="anchor">ğŸ”—</a></h2><p>è™½ç„¶ç»è¿‡åˆæ­¥åˆ†æï¼Œå¤§æ¦‚äº†è§£äº†æ•´ä½“æƒ…å†µï¼Œä½†å¹¶æ²¡æœ‰æ‰¾åˆ°æ ¹æœ¬åŸå› ã€‚</p>
<p>è¦æ‰¾åˆ°æ ¹æœ¬åŸå› ï¼Œå°±éœ€è¦åœ¨å‡ºç°é—®é¢˜çš„é‚£ä¸€åˆ»è§‚å¯Ÿ Flink ä»»åŠ¡çš„å„ç§æŒ‡æ ‡ï¼Œæ¯”å¦‚çº¿ç¨‹çš„ CPU ä½¿ç”¨ç‡ã€å†…å­˜æ¶ˆè€—ã€GC æƒ…å†µç­‰ç­‰ã€‚
â€‹</p>
<p>â€‹</p>
<p>æ‰€ä»¥ä¸ºäº†å¾—åˆ°æ›´å¤šä¿¡æ¯ï¼Œå°±éœ€è¦æ‰“å°æ›´å¤šæ—¥å¿—ã€‚åœ¨ Flink çš„ flink-conf.yaml é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code>env.java.opts</code> é…ç½® JVM å‚æ•°ï¼Œè¯¦è§ <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/ops/debugging/application_profiling/" target="_blank" rel="noopener">Application Profiling &amp; Debugging </a>ã€‚
â€‹</p>
<p>äºæ˜¯åœ¨ flink-conf.yaml  ä¸­å¢åŠ äº†å¦‚ä¸‹é…ç½®ï¼Œæ‰“å° GC æ—¥å¿—ï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">env.java.opts</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;-Xloggc:/opt/flink/log/gc.log -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=10M -XX:+PrintPromotionFailure -XX:+PrintGCCause -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/flink/log/heap.hprof&#34;</span><span style="color:#bbb">
</span></code></pre></div><ul>
<li><code>-Xloggc:/opt/flink/log/gc.log</code>  GC æ—¥å¿—çš„å­˜å‚¨ä½ç½®</li>
<li><code>-XX:PrintGCApplicationStoppedTime</code> è¾“å‡º GC æ—¶åº”ç”¨æš‚åœæ—¶é—´</li>
<li><code>-XX:+PrintGCDetails</code> è¾“å‡º GC çš„è¯¦ç»†æ—¥å¿—</li>
<li><code>+PrintGCDateStamps</code> è¾“å‡º GC çš„æ—¥æœŸæ—¶é—´ï¼Œæ ¼å¼ä¸º 2021-07-28T18:38:44.743+0800</li>
<li><code>-XX:+UseGCLogFileRotation</code> å¼€å¯æ—¥å¿—æ–‡ä»¶åˆ†å‰²</li>
<li><code>-XX:NumberOfGCLogFiles:NumberOfGCLogFiles</code> æœ€å¤šåˆ†å‰²å‡ ä¸ª GC æ—¥å¿—æ–‡ä»¶</li>
<li><code>-XX:GCLogFileSize=10M</code> æ¯ä¸ªæ—¥å¿—æ–‡ä»¶ä¸Šé™å¤§å°ï¼Œè¶…è¿‡å°±ä¼šè§¦å‘åˆ†å‰²</li>
<li><code>-XX:+PrintPromotionFailure</code> è¾“å‡ºå¯¼è‡´ GC çš„åŸå› </li>
<li><code>-XX:+HeapDumpOnOutOfMemoryError</code> å‘ç”Ÿå†…å­˜æ³„æ¼æ—¶ï¼Œè‡ªåŠ¨æ‰“å° heapdump æ–‡ä»¶</li>
<li><code>-XX:HeapDumpPath=/opt/flink/log/heap.hprof</code> heapdump æ–‡ä»¶è·¯å¾„</li>
</ul>
<p>â€‹</p>
<p>ç„¶åé‡å¯åº”ç”¨ï¼ŒæŒç»­è§‚å¯Ÿï¼Œä¸€ç›´åˆ°æŸä¸ª Pod å†æ¬¡å‡ºç°å¼‚å¸¸ã€‚
â€‹</p>
<p>åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œç»ˆäºç­‰åˆ°äº†åå‡ ä¸ªå°æ—¶åï¼ŒæŸä¸ª Pod CPU å†æ¬¡æ¥è¿‘ 100%ï¼Œèµ¶ç´§ç™»å½•ä¸Šå»æŸ¥çœ‹å„ç§è¿è¡Œæ—¶ä¿¡æ¯ã€‚
â€‹</p>
<h3 id="åˆ†æ-java-è¿›ç¨‹åŠçº¿ç¨‹çš„-cpu-ä½¿ç”¨ç‡">åˆ†æ Java è¿›ç¨‹åŠçº¿ç¨‹çš„ CPU ä½¿ç”¨ç‡ <a href="#%e5%88%86%e6%9e%90-java-%e8%bf%9b%e7%a8%8b%e5%8f%8a%e7%ba%bf%e7%a8%8b%e7%9a%84-cpu-%e4%bd%bf%e7%94%a8%e7%8e%87" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>ç”±äºè§‚å¯Ÿåˆ°çš„ç°è±¡æ˜¯ CPU ä½¿ç”¨ç‡ 100%ï¼Œæ‰€ä»¥ç¬¬ä¸€ååº”æ˜¯æŸ¥çœ‹è¿›ç¨‹åŠçº¿ç¨‹çš„ CPU æƒ…å†µã€‚
â€‹</p>
<h4 id="ç¡®å®šè¿›ç¨‹-id">ç¡®å®šè¿›ç¨‹ ID <a href="#%e7%a1%ae%e5%ae%9a%e8%bf%9b%e7%a8%8b-id" class="anchor">ğŸ”—</a></h4><p>é¦–å…ˆé€šè¿‡ <code>ps</code> å‘½ä»¤ç¡®å®šè¿›ç¨‹ IDï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ps -auxwww
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
flink          <span style="color:#666">1</span> 98.8 14.4 <span style="color:#666">24410376</span> <span style="color:#666">9317060</span> ?    Ssl  Jul28 1639:33 /usr/local/openjdk-8/bin/java -Xmx4563402682 -Xms4563402682 -XX:MaxDirectMemorySize<span style="color:#666">=</span><span style="color:#666">1073741838</span> -XX:MaxMetaspaceSize<span style="color:#666">=</span><span style="color:#666">268435456</span> -Xloggc:/opt/flink/log/gc.log 
flink    <span style="color:#666">1072789</span>  0.0  0.0   <span style="color:#666">5752</span>  <span style="color:#666">3656</span> pts/0    Ss   14:36   0:00 bash
flink    <span style="color:#666">1072902</span>  0.0  0.0   <span style="color:#666">9392</span>  <span style="color:#666">3008</span> pts/0    R+   14:36   0:00 ps -auxwww
</code></pre></div><p>â€‹</p>
<p>å¯ä»¥çœ‹åˆ° PID ä¸º 1 çš„è¿›ç¨‹å°±æ˜¯ flink ä»»åŠ¡çš„è¿›ç¨‹ã€‚</p>
<h4 id="æŸ¥çœ‹çº¿ç¨‹-cpu-ä½¿ç”¨ç‡">æŸ¥çœ‹çº¿ç¨‹ CPU ä½¿ç”¨ç‡ <a href="#%e6%9f%a5%e7%9c%8b%e7%ba%bf%e7%a8%8b-cpu-%e4%bd%bf%e7%94%a8%e7%8e%87" class="anchor">ğŸ”—</a></h4><p>ç„¶åæŸ¥çœ‹è¿›ç¨‹ä¸­å„ä¸ªçº¿ç¨‹çš„ CPU ä½¿ç”¨ç‡ã€‚
â€‹</p>
<p>ä½¿ç”¨ top æˆ– ps å‘½ä»¤å‡å¯ï¼š
â€‹</p>
<ul>
<li><code>top -H -p 1</code></li>
<li>â€‹<code>ps H -eo user,pid,ppid,tid,time,%cpu,cmd,psr,fname --sort=%cpu | grep 1</code></li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ps H -eo user,pid,ppid,tid,time,%cpu,cmd,psr,fname --sort<span style="color:#666">=</span>%cpu | grep <span style="color:#666">1</span>
......
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10928</span> 00:00:02  0.3 /usr/local/openjdk-8/bin/ja   <span style="color:#666">1</span> Consumer
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10936</span> 00:00:04  0.4 /usr/local/openjdk-8/bin/ja   <span style="color:#666">6</span> async wa
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10894</span> 00:00:04  0.5 /usr/local/openjdk-8/bin/ja   <span style="color:#666">4</span> Legacy S
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10932</span> 00:00:23  2.5 /usr/local/openjdk-8/bin/ja   <span style="color:#666">1</span> windowGr
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10942</span> 00:00:45  2.8 /usr/local/openjdk-8/bin/ja   <span style="color:#666">0</span> async wa
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>     <span style="color:#666">263</span> 00:32:41  9.3 /usr/local/openjdk-8/bin/ja   <span style="color:#666">4</span> java
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>     <span style="color:#666">264</span> 00:32:42  9.3 /usr/local/openjdk-8/bin/ja   <span style="color:#666">0</span> java
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>     <span style="color:#666">265</span> 00:32:32  9.4 /usr/local/openjdk-8/bin/ja   <span style="color:#666">1</span> java
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>     <span style="color:#666">266</span> 00:32:33  9.4 /usr/local/openjdk-8/bin/ja   <span style="color:#666">3</span> java
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10935</span> 00:03:18 15.0 /usr/local/openjdk-8/bin/ja   <span style="color:#666">1</span> windowGr
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10883</span> 00:03:20 21.3 /usr/local/openjdk-8/bin/ja   <span style="color:#666">5</span> FastLogT
flink          <span style="color:#666">1</span>       <span style="color:#666">0</span>   <span style="color:#666">10885</span> 00:03:27 22.0 /usr/local/openjdk-8/bin/ja   <span style="color:#666">3</span> FastLogT
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹ 10885 ã€10883ã€10935 ä»¥åŠ 263ã€264ã€265ã€266 çš„ CPU ä½¿ç”¨ç‡éå¸¸é«˜ã€‚æ ¹æ®çº¿ç¨‹åç§°å¯ä»¥ç¡®å®šï¼Œå‰é¢å‡ ä¸ªçº¿ç¨‹éƒ½æ˜¯ä¸šåŠ¡ä»£ç ï¼Œå…¶ä¸­æœ‰å¤§é‡è®¡ç®—é€»è¾‘ï¼ŒCPU ä½¿ç”¨ç‡é«˜åº”è¯¥æ˜¯æ­£å¸¸çš„ã€‚è€Œ 265 å’Œ 266 å°šä¸ç¡®å®šï¼Œæ‰€ä»¥ç»§ç»­æŸ¥çœ‹çº¿ç¨‹æ ˆã€‚
â€‹</p>
<h4 id="æŸ¥çœ‹çº¿ç¨‹æ ˆ">æŸ¥çœ‹çº¿ç¨‹æ ˆ <a href="#%e6%9f%a5%e7%9c%8b%e7%ba%bf%e7%a8%8b%e6%a0%88" class="anchor">ğŸ”—</a></h4><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ jstack å‘½ä»¤æ‰“å°çº¿ç¨‹æ ˆã€‚ç”±äºçº¿ç¨‹æ ˆå†…å®¹éå¸¸å¤šï¼Œæ‰€ä»¥æœ€å¥½é€šè¿‡ grep è¿‡æ»¤å‡ºå…·ä½“çº¿ç¨‹çš„çº¿ç¨‹æ ˆã€‚</p>
<p>é¦–å…ˆå°†çº¿ç¨‹ ID è½¬æ¢ä¸º 16 è¿›åˆ¶ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#a2f">printf</span> <span style="color:#b44">&#34;%x\n&#34;</span> <span style="color:#666">265</span>
<span style="color:#666">109</span>
$ <span style="color:#a2f">printf</span> <span style="color:#b44">&#34;%x\n&#34;</span> <span style="color:#666">266</span>
10a
</code></pre></div><p>â€‹</p>
<p>ä»¥ 266 çº¿ç¨‹ä¸ºä¾‹ï¼Œé€šè¿‡ jstack æŸ¥çœ‹çº¿ç¨‹æ ˆï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ jstack <span style="color:#666">1</span> | grep 0x10a -C <span style="color:#666">10</span>
	at org.apache.flink.runtime.taskexecutor.TaskManagerRunner.main<span style="color:#666">(</span>TaskManagerRunner.java:354<span style="color:#666">)</span>

<span style="color:#b44">&#34;VM Thread&#34;</span> <span style="color:#b8860b">os_prio</span><span style="color:#666">=</span><span style="color:#666">0</span> <span style="color:#b8860b">tid</span><span style="color:#666">=</span>0x00007f01a645c800 <span style="color:#b8860b">nid</span><span style="color:#666">=</span>0x10b runnable

<span style="color:#b44">&#34;GC task thread#0 (ParallelGC)&#34;</span> <span style="color:#b8860b">os_prio</span><span style="color:#666">=</span><span style="color:#666">0</span> <span style="color:#b8860b">tid</span><span style="color:#666">=</span>0x00007f01a6458000 <span style="color:#b8860b">nid</span><span style="color:#666">=</span>0x107 runnable

<span style="color:#b44">&#34;GC task thread#1 (ParallelGC)&#34;</span> <span style="color:#b8860b">os_prio</span><span style="color:#666">=</span><span style="color:#666">0</span> <span style="color:#b8860b">tid</span><span style="color:#666">=</span>0x00007f01a6459000 <span style="color:#b8860b">nid</span><span style="color:#666">=</span>0x108 runnable

<span style="color:#b44">&#34;GC task thread#2 (ParallelGC)&#34;</span> <span style="color:#b8860b">os_prio</span><span style="color:#666">=</span><span style="color:#666">0</span> <span style="color:#b8860b">tid</span><span style="color:#666">=</span>0x00007f01a6459800 <span style="color:#b8860b">nid</span><span style="color:#666">=</span>0x109 runnable

<span style="color:#b44">&#34;GC task thread#3 (ParallelGC)&#34;</span> <span style="color:#b8860b">os_prio</span><span style="color:#666">=</span><span style="color:#666">0</span> <span style="color:#b8860b">tid</span><span style="color:#666">=</span>0x00007f01a645a800 <span style="color:#b8860b">nid</span><span style="color:#666">=</span>0x10a runnable

<span style="color:#b44">&#34;VM Periodic Task Thread&#34;</span> <span style="color:#b8860b">os_prio</span><span style="color:#666">=</span><span style="color:#666">0</span> <span style="color:#b8860b">tid</span><span style="color:#666">=</span>0x00007f01a645d800 <span style="color:#b8860b">nid</span><span style="color:#666">=</span>0x113 waiting on condition

JNI global references: <span style="color:#666">1841</span>
</code></pre></div><p>â€‹</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ263ã€264ã€265ã€266 éƒ½æ˜¯ JVM çš„åƒåœ¾å›æ”¶çº¿ç¨‹ã€‚</p>
<p>ç”±æ­¤å¯ä»¥åˆ¤æ–­ï¼Œé¢‘ç¹çš„ GC å¯èƒ½æ˜¯å¯¼è‡´ CPU ä½¿ç”¨ç‡ä¸Šæ¶¨çš„é‡è¦å› ç´ ã€‚</p>
<p>äºæ˜¯æ¥ä¸‹æ¥åˆ†æ GC æ—¥å¿—ã€‚
â€‹</p>
<h3 id="åˆ†æ-gc-æ—¥å¿—">åˆ†æ GC æ—¥å¿— <a href="#%e5%88%86%e6%9e%90-gc-%e6%97%a5%e5%bf%97" class="anchor">ğŸ”—</a></h3><p>â€‹</p>
<p>ç”±äºæˆ‘ä»¬æå‰å°† GC æ—¥å¿—è¾“å‡ºåˆ°äº† <code>/opt/flink/log/gc.log</code>æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç™»å½•åˆ°æœºå™¨ä¸ŠæŸ¥çœ‹ã€‚
â€‹</p>
<p>æ•´ä¸ª GC æ—¥å¿—æ¯”è¾ƒå¤šï¼Œä¸‹é¢æ˜¯ä»ä¸­æˆªå–çš„éƒ¨åˆ†æ—¥å¿—ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">2021-07-28T18:38:29.456+0800: 9137.203: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0005972 seconds, Stopping threads took: 0.0001040 seconds
2021-07-28T18:38:29.678+0800: 9137.425: <span style="color:#666">[</span>Full GC <span style="color:#666">(</span>Ergonomics<span style="color:#666">)</span> <span style="color:#666">[</span>PSYoungGen: 937984K-&gt;678408K<span style="color:#666">(</span>1053696K<span style="color:#666">)]</span> <span style="color:#666">[</span>ParOldGen: 2342580K-&gt;2342579K<span style="color:#666">(</span>2342912K<span style="color:#666">)]</span> 3280564K-&gt;3020988K<span style="color:#666">(</span>3396608K<span style="color:#666">)</span>, <span style="color:#666">[</span>Metaspace: 77771K-&gt;77771K<span style="color:#666">(</span>1122304K<span style="color:#666">)]</span>, 2.7266583 secs<span style="color:#666">]</span> <span style="color:#666">[</span>Times: <span style="color:#b8860b">user</span><span style="color:#666">=</span>5.31 <span style="color:#b8860b">sys</span><span style="color:#666">=</span>0.00, <span style="color:#b8860b">real</span><span style="color:#666">=</span>2.72 secs<span style="color:#666">]</span> 
2021-07-28T18:38:32.405+0800: 9140.152: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 2.7275004 seconds, Stopping threads took: 0.0001259 seconds
2021-07-28T18:38:32.406+0800: 9140.153: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0006030 seconds, Stopping threads took: 0.0000960 seconds
2021-07-28T18:38:32.663+0800: 9140.410: <span style="color:#666">[</span>Full GC <span style="color:#666">(</span>Ergonomics<span style="color:#666">)</span> <span style="color:#666">[</span>PSYoungGen: 937984K-&gt;686663K<span style="color:#666">(</span>1053696K<span style="color:#666">)]</span> <span style="color:#666">[</span>ParOldGen: 2342579K-&gt;2342579K<span style="color:#666">(</span>2342912K<span style="color:#666">)]</span> 3280563K-&gt;3029243K<span style="color:#666">(</span>3396608K<span style="color:#666">)</span>, <span style="color:#666">[</span>Metaspace: 77771K-&gt;77771K<span style="color:#666">(</span>1122304K<span style="color:#666">)]</span>, 2.7246706 secs<span style="color:#666">]</span> <span style="color:#666">[</span>Times: <span style="color:#b8860b">user</span><span style="color:#666">=</span>5.32 <span style="color:#b8860b">sys</span><span style="color:#666">=</span>0.00, <span style="color:#b8860b">real</span><span style="color:#666">=</span>2.73 secs<span style="color:#666">]</span> 
2021-07-28T18:38:35.388+0800: 9143.135: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 2.7255402 seconds, Stopping threads took: 0.0001063 seconds
2021-07-28T18:38:35.389+0800: 9143.136: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0005835 seconds, Stopping threads took: 0.0000623 seconds
2021-07-28T18:38:35.635+0800: 9143.382: <span style="color:#666">[</span>Full GC <span style="color:#666">(</span>Ergonomics<span style="color:#666">)</span> <span style="color:#666">[</span>PSYoungGen: 937984K-&gt;669696K<span style="color:#666">(</span>1053696K<span style="color:#666">)]</span> <span style="color:#666">[</span>ParOldGen: 2342579K-&gt;2342570K<span style="color:#666">(</span>2342912K<span style="color:#666">)]</span> 3280563K-&gt;3012266K<span style="color:#666">(</span>3396608K<span style="color:#666">)</span>, <span style="color:#666">[</span>Metaspace: 77771K-&gt;77767K<span style="color:#666">(</span>1122304K<span style="color:#666">)]</span>, 2.7029393 secs<span style="color:#666">]</span> <span style="color:#666">[</span>Times: <span style="color:#b8860b">user</span><span style="color:#666">=</span>5.31 <span style="color:#b8860b">sys</span><span style="color:#666">=</span>0.00, <span style="color:#b8860b">real</span><span style="color:#666">=</span>2.71 secs<span style="color:#666">]</span> 
2021-07-28T18:38:38.338+0800: 9146.085: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 2.7037416 seconds, Stopping threads took: 0.0000852 seconds
2021-07-28T18:38:38.338+0800: 9146.086: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0006325 seconds, Stopping threads took: 0.0001080 seconds
2021-07-28T18:38:38.669+0800: 9146.416: <span style="color:#666">[</span>Full GC <span style="color:#666">(</span>Ergonomics<span style="color:#666">)</span> <span style="color:#666">[</span>PSYoungGen: 937984K-&gt;684469K<span style="color:#666">(</span>1053696K<span style="color:#666">)]</span> <span style="color:#666">[</span>ParOldGen: 2342570K-&gt;2342570K<span style="color:#666">(</span>2342912K<span style="color:#666">)]</span> 3280554K-&gt;3027039K<span style="color:#666">(</span>3396608K<span style="color:#666">)</span>, <span style="color:#666">[</span>Metaspace: 77767K-&gt;77767K<span style="color:#666">(</span>1122304K<span style="color:#666">)]</span>, 2.8165705 secs<span style="color:#666">]</span> <span style="color:#666">[</span>Times: <span style="color:#b8860b">user</span><span style="color:#666">=</span>5.45 <span style="color:#b8860b">sys</span><span style="color:#666">=</span>0.00, <span style="color:#b8860b">real</span><span style="color:#666">=</span>2.81 secs<span style="color:#666">]</span> 
2021-07-28T18:38:41.486+0800: 9149.233: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 2.8175380 seconds, Stopping threads took: 0.0001278 seconds
2021-07-28T18:38:41.487+0800: 9149.234: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0006169 seconds, Stopping threads took: 0.0000893 seconds
2021-07-28T18:38:41.489+0800: 9149.236: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0006118 seconds, Stopping threads took: 0.0001004 seconds
2021-07-28T18:38:41.762+0800: 9149.509: <span style="color:#666">[</span>Full GC <span style="color:#666">(</span>Ergonomics<span style="color:#666">)</span> <span style="color:#666">[</span>PSYoungGen: 937984K-&gt;671406K<span style="color:#666">(</span>1053696K<span style="color:#666">)]</span> <span style="color:#666">[</span>ParOldGen: 2342570K-&gt;2342570K<span style="color:#666">(</span>2342912K<span style="color:#666">)]</span> 3280554K-&gt;3013976K<span style="color:#666">(</span>3396608K<span style="color:#666">)</span>, <span style="color:#666">[</span>Metaspace: 77767K-&gt;77767K<span style="color:#666">(</span>1122304K<span style="color:#666">)]</span>, 2.7176013 secs<span style="color:#666">]</span> <span style="color:#666">[</span>Times: <span style="color:#b8860b">user</span><span style="color:#666">=</span>5.34 <span style="color:#b8860b">sys</span><span style="color:#666">=</span>0.00, <span style="color:#b8860b">real</span><span style="color:#666">=</span>2.72 secs<span style="color:#666">]</span> 
2021-07-28T18:38:44.480+0800: 9152.227: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 2.7184786 seconds, Stopping threads took: 0.0001121 seconds
2021-07-28T18:38:44.482+0800: 9152.229: Total <span style="color:#a2f">time</span> <span style="color:#a2f;font-weight:bold">for</span> which application threads were stopped: 0.0022003 seconds, Stopping threads took: 0.0000932 seconds
2021-07-28T18:38:44.743+0800: 9152.490: <span style="color:#666">[</span>Full GC <span style="color:#666">(</span>Ergonomics<span style="color:#666">)</span> <span style="color:#666">[</span>PSYoungGen: 937984K-&gt;677922K<span style="color:#666">(</span>1053696K<span style="color:#666">)]</span> <span style="color:#666">[</span>ParOldGen: 2342570K-&gt;2342569K<span style="color:#666">(</span>2342912K<span style="color:#666">)]</span> 3280554K-&gt;3020492K<span style="color:#666">(</span>3396608K<span style="color:#666">)</span>, <span style="color:#666">[</span>Metaspace: 77767K-&gt;77767K<span style="color:#666">(</span>1122304K<span style="color:#666">)]</span>, 2.7718527 secs<span style="color:#666">]</span> <span style="color:#666">[</span>Times: <span style="color:#b8860b">user</span><span style="color:#666">=</span>5.44 <span style="color:#b8860b">sys</span><span style="color:#666">=</span>0.00, <span style="color:#b8860b">real</span><span style="color:#666">=</span>2.77 secs<span style="color:#666">]</span> 
</code></pre></div><p>æ€ä¹ˆç†è§£ GC æ—¥å¿—å‘¢ï¼Ÿä»¥æœ€åä¸€è¡Œ GC æ—¥å¿—ä¸ºä¾‹ï¼Œæ­¤æ¬¡ Full FC åï¼š</p>
<ul>
<li>Young åŒºçš„å†…å­˜ç”± 937984K ä¸‹é™åˆ°äº† 677922Kï¼Œæ•´ä¸ª Young åŒºçš„å†…å­˜ä¸º 1053696Kï¼ŒGC å Young åŒºé‡Šæ”¾äº† 27% çš„å†…å­˜ï¼›</li>
<li>Old åŒºçš„å†…å­˜ç”± 2342570K ä¸‹é™åˆ°äº† 2342569Kï¼Œæ•´ä¸ª Old åŒºçš„å†…å­˜ä¸º 2342912Kï¼ŒGC å Old åŒºä»…é‡Šæ”¾äº†  1K å†…å­˜ï¼›</li>
<li>GC å‰æ€»å…±å †å†…å­˜ä¸º 3280554Kï¼ŒGC åå †å†…å­˜ä¸º 3020492Kï¼Œæ€»å †å†…å­˜ä¸º 3396608Kï¼›</li>
<li>æ•´ä¸ª GC è¿‡ç¨‹æŒç»­äº† 2.77 ç§’ã€‚</li>
</ul>
<blockquote>
<p>é™¤äº†ç›´æ¥æŸ¥çœ‹ GC æ—¥å¿—ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©äºä¸€äº›å¯è§†åŒ–å·¥å…·åˆ†æ GC æ—¥å¿—ï¼Œæ¯”å¦‚ <a href="https://github.com/chewiebug/GCViewer" target="_blank" rel="noopener">GCViewer</a>ã€<a href="https://gceasy.io/" target="_blank" rel="noopener">GCEasy</a> ç­‰ã€‚</p>
</blockquote>
<p>â€‹</p>
<p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶ JVM æ­£åœ¨è¿›è¡Œéå¸¸é¢‘ç¹çš„ Full GCã€‚å¹¶ä¸”æ¯æ¬¡ Full GCï¼Œé‡Šæ”¾çš„å†…å­˜ä¹Ÿéå¸¸æœ‰é™ï¼ŒOld åŒºå†…å­˜å‡ ä¹æ²¡æœ‰è¢«é‡Šæ”¾ã€‚</p>
<p>æ­¤å¤–ä»æ—¥å¿—ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ GC æ—¶åº”ç”¨éƒ½è¦æš‚åœ 2.7 ç§’ç”šè‡³æ›´ä¹…ï¼Œè¿™æ®µæ—¶é—´å†…åº”ç”¨å°±å®Œå…¨æ— æ³•å¤„ç†æ•°æ®ï¼Œå¿…ç„¶ä¼šé€ æˆæ¶ˆè´¹å»¶è¿Ÿã€‚
â€‹</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œæ‰¾åˆ°ä¸ºä»€ä¹ˆ Full GC æ— æ³•é‡Šæ”¾ Old åŒºçš„å†…å­˜ï¼Œé€šå¸¸åŸå› å¯èƒ½æ˜¯å†…å­˜æ³„æ¼ã€‚
â€‹</p>
<h3 id="åˆ†æå†…å­˜æ³„æ¼">åˆ†æå†…å­˜æ³„æ¼ <a href="#%e5%88%86%e6%9e%90%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f" class="anchor">ğŸ”—</a></h3><p>å†…å­˜å¦‚æœæ— æ³•è¢« Full GC é‡Šæ”¾ï¼Œåˆ™è¯´æ˜å¯¹è±¡å¯èƒ½è¿˜å­˜åœ¨å¼•ç”¨ã€‚æ‰€ä»¥ç«‹å³é€šè¿‡ jmap æ‰“å°äº†æ­¤åˆ»çš„å†…å­˜ heapdump æ–‡ä»¶ã€‚
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ jmap -dump:live,format<span style="color:#666">=</span>b,file<span style="color:#666">=</span>heap.hprof <span style="color:#666">1</span>
</code></pre></div><blockquote>
<p>è¿™é‡Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªå¤§å®¶ç»å¸¸é‡åˆ°çš„é—®é¢˜æ˜¯ï¼šPod ä¸Šçš„ heapdump æ–‡ä»¶å¦‚ä½•ä¸‹è½½åˆ°æœ¬åœ°åˆ†æï¼Ÿ</p>
<p>æˆ‘çš„åšæ³•æ˜¯ï¼Œåœ¨ Pod ä¸Šä¸‹è½½ä¸€ä¸ª <a href="https://help.aliyun.com/document_detail/50452.html" target="_blank" rel="noopener">ossutil</a> å·¥å…·ï¼ŒæŠŠ heapdump æ–‡ä»¶ä¸Šä¼ åˆ° OSSï¼Œå†ä¸‹è½½åˆ°æœ¬åœ°åˆ†æã€‚</p>
</blockquote>
<p>â€‹</p>
<p>æœ‰äº† heapdump æ–‡ä»¶ï¼Œå°±å¯ä»¥å°†å…¶ä¸‹è½½åˆ°æœ¬åœ°è¿›è¡Œåˆ†æäº†ã€‚
â€‹</p>
<p>å½“ç„¶ï¼Œåœ¨åˆ†æ heapdump æ–‡ä»¶å‰ï¼Œè¿˜å¯ä»¥é€šè¿‡ jmap å‘½ä»¤æŸ¥çœ‹å½“å‰å†…å­˜ä¸­çš„å¯¹è±¡ï¼š
â€‹</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ jmap -histo <span style="color:#666">1</span> | head -n <span style="color:#666">30</span>

 num     <span style="color:#080;font-style:italic">#instances         #bytes  class name</span>
----------------------------------------------
   1:      <span style="color:#666">48908481</span>     <span style="color:#666">2111717496</span>  <span style="color:#666">[</span>B
   2:       <span style="color:#666">3836887</span>      <span style="color:#666">306064392</span>  <span style="color:#666">[[</span>B
   3:       <span style="color:#666">6156306</span>      <span style="color:#666">246252240</span>  com.aliyun.openservices.log.common.FastLogContent
   4:       <span style="color:#666">3836624</span>      <span style="color:#666">122771968</span>  com.mysql.cj.protocol.a.result.ByteArrayRow
   5:        <span style="color:#666">337885</span>       <span style="color:#666">87566992</span>  <span style="color:#666">[</span>Ljava.lang.Object;
   6:       <span style="color:#666">3836624</span>       <span style="color:#666">61385984</span>  com.mysql.cj.protocol.a.MysqlTextValueDecoder
   7:        <span style="color:#666">578737</span>       <span style="color:#666">58924272</span>  <span style="color:#666">[</span>C
   8:          <span style="color:#666">7431</span>       <span style="color:#666">17495224</span>  <span style="color:#666">[</span>I
   9:        <span style="color:#666">576531</span>       <span style="color:#666">13836744</span>  java.lang.String
  10:         <span style="color:#666">88455</span>        <span style="color:#666">9906960</span>  com.aliyun.actiontrail.delivery.stream.state.TrailConfig
  11:        <span style="color:#666">327362</span>        <span style="color:#666">7856688</span>  java.util.ArrayList
  12:        <span style="color:#666">236781</span>        <span style="color:#666">7576992</span>  com.aliyun.openservices.log.common.FastLog
  13:        <span style="color:#666">114273</span>        <span style="color:#666">3656736</span>  java.util.concurrent.ConcurrentHashMap<span style="color:#b8860b">$Node</span>
  14:        <span style="color:#666">100358</span>        <span style="color:#666">2408592</span>  java.sql.Date
  15:         <span style="color:#666">94308</span>        <span style="color:#666">2263392</span>  java.lang.Long
  16:         <span style="color:#666">13444</span>        <span style="color:#666">1485096</span>  java.lang.Class
  17:         <span style="color:#666">22817</span>        <span style="color:#666">1460288</span>  java.nio.DirectByteBuffer
  18:         <span style="color:#666">22783</span>        <span style="color:#666">1275848</span>  org.apache.flink.core.memory.MemorySegment
  19:           <span style="color:#666">301</span>        <span style="color:#666">1059680</span>  <span style="color:#666">[</span>Ljava.util.concurrent.ConcurrentHashMap<span style="color:#b8860b">$Node</span>;
  20:         <span style="color:#666">22834</span>         <span style="color:#666">913360</span>  sun.misc.Cleaner
  21:         <span style="color:#666">24121</span>         <span style="color:#666">771872</span>  java.util.HashMap<span style="color:#b8860b">$Node</span>
  22:         <span style="color:#666">22809</span>         <span style="color:#666">729888</span>  java.nio.DirectByteBuffer<span style="color:#b8860b">$Deallocator</span>
  23:         <span style="color:#666">22750</span>         <span style="color:#666">728000</span>  com.mysql.cj.util.LazyString
  24:            <span style="color:#666">20</span>         <span style="color:#666">655680</span>  <span style="color:#666">[</span>Lakka.dispatch.forkjoin.ForkJoinTask;
  25:         <span style="color:#666">15912</span>         <span style="color:#666">636480</span>  java.util.TreeMap<span style="color:#b8860b">$Entry</span>
  26:          <span style="color:#666">5305</span>         <span style="color:#666">532040</span>  <span style="color:#666">[</span>Ljava.util.HashMap<span style="color:#b8860b">$Node</span>;
  27:         <span style="color:#666">23222</span>         <span style="color:#666">371552</span>  java.util.concurrent.atomic.AtomicBoolean
</code></pre></div><p>é€šè¿‡ jmap å‘ç°äº†å‡ ä¸ªæœ‰æ•°ç™¾ä¸‡å®ä¾‹çš„å¯¹è±¡ï¼š<code>FastLogContent</code>ã€<code>ByteArrayRow</code> ã€<code>MysqlTextValueDecoder</code> ä»¥åŠæ•°åä¸‡çš„ <code>TrailConfig</code> ç­‰ã€‚</p>
<p>å…¶ä¸­ <code>FastLogContent</code> æ˜¯ä»ä¸Šæ¸¸ SLS æ¶ˆè´¹åˆ°çš„åŸå§‹æ•°æ®å¯¹è±¡ï¼Œå› ä¸ºéœ€è¦å¤„ç†çš„æ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œæ‰€ä»¥å®ä¾‹æ•°ç‰¹åˆ«å¤šï¼Œæ˜¯æ­£å¸¸çš„ã€‚è€Œ <code>TrailConfig</code> æ˜¯åº”ç”¨ä¸­çš„é…ç½®ï¼Œæœ€ç»ˆä¼šé€šè¿‡ Flink çš„ boradcast å¹¿æ’­åˆ°å„ä¸ªç®—å­ï¼Œæ‰€ä»¥å®ä¾‹æ•°æ¯”è¾ƒå¤šï¼Œä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚
â€‹</p>
<p>ä½† <code>ByteArrayRow</code> å’Œ <code>MysqlTextValueDecoder</code> å°±æ¯”è¾ƒå¯ç–‘äº†ï¼Œä»ç±»åçœ‹æ˜¯ MySQL çš„æŸ¥è¯¢ç»“æœã€‚æˆ‘ä»¬çš„ Flink ä»»åŠ¡ç¡®å®ä½¿ç”¨äº† MySQLï¼Œä¸»è¦æ˜¯ä»å®šæ—¶ä» MySQL ä¸­æŸ¥è¯¢æ•°æ®ã€‚ä½†æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ•°æ®æŸ¥è¯¢åå°±ä¼šè¢«å¤„ç†ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡å®ä¾‹åº”è¯¥éå¸¸å°‘ã€‚
â€‹</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥å°±ç»§ç»­åˆ†æäº†ä¸€ä¸‹ heapdump æ–‡ä»¶ã€‚
â€‹</p>
<p>åœ¨æœ¬åœ°å¯ä»¥é€šè¿‡  <a href="https://www.eclipse.org/mat/" target="_blank" rel="noopener">Memory Analyzer (MAT)</a> æˆ– <a href="https://github.com/oracle/visualvm" target="_blank" rel="noopener">VisualVM</a> ç­‰å·¥å…·åˆ†æ heapdump æ–‡ä»¶ã€‚
â€‹</p>
<p><p class="markdown-image">
  <img src="./images/flink-memory-leak-full-gc-cpu-heapdump.png" alt="mat"  />
</p>
â€‹</p>
<p>é€šè¿‡åˆ†æå‘ç°ï¼Œ<code>MysqlTextValueDecoder</code> æ˜¯ <code>ByteArrayRow</code> çš„å¼•ç”¨ï¼Œè€Œ <code>ByteArrayRow</code> ä¸­çš„æ•°æ®å°±æ˜¯ MySQL æ•°æ®åº“çš„æŸ¥è¯¢ç»“æœã€‚
â€‹</p>
<p>æ‰€ä»¥å¯ä»¥æ¨æµ‹ï¼Œæ˜¯ä» MySQL ä¸­æŸ¥è¯¢åˆ°æ•°æ®åï¼ŒæŸäº›å¯¹è±¡æ²¡æœ‰åŠæ—¶é‡Šæ”¾å¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚
â€‹</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯å®šä½ä»£ç äº†ã€‚
â€‹</p>
<h3 id="å®šä½ä»£ç ">å®šä½ä»£ç  <a href="#%e5%ae%9a%e4%bd%8d%e4%bb%a3%e7%a0%81" class="anchor">ğŸ”—</a></h3><p>ç”±äº <code>ByteArrayRow</code> æ˜¯å­˜æ”¾æŸ¥è¯¢ç»“æœçš„ï¼Œæ‰€ä»¥é‡ç‚¹æŸ¥çœ‹å…·æœ‰ SQL æ‰§è¡Œç»“æœçš„ç›¸å…³ä»£ç ã€‚
â€‹</p>
<p>åˆšå¥½çœ‹åˆ°æœ‰ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> List<span style="color:#666">&lt;</span>AccountConfig<span style="color:#666">&gt;</span> <span style="color:#00a000">getConfigs</span><span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    PreparedStatement statement <span style="color:#666">=</span> connection
        <span style="color:#666">.</span><span style="color:#b44">prepareStatement</span><span style="color:#666">(</span><span style="color:#b44">&#34;SELECT * FROM account_config WHERE status = ?&#34;</span><span style="color:#666">);</span>
    statement<span style="color:#666">.</span><span style="color:#b44">setString</span><span style="color:#666">(</span>1<span style="color:#666">,</span> AccountConfigStatus<span style="color:#666">.</span><span style="color:#b44">Enable</span><span style="color:#666">.</span><span style="color:#b44">getStatus</span><span style="color:#666">());</span>

    ResultSet resultSet <span style="color:#666">=</span> statement<span style="color:#666">.</span><span style="color:#b44">executeQuery</span><span style="color:#666">();</span>
    List<span style="color:#666">&lt;</span>AccountConfig<span style="color:#666">&gt;</span> configs <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> ArrayList<span style="color:#666">&lt;&gt;();</span>
    
    <span style="color:#a2f;font-weight:bold">while</span> <span style="color:#666">(</span>resultSet<span style="color:#666">.</span><span style="color:#b44">next</span><span style="color:#666">())</span> <span style="color:#666">{</span>
        AccountConfig accountConfig <span style="color:#666">=</span> buildAccountConfig<span style="color:#666">(</span>resultSet<span style="color:#666">);</span>
        configs<span style="color:#666">.</span><span style="color:#b44">add</span><span style="color:#666">(</span>accountConfig<span style="color:#666">);</span>
    <span style="color:#666">}</span>
    
    <span style="color:#a2f;font-weight:bold">return</span> configs<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><p>è¿™æ®µä»£ç çš„åŠŸèƒ½å°±æ˜¯æ‰§è¡Œä¸€æ¡ SQL è¯­å¥ï¼Œå¹¶è·å–æŸ¥è¯¢ç»“æœã€‚ä½†æ‰§è¡Œå®Œæ¯•åï¼Œæ²¡æœ‰å…³é—­ ResultSet å’Œ PreparedStatementï¼Œå°±å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚
â€‹</p>
<p>æ‰€ä»¥å¯¹ä»£ç è¿›è¡Œä¿®æ”¹ï¼Œåœ¨æ‰§è¡Œå®Œ SQL è¯­å¥åï¼ŒåŠæ—¶å…³é—­ ResultSetï¼Œå°½å¿«é‡Šæ”¾å¤šä½™å†…å­˜ã€‚</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a2f;font-weight:bold">public</span> List<span style="color:#666">&lt;</span>AccountConfig<span style="color:#666">&gt;</span> <span style="color:#00a000">getConfigs</span><span style="color:#666">()</span> <span style="color:#a2f;font-weight:bold">throws</span> SQLException <span style="color:#666">{</span>
    PreparedStatement statement <span style="color:#666">=</span> connection
        <span style="color:#666">.</span><span style="color:#b44">prepareStatement</span><span style="color:#666">(</span><span style="color:#b44">&#34;SELECT * FROM account_config WHERE status = ?&#34;</span><span style="color:#666">);</span>
    statement<span style="color:#666">.</span><span style="color:#b44">setString</span><span style="color:#666">(</span>1<span style="color:#666">,</span> AccountConfigStatus<span style="color:#666">.</span><span style="color:#b44">Enable</span><span style="color:#666">.</span><span style="color:#b44">getStatus</span><span style="color:#666">());</span>

    ResultSet resultSet <span style="color:#666">=</span> statement<span style="color:#666">.</span><span style="color:#b44">executeQuery</span><span style="color:#666">();</span>
    List<span style="color:#666">&lt;</span>AccountConfig<span style="color:#666">&gt;</span> configs <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> ArrayList<span style="color:#666">&lt;&gt;();</span>
    
    <span style="color:#a2f;font-weight:bold">while</span> <span style="color:#666">(</span>resultSet<span style="color:#666">.</span><span style="color:#b44">next</span><span style="color:#666">())</span> <span style="color:#666">{</span>
        AccountConfig accountConfig <span style="color:#666">=</span> buildAccountConfig<span style="color:#666">(</span>resultSet<span style="color:#666">);</span>
        configs<span style="color:#666">.</span><span style="color:#b44">add</span><span style="color:#666">(</span>accountConfig<span style="color:#666">);</span>
    <span style="color:#666">}</span>
    
    resultSet<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
    statement<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">();</span>
    <span style="color:#a2f;font-weight:bold">return</span> configs<span style="color:#666">;</span>
<span style="color:#666">}</span>
</code></pre></div><p>â€‹</p>
<p>ä¿®æ”¹å®Œæ¯•åå†éƒ¨ç½²ä»£ç ï¼Œå°±å†ä¹Ÿæ²¡æœ‰å‡ºç°è¿‡ CPU æŒç»­ 100% çš„æƒ…å†µäº†ã€‚
â€‹</p>
<p><p class="markdown-image">
  <img src="./images/flink-memory-leak-full-gc-cpu-normal.png" alt="æ­£å¸¸"  />
</p></p>
<h2 id="æ€»ç»“">æ€»ç»“ <a href="#%e6%80%bb%e7%bb%93" class="anchor">ğŸ”—</a></h2><p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ªæ’æŸ¥è¿‡ç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆåˆ†æ CPU å¼‚å¸¸çš„å½±å“ï¼Œ æ¯”å¦‚å»¶è¿Ÿã€æ•°æ®é‡å¤ã€æ•°æ®ä¸¢å¤±ã€‚åŸºäº Flink çš„ checkpoint æœºåˆ¶ï¼Œåˆ¤æ–­å…¶å½±å“æ˜¯æ•°æ®æ¶ˆè´¹å»¶è¿Ÿï¼Œä¼šæœ‰æ•°æ®é‡å¤ã€ä¸ä¼šæœ‰æ•°æ®ä¸¢å¤±ï¼›</li>
<li>ç„¶ååˆ†æè¿›ç¨‹ã€çº¿ç¨‹çš„ CPU ä½¿ç”¨æƒ…å†µ GC æ—¥å¿—ï¼Œç¡®å®šæ˜¯ Full GC å¯¼è‡´çš„ CPU ä½¿ç”¨ç‡æš´å¢è‡³ 100%ï¼›</li>
<li>æœ€ååˆ†æå†…å­˜ heapdump æ–‡ä»¶ï¼Œç¡®å®šå†…å­˜æ³„æ¼å¯¼è‡´ Full GC å¹¶æœ€ç»ˆå®šä½ä»£ç ã€‚</li>
</ul>

    </div>

    
        <div class="tags">
            
                <a href="https://nodejh.com/tags/java">Java</a>
            
                <a href="https://nodejh.com/tags/flink">Flink</a>
            
        </div>
    
    
    
  <div id="comment">
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nodejh" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>


</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/nodejh" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://stackoverflow.com/users/4518882/nodejh" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>stackoverflow</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-488.000000, -1163.000000)">
            <g id="stackoverflow" transform="translate(488.000000, 1163.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M42.0860128,53.5922927 L22.9745951,53.6011499 L22.9729497,49.5538824 L42.0835447,49.5440929 L42.0860128,53.5922927 L42.0860128,53.5922927 Z M55,30.6708298 L51.7306912,12 L47.7087256,12.6920259 L50.9775643,31.3628557 L55,30.6708298 L55,30.6708298 Z M42.5455518,44.3547147 L23.5156994,42.616026 L23.1410164,46.6470941 L42.1712214,48.3841513 L42.5455518,44.3547147 L42.5455518,44.3547147 Z M43.8009984,39.0731519 L25.3459811,34.1539179 L24.285633,38.0621508 L42.7419431,42.9819676 L43.8009984,39.0731519 L43.8009984,39.0731519 Z M46.2103463,34.4436411 L29.7494464,24.8164635 L27.6748215,28.3015328 L44.1365441,37.9292931 L46.2103463,34.4436411 L46.2103463,34.4436411 Z M50.2466504,31.6088756 L46.8745036,33.8883189 L36.106599,18.2318456 L39.4792159,15.9517031 L50.2466504,31.6088756 Z M45.3315807,40.2784283 L48.5799693,40.2784283 L48.5799693,60 L17,60 L17,40.2784283 L20.2648427,40.2784283 L20.2648427,56.8243495 L45.3315807,56.8243495 L45.3315807,40.2784283 Z" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://twitter.com/nodejh" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.536px" height="438.536px" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536;"
	 xml:space="preserve">
<g>
	<path d="M414.41,24.123C398.333,8.042,378.963,0,356.315,0H82.228C59.58,0,40.21,8.042,24.126,24.123
		C8.045,40.207,0.003,59.576,0.003,82.225v274.084c0,22.647,8.042,42.018,24.123,58.102c16.084,16.084,35.454,24.126,58.102,24.126
		h274.084c22.648,0,42.018-8.042,58.095-24.126c16.084-16.084,24.126-35.454,24.126-58.102V82.225
		C438.532,59.576,430.49,40.204,414.41,24.123z M335.471,168.735c0.191,1.713,0.288,4.278,0.288,7.71
		c0,15.989-2.334,32.025-6.995,48.104c-4.661,16.087-11.8,31.504-21.416,46.254c-9.606,14.749-21.074,27.791-34.396,39.115
		c-13.325,11.32-29.311,20.365-47.968,27.117c-18.648,6.762-38.637,10.143-59.953,10.143c-33.116,0-63.76-8.952-91.931-26.836
		c4.568,0.568,9.329,0.855,14.275,0.855c27.6,0,52.439-8.565,74.519-25.7c-12.941-0.185-24.506-4.179-34.688-11.991
		c-10.185-7.803-17.273-17.699-21.271-29.691c4.947,0.76,8.658,1.137,11.132,1.137c4.187,0,9.042-0.76,14.56-2.279
		c-13.894-2.669-25.598-9.562-35.115-20.697c-9.519-11.136-14.277-23.84-14.277-38.114v-0.571
		c10.085,4.755,19.602,7.229,28.549,7.422c-17.321-11.613-25.981-28.265-25.981-49.963c0-10.66,2.758-20.747,8.278-30.264
		c15.035,18.464,33.311,33.213,54.816,44.252c21.507,11.038,44.54,17.227,69.092,18.558c-0.95-3.616-1.427-8.186-1.427-13.704
		c0-16.562,5.853-30.692,17.56-42.399c11.703-11.706,25.837-17.561,42.394-17.561c17.515,0,32.079,6.283,43.688,18.846
		c13.134-2.474,25.892-7.33,38.26-14.56c-4.757,14.652-13.613,25.788-26.55,33.402c12.368-1.716,23.88-4.95,34.537-9.708
		C357.458,149.793,347.462,160.166,335.471,168.735z"/>
</g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       Â© Copyright 
       2021 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Hang Jiang
    
    </div>

    
      <div class="powerby">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
      </div>
    
</footer>



  </body>
</html>
